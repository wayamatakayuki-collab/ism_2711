<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å¤·éš…æ•™è‚²ä¼šé¤¨ ç®¡ç†ï¼ˆéƒ¨å±‹äºˆç´„ãƒ»æ©Ÿæãƒ»å‹•é™ï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (CDN / compat) -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }

    /* ===== å°åˆ·ï¼ˆA4æ¨ªï¼‰ ===== */
    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .print-area { display: block !important; }
      .print-card { break-inside: avoid; page-break-inside: avoid; }
      .print-tight { font-size: 11px; }
      .print-table td, .print-table th { padding: 6px !important; }
    }
    .print-only { display: none; }
    .print-area { display: none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="app"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /**********************
     * å›ºå®šè¨­å®šï¼ˆå…±é€šIDæ–¹å¼ï¼‰
     **********************/
    const SHARED_LOGIN_CODE = "ismkaikan";
    const SHARED_EMAIL = `${SHARED_LOGIN_CODE}@shared.local`; // Firebase Authã¯ãƒ¡ãƒ¼ãƒ«å½¢å¼ãŒå¿…è¦
    const CACHE_PREFIX = "ismkaikan_cache_v2";
    const OPS_KEY = "ismkaikan_ops_v1"; // read/writeæ¦‚ç®—ï¼ˆæœˆå˜ä½ã§ä¿å­˜ï¼‰

    /**********************
 * Firebase åˆæœŸåŒ–
 **********************/
// â–¼â–¼â–¼ å¿…ãšå·®ã—æ›¿ãˆï¼ˆFirebase Consoleã®Webã‚¢ãƒ—ãƒªè¨­å®šï¼‰ â–¼â–¼â–¼
const firebaseConfig = {
  apiKey: "AIzaSyAfO6ZAOlAZg-yG8ja3fR3U-zEnqMwmpw8",
  authDomain: "ism2711-49523.firebaseapp.com",
  projectId: "ism2711-49523",
  storageBucket: "ism2711-49523.firebasestorage.app",
  messagingSenderId: "44334771941",
  appId: "1:44334771941:web:a55badc93b3f6bdf59ee0c",
  measurementId: "G-M4SWCYYH82"
};
// â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

// compatï¼ˆwindow.firebaseï¼‰ã§åˆæœŸåŒ–
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    /**********************
     * ãƒã‚¹ã‚¿ï¼ˆéƒ¨å±‹ï¼‰
     **********************/
    const ROOMS = [
      { id: "honkan_oo", name: "å¤§ä¼šè­°å®¤", building: "æœ¬é¤¨" },
      { id: "honkan_chu", name: "ä¸­ä¼šè­°å®¤", building: "æœ¬é¤¨" },
      { id: "honkan_sho", name: "å°ä¼šè­°å®¤", building: "æœ¬é¤¨" },
      { id: "honkan_ousetsu", name: "å¿œæ¥å®¤", building: "æœ¬é¤¨" },
      { id: "honkan_nihon", name: "æ—¥æœ¬é–“", building: "æœ¬é¤¨" },
      { id: "honkan_print", name: "å°åˆ·å®¤", building: "æœ¬é¤¨" },
      { id: "honkan_library", name: "å›³æ›¸å®¤", building: "æœ¬é¤¨" },
      { id: "honkan_lab", name: "ç ”ç©¶æ‰€", building: "æœ¬é¤¨" },
      { id: "bekkan_1f", name: "ï¼‘éšä¼šè­°å®¤", building: "åˆ¥é¤¨" },
      { id: "bekkan_2f", name: "ï¼’éšä¼šè­°å®¤", building: "åˆ¥é¤¨" },
    ];

    const DEFAULT_EQUIPMENTS = [
      { id: "projector", name: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼", countTotal: 3, active: true },
      { id: "pc", name: "PC", countTotal: 10, active: true },
    ];

    /**********************
     * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
     **********************/
    function pad2(n){ return String(n).padStart(2,"0"); }

    function todayKeyLocal(d = new Date()){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      return `${y}-${m}-${day}`;
    }

    function monthKeyLocal(d = new Date()){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      return `${y}-${m}`;
    }

    function parseKeyToDate(key){
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    function addDaysKey(key, addDays){
      const dt = parseKeyToDate(key);
      dt.setDate(dt.getDate() + addDays);
      return todayKeyLocal(dt);
    }

    function startOfWeekMonday(key){
      const dt = parseKeyToDate(key);
      // JS: 0=Sun ... 6=Sat
      const dow = dt.getDay();
      const diff = (dow === 0) ? -6 : (1 - dow); // Monday start
      dt.setDate(dt.getDate() + diff);
      return todayKeyLocal(dt);
    }

    function minToHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return `${pad2(h)}:${pad2(m)}`;
    }

    function hhmmToMin(hhmm){
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    }

    function timeOptions10min(){
      const opts = [];
      for(let m=0; m<=23*60+50; m+=10){
        opts.push({ label: minToHHMM(m), value: m });
      }
      return opts;
    }

    function classNames(...xs){ return xs.filter(Boolean).join(" "); }

    function saveCache(key, value){
      try{ localStorage.setItem(key, JSON.stringify({ at: Date.now(), value })); }catch(e){}
    }
    function loadCache(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed?.value ?? null;
      }catch(e){ return null; }
    }

    function overlaps(aStart, aEnd, bStart, bEnd){
      return (aStart < bEnd) && (bStart < aEnd);
    }

    function clampInt(n, min, max){
      const v = Number(n);
      if(Number.isNaN(v)) return min;
      return Math.max(min, Math.min(max, Math.trunc(v)));
    }

    function isValidDateKey(key){
      return /^\d{4}-\d{2}-\d{2}$/.test(key);
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // RFC4180ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
    function parseCSV(text){
      const rows = [];
      let i = 0;
      let field = "";
      let row = [];
      let inQuotes = false;

      while(i < text.length){
        const c = text[i];

        if(inQuotes){
          if(c === '"'){
            if(text[i+1] === '"'){ // escaped quote
              field += '"';
              i += 2;
              continue;
            }else{
              inQuotes = false;
              i++;
              continue;
            }
          }else{
            field += c;
            i++;
            continue;
          }
        }else{
          if(c === '"'){
            inQuotes = true;
            i++;
            continue;
          }
          if(c === ","){
            row.push(field);
            field = "";
            i++;
            continue;
          }
          if(c === "\r"){
            i++;
            continue;
          }
          if(c === "\n"){
            row.push(field);
            rows.push(row);
            row = [];
            field = "";
            i++;
            continue;
          }
          field += c;
          i++;
        }
      }
      // last
      row.push(field);
      // ç©ºè¡Œï¼ˆæœ«å°¾ã®æ”¹è¡Œã ã‘ï¼‰ã‚’é™¤å¤–
      const allEmpty = row.every(x => (x ?? "").trim() === "");
      if(!allEmpty) rows.push(row);

      return rows;
    }

    function toCSVRow(fields){
      return fields.map(v => {
        const s = (v ?? "").toString();
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(",");
    }

    function roomName(roomId){
      return ROOMS.find(r=>r.id===roomId)?.name ?? roomId;
    }
    function roomBuilding(roomId){
      return ROOMS.find(r=>r.id===roomId)?.building ?? "";
    }

    /**********************
     * UIéƒ¨å“
     **********************/
    const Pill = ({children, tone="slate"}) => {
      const map = {
        slate: "bg-slate-100 text-slate-700 border-slate-200",
        sky: "bg-sky-50 text-sky-700 border-sky-200",
        emerald: "bg-emerald-50 text-emerald-700 border-emerald-200",
        rose: "bg-rose-50 text-rose-700 border-rose-200",
        amber: "bg-amber-50 text-amber-700 border-amber-200",
      };
      return (
        <span className={classNames("inline-flex items-center gap-1 px-2 py-1 rounded-xl text-[12px] font-bold border", map[tone] || map.slate)}>
          {children}
        </span>
      );
    };

    const Card = ({children, printCard=false}) => (
      <div className={classNames("bg-white rounded-3xl p-4 shadow-sm border border-slate-100", printCard ? "print-card" : "")}>
        {children}
      </div>
    );

    const SectionTitle = ({icon, title, sub, right}) => (
      <div className="flex items-end justify-between gap-2 flex-wrap">
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-600 font-black">
              {icon}
            </div>
            <div className="text-lg font-black text-slate-800">{title}</div>
          </div>
          {sub ? <div className="text-xs font-bold text-slate-400">{sub}</div> : null}
        </div>
        {right ? <div className="flex items-center gap-2">{right}</div> : null}
      </div>
    );

    const Modal = ({open, onClose, title, children}) => {
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 no-print">
          <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
          <div className="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-3">
            <div className="w-full md:max-w-2xl bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
              <div className="p-4 border-b border-slate-100 flex items-center justify-between">
                <div className="font-black text-slate-800">{title}</div>
                <button className="px-3 py-2 rounded-2xl bg-slate-100 font-black text-slate-700" onClick={onClose}>é–‰ã˜ã‚‹</button>
              </div>
              <div className="p-4 space-y-4">
                {children}
              </div>
            </div>
          </div>
        </div>
      );
    };

    function TabButton({active, onClick, children}){
      return (
        <button
          onClick={onClick}
          className={classNames(
            "rounded-2xl py-3 font-black border shadow-sm",
            active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200"
          )}
        >
          {children}
        </button>
      );
    }

    /**********************
     * read/writeæ¦‚ç®—ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆæœˆå˜ä½ï¼‰
     **********************/
    function loadOps(){
      const mk = monthKeyLocal();
      try{
        const raw = localStorage.getItem(OPS_KEY);
        if(!raw) return { month: mk, reads: 0, writes: 0 };
        const obj = JSON.parse(raw);
        if(obj?.month !== mk){
          return { month: mk, reads: 0, writes: 0 };
        }
        return {
          month: mk,
          reads: Number(obj.reads || 0),
          writes: Number(obj.writes || 0),
        };
      }catch(e){
        return { month: mk, reads: 0, writes: 0 };
      }
    }
    function saveOps(ops){
      try{ localStorage.setItem(OPS_KEY, JSON.stringify(ops)); }catch(e){}
    }

    /**********************
     * ãƒ¡ã‚¤ãƒ³
     **********************/
    function App(){
      const [user, setUser] = useState(null);
      const [authReady, setAuthReady] = useState(false);

      const [tab, setTab] = useState("home"); // home | reserve | equip | presence
      const [selectedDate, setSelectedDate] = useState(todayKeyLocal());

      const [busy, setBusy] = useState(false);
      const [toast, setToast] = useState(null);

      const [reservations, setReservations] = useState([]);     // é¸æŠæ—¥
      const [weekReservations, setWeekReservations] = useState([]); // é€±è¡¨ç¤ºç”¨ï¼ˆé€±ç¯„å›²ï¼‰
      const [presence, setPresence] = useState(null);
      const [equipments, setEquipments] = useState(DEFAULT_EQUIPMENTS);

      const [editorOpen, setEditorOpen] = useState(false);
      const [editTarget, setEditTarget] = useState(null);

      const [reserveView, setReserveView] = useState("day"); // day | week
      const [csvOpen, setCsvOpen] = useState(false);

      const [ops, setOps] = useState(loadOps()); // read/writeæ¦‚ç®—

      const isLoggedIn = !!user;
      const opts10 = useMemo(() => timeOptions10min(), []);

      const weekStart = useMemo(() => startOfWeekMonday(selectedDate), [selectedDate]);
      const weekKeys = useMemo(() => Array.from({length:7}, (_,i)=>addDaysKey(weekStart, i)), [weekStart]);
      const weekEnd = weekKeys[6];

      // equipments map
      const equipmentsMap = useMemo(() => {
        const m = {};
        for(const e of equipments || []) m[e.id] = e;
        return m;
      }, [equipments]);

      // Authç›£è¦–
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          setUser(u || null);
          setAuthReady(true);
        });
        return () => unsub && unsub();
      }, []);

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ï¼ˆé¸æŠæ—¥ï¼‰
      useEffect(() => {
        const rKey = `${CACHE_PREFIX}:reservations:${selectedDate}`;
        const pKey = `${CACHE_PREFIX}:presence:${selectedDate}`;
        const eKey = `${CACHE_PREFIX}:equipments`;
        const wKey = `${CACHE_PREFIX}:weekReservations:${weekStart}`;

        const cr = loadCache(rKey);
        const cp = loadCache(pKey);
        const ce = loadCache(eKey);
        const cw = loadCache(wKey);

        if(cr) setReservations(cr);
        if(cp) setPresence(cp);
        if(ce) setEquipments(ce);
        if(cw) setWeekReservations(cw);
      }, [selectedDate, weekStart]);

      // opsæ°¸ç¶šåŒ–
      useEffect(() => { saveOps(ops); }, [ops]);

      function bumpReads(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, reads: base.reads + Number(n||0) };
        });
      }
      function bumpWrites(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, writes: base.writes + Number(n||0) };
        });
      }
      function resetOps(){
        const mk = monthKeyLocal();
        if(!confirm(`${mk} ã® read/writeï¼ˆæ¦‚ç®—ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;
        setOps({ month: mk, reads: 0, writes: 0 });
      }

      // Firestoreèª­è¾¼ï¼ˆæ‰‹å‹•æ›´æ–°ï¼‰
      async function refreshAll(){
        setBusy(true);
        try{
          // é¸æŠæ—¥ã®äºˆç´„
          const rsSnap = await db.collection("reservations")
            .where("date","==",selectedDate)
            .get();
          bumpReads(rsSnap.size); // docæ•°ã¶ã‚“

          const rs = rsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b) => (a.roomId||"").localeCompare(b.roomId||"") || (a.startMin||0)-(b.startMin||0));
          setReservations(rs);
          saveCache(`${CACHE_PREFIX}:reservations:${selectedDate}`, rs);

          // presenceï¼ˆé¸æŠæ—¥ï¼‰: 1 readï¼ˆå­˜åœ¨ã—ãªãã¦ã‚‚getã¯èª­ã¿ç›¸å½“ã¨ã—ã¦æ‰±ã†ï¼‰
          const pDoc = await db.collection("presence").doc(selectedDate).get();
          bumpReads(1);

          const pv = pDoc.exists ? pDoc.data() : null;
          setPresence(pv);
          saveCache(`${CACHE_PREFIX}:presence:${selectedDate}`, pv);

          // equipmentsï¼ˆå…¨ä½“ï¼‰
          const eSnap = await db.collection("equipments").get();
          bumpReads(eSnap.size);

          const ev = eSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          if(ev.length){
            setEquipments(ev);
            saveCache(`${CACHE_PREFIX}:equipments`, ev);
          }else{
            setEquipments(DEFAULT_EQUIPMENTS);
          }

          // é€±è¡¨ç¤ºç”¨ï¼ˆreserveViewãŒweekãªã‚‰é€±ç¯„å›²ã‚‚æ›´æ–°ï¼‰
          if(reserveView === "week"){
            await refreshWeek();
          }

          setToast({ type:"ok", msg:"æ›´æ–°ã—ã¾ã—ãŸ" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFirestoreè¨­å®š/ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªï¼‰" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2400);
        }
      }

      async function refreshWeek(){
        // weekStartã€œweekEnd ã®äºˆç´„ã‚’ã¾ã¨ã‚ã¦å–å¾—ï¼ˆdateã«ç¯„å›²ã‚¯ã‚¨ãƒªï¼‰
        const wSnap = await db.collection("reservations")
          .where("date", ">=", weekStart)
          .where("date", "<=", weekEnd)
          .get();
        bumpReads(wSnap.size);

        const wr = wSnap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a,b) =>
            (a.date||"").localeCompare(b.date||"")
            || (a.roomId||"").localeCompare(b.roomId||"")
            || (a.startMin||0)-(b.startMin||0)
          );
        setWeekReservations(wr);
        saveCache(`${CACHE_PREFIX}:weekReservations:${weekStart}`, wr);
      }

      // å…±é€šIDãƒ­ã‚°ã‚¤ãƒ³
      async function loginWithShared(password){
        setBusy(true);
        try{
          await auth.signInWithEmailAndPassword(SHARED_EMAIL, password);
          // authãƒ­ã‚°ã‚¤ãƒ³è‡ªä½“ã¯read/writeã«å«ã‚ãªã„ï¼ˆSchool Calã®è€ƒãˆæ–¹ã«åˆã‚ã›ã¦ã€ŒFirestoreã®æ¦‚ç®—ã€æ‰±ã„ï¼‰
          setToast({ type:"ok", msg:"ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆç·¨é›†ã§ãã¾ã™ï¼‰" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆPWãŒé•ã†/ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªä½œæˆï¼‰" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2600);
        }
      }

      async function logout(){
        await auth.signOut();
        setToast({ type:"ok", msg:"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ" });
        setTimeout(()=>setToast(null), 2000);
      }

      function openNew(){
        setEditTarget({
          id: null,
          date: selectedDate,
          roomId: ROOMS[0].id,
          startMin: hhmmToMin("09:00"),
          endMin: hhmmToMin("10:00"),
          groupName: "",
          note: "",
          equipment: { projector: 0, pc: 0 },
        });
        setEditorOpen(true);
      }

      function openEdit(r){
        setEditTarget({
          id: r.id,
          date: r.date,
          roomId: r.roomId,
          startMin: r.startMin ?? 0,
          endMin: r.endMin ?? 0,
          groupName: r.groupName ?? "",
          note: r.note ?? "",
          equipment: {
            projector: Number(r?.equipment?.projector ?? 0),
            pc: Number(r?.equipment?.pc ?? 0),
          },
        });
        setEditorOpen(true);
      }

      function getReservationsForDate(dateKey){
        if(dateKey === selectedDate) return reservations;
        // é€±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã“ã‹ã‚‰
        return (weekReservations || []).filter(x => x.date === dateKey);
      }

      async function saveReservation(model){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"ç·¨é›†ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const g = (model.groupName||"").trim();
        if(!g){
          setToast({ type:"ng", msg:"å›£ä½“åã¯å¿…é ˆã§ã™" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const sMin = Number(model.startMin);
        const eMin = Number(model.endMin);
        if(!(eMin > sMin)){
          setToast({ type:"ng", msg:"çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        if((sMin % 10 !== 0) || (eMin % 10 !== 0)){
          setToast({ type:"ng", msg:"æ™‚åˆ»ã¯10åˆ†å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }

        // åŒæ—¥ã®äºˆç´„ï¼ˆçŠ¶æ…‹ã‹ã‚‰ï¼‰
        const sameDate = getReservationsForDate(model.date);
        // 1) éƒ¨å±‹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
        const sameRoom = sameDate.filter(x => x.roomId===model.roomId && x.id !== model.id);
        const conflict = sameRoom.some(x => overlaps(sMin, eMin, x.startMin||0, x.endMin||0));
        if(conflict){
          setToast({ type:"ng", msg:"åŒã˜éƒ¨å±‹ã§æ™‚é–“ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ï¼ˆäºˆç´„ä¸å¯ï¼‰" });
          setTimeout(()=>setToast(null), 2600);
          return;
        }

        // 2) æ©Ÿæã®åŒæ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯ï¼ˆåŒæ—¥ãƒ»å…¨å®¤ãŒå¯¾è±¡ï¼‰
        const overlapsAny = sameDate
          .filter(x => x.id !== model.id)
          .filter(x => overlaps(sMin, eMin, x.startMin||0, x.endMin||0));

        const need = {
          projector: Number(model?.equipment?.projector ?? 0),
          pc: Number(model?.equipment?.pc ?? 0),
        };

        const used = { projector: 0, pc: 0 };
        for(const r of overlapsAny){
          used.projector += Number(r?.equipment?.projector ?? 0);
          used.pc += Number(r?.equipment?.pc ?? 0);
        }
        const totals = {
          projector: Number(equipmentsMap.projector?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="projector")?.countTotal ?? 0),
          pc: Number(equipmentsMap.pc?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="pc")?.countTotal ?? 0),
        };

        const after = {
          projector: used.projector + need.projector,
          pc: used.pc + need.pc,
        };

        const warnings = [];
        if(totals.projector > 0 && after.projector > totals.projector){
          warnings.push(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ãŒç·æ•° ${totals.projector} ã‚’è¶…ãˆã¾ã™ï¼ˆåŒæ™‚é–“å¸¯ åˆè¨ˆ ${after.projector}ï¼‰`);
        }
        if(totals.pc > 0 && after.pc > totals.pc){
          warnings.push(`PCãŒç·æ•° ${totals.pc} ã‚’è¶…ãˆã¾ã™ï¼ˆåŒæ™‚é–“å¸¯ åˆè¨ˆ ${after.pc}ï¼‰`);
        }

        if(warnings.length){
          const ok = confirm(
            `ã€æ©Ÿæã®è­¦å‘Šã€‘\n${warnings.join("\n")}\n\nãã‚Œã§ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`
          );
          if(!ok) return;
        }

        setBusy(true);
        try{
          const payload = {
            date: model.date,
            roomId: model.roomId,
            startMin: sMin,
            endMin: eMin,
            groupName: g,
            note: (model.note||"").trim(),
            equipment: {
              projector: Number(model?.equipment?.projector ?? 0),
              pc: Number(model?.equipment?.pc ?? 0),
            },
            updatedAt: serverTimestamp(),
          };

          if(model.id){
            await db.collection("reservations").doc(model.id).set(payload, { merge:true });
            bumpWrites(1);
          }else{
            await db.collection("reservations").add({ ...payload, createdAt: serverTimestamp() });
            bumpWrites(1);
          }

          setEditorOpen(false);
          setEditTarget(null);

          // ä¿å­˜å¾Œï¼šé¸æŠæ—¥/é€±ã®è¡¨ç¤ºã‚’å´©ã•ãªã„ã‚ˆã†æ›´æ–°
          await refreshAll();
          if(reserveView === "week"){
            await refreshWeek();
          }
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      async function deleteReservation(id){
        if(!isLoggedIn) return;
        if(!confirm("ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        setBusy(true);
        try{
          await db.collection("reservations").doc(id).delete();
          bumpWrites(1);
          await refreshAll();
          if(reserveView === "week"){
            await refreshWeek();
          }
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // presenceæ›´æ–°ï¼ˆ1 writeç›¸å½“ï¼‰
      async function setPresenceValue(personKey, slotKey, value){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"ç·¨é›†ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        setBusy(true);
        try{
          const base = presence || {};
          const next = {
            ...base,
            [personKey]: {
              ...(base[personKey] || {}),
              [slotKey]: value,
            }
          };
          await db.collection("presence").doc(selectedDate).set(next, { merge:true });
          bumpWrites(1);

          setPresence(next);
          saveCache(`${CACHE_PREFIX}:presence:${selectedDate}`, next);

          setToast({ type:"ok", msg:"å‹•é™ã‚’ä¿å­˜ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 1600);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"å‹•é™ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // equipments åˆæœŸãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆbatchï¼šä»¶æ•°åˆ† writeï¼‰
      async function seedEquipments(){
        if(!isLoggedIn) return;
        if(!confirm("æ©Ÿæãƒã‚¹ã‚¿ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢ã«ã‚ã‚‹ã‚‚ã®ã¯ä¸Šæ›¸ãã—ã¾ã›ã‚“")) return;
        setBusy(true);
        try{
          const batch = db.batch();
          let willWrite = 0;
          for(const e of DEFAULT_EQUIPMENTS){
            const ref = db.collection("equipments").doc(e.id);
            const snap = await ref.get();
            bumpReads(1);
            if(!snap.exists){
              batch.set(ref, { name:e.name, countTotal:e.countTotal, active:e.active, updatedAt: serverTimestamp() });
              willWrite++;
            }
          }
          await batch.commit();
          bumpWrites(willWrite);

          await refreshAll();
          setToast({ type:"ok", msg:"æ©Ÿæãƒã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2200);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // æ—¥ã®è¡¨ç¤ºç”¨ï¼šæ©Ÿæä½¿ç”¨ï¼ˆåˆè¨ˆï¼‰
      const equipmentUsed = useMemo(() => {
        const used = { projector: 0, pc: 0 };
        for(const r of reservations){
          used.projector += Number(r?.equipment?.projector ?? 0);
          used.pc += Number(r?.equipment?.pc ?? 0);
        }
        return used;
      }, [reservations]);

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼šéƒ¨å±‹ã”ã¨ï¼ˆé¸æŠæ—¥ï¼‰
      const byRoom = useMemo(() => {
        const map = {};
        for(const rr of ROOMS) map[rr.id] = [];
        for(const r of reservations){
          if(!map[r.roomId]) map[r.roomId] = [];
          map[r.roomId].push(r);
        }
        for(const k of Object.keys(map)){
          map[k].sort((a,b)=>(a.startMin||0)-(b.startMin||0));
        }
        return map;
      }, [reservations]);

      // é€±è¡¨ç¤ºç”¨ï¼š date -> roomId -> list
      const weekMap = useMemo(() => {
        const map = {};
        for(const d of weekKeys){
          map[d] = {};
          for(const rr of ROOMS) map[d][rr.id] = [];
        }
        for(const r of weekReservations || []){
          if(!map[r.date]) map[r.date] = {};
          if(!map[r.date][r.roomId]) map[r.date][r.roomId] = [];
          map[r.date][r.roomId].push(r);
        }
        for(const d of Object.keys(map)){
          for(const rid of Object.keys(map[d])){
            map[d][rid].sort((a,b)=>(a.startMin||0)-(b.startMin||0));
          }
        }
        return map;
      }, [weekReservations, weekKeys]);

      // å°åˆ·ï¼šreserveViewã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹printAreaã‚’åˆ‡æ›¿
      function doPrint(){
        // å°åˆ·å‰ã«æœ€ä½é™ã®æ•´åˆï¼šé€±è¡¨ç¤ºãªã‚‰é€±ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ãŠãï¼ˆä»»æ„ï¼‰
        window.print();
      }

      // CSVï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç¯„å›²ï¼‰
      async function exportCSV(rangeStart, rangeEnd){
        if(!isValidDateKey(rangeStart) || !isValidDateKey(rangeEnd)){
          alert("æ—¥ä»˜ç¯„å›²ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
          return;
        }
        if(rangeEnd < rangeStart){
          alert("çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã«ã—ã¦ãã ã•ã„");
          return;
        }
        setBusy(true);
        try{
          const snap = await db.collection("reservations")
            .where("date", ">=", rangeStart)
            .where("date", "<=", rangeEnd)
            .get();
          bumpReads(snap.size);

          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.roomId||"").localeCompare(b.roomId||"") || (a.startMin||0)-(b.startMin||0));

          const header = [
            "id",
            "date",
            "building",
            "roomId",
            "roomName",
            "start",
            "end",
            "groupName",
            "projector",
            "pc",
            "note"
          ];
          const lines = [toCSVRow(header)];
          for(const r of list){
            lines.push(toCSVRow([
              r.id,
              r.date,
              roomBuilding(r.roomId),
              r.roomId,
              roomName(r.roomId),
              minToHHMM(r.startMin||0),
              minToHHMM(r.endMin||0),
              r.groupName || "",
              Number(r?.equipment?.projector ?? 0),
              Number(r?.equipment?.pc ?? 0),
              r.note || ""
            ]));
          }
          const csv = lines.join("\n");
          const filename = `ismkaikan_reservations_${rangeStart}_to_${rangeEnd}.csv`;
          downloadText(filename, csv);

          setToast({ type:"ok", msg:"CSVã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2000);
        }catch(err){
          console.error(err);
          alert("CSVæ›¸ãå‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }finally{
          setBusy(false);
        }
      }

      // CSVï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¿½åŠ æ–¹å¼ï¼šé‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ— or æŒ‡å®šIDãŒã‚ã‚Œã°æ›´æ–°ï¼‰
      async function importCSV(file){
        if(!isLoggedIn){
          alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡Œã£ã¦ãã ã•ã„");
          return;
        }
        const text = await file.text();
        const rows = parseCSV(text);
        if(rows.length < 2){
          alert("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        const header = rows[0].map(x => (x||"").trim());
        const idx = (name) => header.findIndex(h => h === name);

        const i_id = idx("id");
        const i_date = idx("date");
        const i_roomId = idx("roomId");
        const i_roomName = idx("roomName");
        const i_building = idx("building");
        const i_start = idx("start");
        const i_end = idx("end");
        const i_group = idx("groupName");
        const i_pj = idx("projector");
        const i_pc = idx("pc");
        const i_note = idx("note");

        // å¿…é ˆæœ€ä½é™
        if(i_date < 0 || (i_roomId < 0 && i_roomName < 0) || i_start < 0 || i_end < 0 || i_group < 0){
          alert("CSVã®ãƒ˜ãƒƒãƒ€ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nå¿…é ˆ: date, roomId(ã¾ãŸã¯roomName), start, end, groupName");
          return;
        }

        // row -> model
        const parsed = [];
        const errors = [];

        for(let r=1; r<rows.length; r++){
          const row = rows[r];
          const get = (i) => (i>=0 ? (row[i] ?? "").trim() : "");

          const date = get(i_date);
          const startStr = get(i_start);
          const endStr = get(i_end);
          const groupName = get(i_group);

          let roomId = get(i_roomId);
          const roomNameVal = get(i_roomName);
          const buildingVal = get(i_building);

          if(!isValidDateKey(date)){
            errors.push(`è¡Œ${r+1}: dateãŒä¸æ­£ (${date})`);
            continue;
          }
          if(!/^\d{2}:\d{2}$/.test(startStr) || !/^\d{2}:\d{2}$/.test(endStr)){
            errors.push(`è¡Œ${r+1}: start/endãŒä¸æ­£ (${startStr} - ${endStr})`);
            continue;
          }
          const startMin = hhmmToMin(startStr);
          const endMin = hhmmToMin(endStr);
          if(startMin % 10 !== 0 || endMin % 10 !== 0){
            errors.push(`è¡Œ${r+1}: æ™‚åˆ»ãŒ10åˆ†å˜ä½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ (${startStr} - ${endStr})`);
            continue;
          }
          if(!(endMin > startMin)){
            errors.push(`è¡Œ${r+1}: endã¯startã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„ (${startStr} - ${endStr})`);
            continue;
          }
          if(!groupName){
            errors.push(`è¡Œ${r+1}: groupNameãŒç©ºã§ã™`);
            continue;
          }

          if(!roomId){
            // roomName + building ã‹ã‚‰æ¨å®š
            const cand = ROOMS.filter(x => x.name === roomNameVal && (!buildingVal || x.building === buildingVal));
            if(cand.length === 1) roomId = cand[0].id;
          }
          if(!roomId || !ROOMS.some(x=>x.id===roomId)){
            errors.push(`è¡Œ${r+1}: roomId/roomNameã‹ã‚‰éƒ¨å±‹ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ (${roomId || roomNameVal})`);
            continue;
          }

          const id = get(i_id) || null;
          const projector = clampInt(get(i_pj) || 0, 0, 999);
          const pc = clampInt(get(i_pc) || 0, 0, 999);
          const note = get(i_note);

          parsed.push({
            id,
            date,
            roomId,
            startMin,
            endMin,
            groupName,
            equipment: { projector, pc },
            note,
          });
        }

        if(errors.length){
          alert("CSVã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚å…ˆé ­ã®ã¿è¡¨ç¤ºã—ã¾ã™ã€‚\n\n" + errors.slice(0, 10).join("\n"));
          // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã€æ­£ã—ã„è¡Œã ã‘å–ã‚Šè¾¼ã‚€é‹ç”¨ã‚‚ã‚ã‚‹ãŒã€äº‹æ•…é˜²æ­¢ã§ä¸€æ—¦æ­¢ã‚ã‚‹
          return;
        }
        if(parsed.length === 0){
          alert("å–ã‚Šè¾¼ã‚ã‚‹è¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        // å–ã‚Šè¾¼ã¿å¯¾è±¡ã®æ—¥ä»˜ç¯„å›²ã‚’ã¾ã¨ã‚ã¦å–å¾—ã—ã¦ã€é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«ä½¿ã†
        const dates = Array.from(new Set(parsed.map(x=>x.date))).sort();
        const rangeStart = dates[0];
        const rangeEnd = dates[dates.length-1];

        setBusy(true);
        try{
          const snap = await db.collection("reservations")
            .where("date", ">=", rangeStart)
            .where("date", "<=", rangeEnd)
            .get();
          bumpReads(snap.size);

          const existing = snap.docs.map(d => ({ id: d.id, ...d.data() }));

          // map by date
          const byDate = {};
          for(const r of existing){
            if(!byDate[r.date]) byDate[r.date] = [];
            byDate[r.date].push(r);
          }

          // è¿½åŠ /æ›´æ–°åˆ¤å®š + äºˆç´„é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆéƒ¨å±‹é‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          let addCount = 0;
          let updateCount = 0;
          let skipCount = 0;

          // batchæ›¸ãè¾¼ã¿ï¼ˆæœ€å¤§400ä»¶/ãƒãƒƒãƒå®‰å…¨ï¼‰
          const toWrite = [];

          for(const m of parsed){
            const sameDate = byDate[m.date] || [];
            // éƒ¨å±‹é‡è¤‡ï¼ˆåŒä¸€éƒ¨å±‹ï¼‰
            const sameRoom = sameDate.filter(x => x.roomId === m.roomId && x.id !== m.id);
            const conflict = sameRoom.some(x => overlaps(m.startMin, m.endMin, x.startMin||0, x.endMin||0));
            if(conflict){
              skipCount++;
              continue;
            }

            // æ©Ÿæè¶…éãƒã‚§ãƒƒã‚¯ã¯ã€Œè­¦å‘Šã€ã ãŒã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯å¤§é‡ãªã®ã§ã€è¶…éã¯ã‚¹ã‚­ãƒƒãƒ—æ‰±ã„ã«ã™ã‚‹ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰
            const overlapsAny = sameDate.filter(x => x.id !== m.id).filter(x => overlaps(m.startMin, m.endMin, x.startMin||0, x.endMin||0));
            const used = { projector: 0, pc: 0 };
            for(const r of overlapsAny){
              used.projector += Number(r?.equipment?.projector ?? 0);
              used.pc += Number(r?.equipment?.pc ?? 0);
            }
            const totals = {
              projector: Number(equipmentsMap.projector?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="projector")?.countTotal ?? 0),
              pc: Number(equipmentsMap.pc?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="pc")?.countTotal ?? 0),
            };
            const after = { projector: used.projector + m.equipment.projector, pc: used.pc + m.equipment.pc };
            const over =
              (totals.projector>0 && after.projector>totals.projector) ||
              (totals.pc>0 && after.pc>totals.pc);
            if(over){
              skipCount++;
              continue;
            }

            const payload = {
              date: m.date,
              roomId: m.roomId,
              startMin: m.startMin,
              endMin: m.endMin,
              groupName: (m.groupName||"").trim(),
              note: (m.note||"").trim(),
              equipment: {
                projector: Number(m?.equipment?.projector ?? 0),
                pc: Number(m?.equipment?.pc ?? 0),
              },
              updatedAt: serverTimestamp(),
            };

            if(m.id){
              // æ›´æ–°ï¼ˆidãŒFirestoreã®idã¨ä¸€è‡´ã™ã‚‹æƒ³å®šï¼‰
              toWrite.push({ type:"set", id: m.id, payload });
              updateCount++;
            }else{
              toWrite.push({ type:"add", payload });
              addCount++;
            }

            // ä»¥é™ã®é‡è¤‡åˆ¤å®šã«åæ˜ ï¼ˆä»®åæ˜ ï¼‰
            if(!byDate[m.date]) byDate[m.date] = [];
            byDate[m.date].push({ ...payload, id: m.id || ("(new_"+Math.random().toString(16).slice(2)+")") });
          }

          // æ›¸ãè¾¼ã¿å®Ÿè¡Œï¼ˆbatch chunkï¼‰
          let totalWrites = 0;
          let cursor = 0;
          while(cursor < toWrite.length){
            const chunk = toWrite.slice(cursor, cursor + 400);
            const batch = db.batch();

            for(const item of chunk){
              if(item.type === "set"){
                const ref = db.collection("reservations").doc(item.id);
                batch.set(ref, item.payload, { merge:true });
                totalWrites += 1;
              }else{
                // addã¯batchã«ã§ããªã„ã®ã§ã€ã“ã“ã¯å€‹åˆ¥ã§ï¼ˆcompatåˆ¶ç´„å›é¿ï¼‰
              }
            }

            // addï¼ˆå€‹åˆ¥ï¼‰
            // â€» addã¯æ›¸ãè¾¼ã¿å›æ•°ãŒå¤šã„ãŒã€å¤±æ•—ã—ã«ãã„ã€‚å¿…è¦ãªã‚‰å°†æ¥doc IDç”Ÿæˆã—ã¦batch setã¸æ‹¡å¼µå¯ã€‚
            await batch.commit();
            cursor += 400;
          }

          // addåˆ†ã‚’å€‹åˆ¥å®Ÿè¡Œ
          for(const item of toWrite.filter(x=>x.type==="add")){
            await db.collection("reservations").add({ ...item.payload, createdAt: serverTimestamp() });
            totalWrites += 1;
          }
          bumpWrites(totalWrites);

          alert(`CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\nè¿½åŠ : ${addCount}\næ›´æ–°: ${updateCount}\nã‚¹ã‚­ãƒƒãƒ—(é‡è¤‡/æ©Ÿæè¶…é): ${skipCount}`);
          await refreshAll();
          if(reserveView === "week") await refreshWeek();
        }catch(err){
          console.error(err);
          alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
        }finally{
          setBusy(false);
        }
      }

      // é€±è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆãŸã¨ãã€é€±ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰æ›´æ–°ã‚’ä¿ƒã™ï¼ˆè‡ªå‹•ã§å–ã‚‹ã¨readãŒå¢—ãˆã‚‹ã®ã§ç¶­æŒï¼‰
      useEffect(() => {
        if(tab === "reserve" && reserveView === "week"){
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç„¡ã„/å¤ã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€æœªå–å¾—ãªã‚‰è»½ãèª˜å°
          // ï¼ˆè‡ªå‹•å–å¾—ã—ãŸã‘ã‚Œã°ã“ã“ã§ refreshWeek ã‚’å‘¼ã¹ã¾ã™ï¼‰
        }
      }, [tab, reserveView]);

      // é€±è¡¨ç¤ºï¼šã‚»ãƒ«ç”¨ã®è¡¨ç¤ºï¼ˆçŸ­ãï¼‰
      function cellText(r){
        return `${minToHHMM(r.startMin||0)}-${minToHHMM(r.endMin||0)} ${r.groupName||""}`;
      }

      return (
        <div className="max-w-6xl mx-auto p-4 space-y-4 pb-28">

          {/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå°åˆ·ã§ã¯éè¡¨ç¤ºï¼‰ ===== */}
          <div className="sticky top-0 z-40 -mx-4 px-4 py-3 bg-slate-50/80 glass border-b border-slate-100 no-print">
            <div className="flex items-center justify-between gap-3 flex-wrap">
              <div className="space-y-0.5">
                <div className="text-xs font-black text-slate-500">å¤·éš…æ•™è‚²ä¼šé¤¨</div>
                <div className="text-lg font-black text-slate-800">ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆéƒ¨å±‹äºˆç´„ãƒ»æ©Ÿæãƒ»å‹•é™ï¼‰</div>
              </div>

              <div className="flex items-center gap-2">
                <input
                  type="date"
                  className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700"
                  value={selectedDate}
                  onChange={(e)=>setSelectedDate(e.target.value)}
                />

                <button
                  className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                    busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
                  onClick={refreshAll}
                  disabled={busy}
                  title="Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿"
                >
                  æ›´æ–°
                </button>

                {isLoggedIn ? (
                  <button className="rounded-2xl px-3 py-2 font-black bg-white border border-slate-200 text-slate-700"
                    onClick={logout}
                  >
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                  </button>
                ) : (
                  <LoginButton busy={busy} onLogin={loginWithShared} />
                )}
              </div>
            </div>

            <div className="mt-3 flex items-center gap-2 flex-wrap">
              <Pill tone={isLoggedIn ? "emerald" : "slate"}>
                {isLoggedIn ? "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼‰" : "é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãªã—ï¼‰"}
              </Pill>
              <Pill tone="sky">å…±é€šIDï¼š{SHARED_LOGIN_CODE}</Pill>
              <Pill tone="slate">äºˆç´„å˜ä½ï¼š10åˆ†</Pill>
              <Pill tone="amber">æ¦‚ç®— readsï¼š{ops.reads}</Pill>
              <Pill tone="amber">æ¦‚ç®— writesï¼š{ops.writes}</Pill>
              <button
                className="px-3 py-1.5 rounded-xl bg-white border border-slate-200 font-black text-xs text-slate-700"
                onClick={resetOps}
                title="ä»Šæœˆã®æ¦‚ç®—ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ"
              >
                read/write ãƒªã‚»ãƒƒãƒˆ
              </button>
              {busy ? <Pill tone="amber">å‡¦ç†ä¸­â€¦</Pill> : null}
            </div>
          </div>

          {/* Tabs */}
          <div className="grid grid-cols-4 gap-2 no-print">
            <TabButton active={tab==="home"} onClick={()=>setTab("home")}>å…¨ä½“</TabButton>
            <TabButton active={tab==="reserve"} onClick={()=>setTab("reserve")}>éƒ¨å±‹äºˆç´„</TabButton>
            <TabButton active={tab==="equip"} onClick={()=>setTab("equip")}>æ©Ÿæ</TabButton>
            <TabButton active={tab==="presence"} onClick={()=>setTab("presence")}>å‹•é™</TabButton>
          </div>

          {/* ===== å…¨ä½“ ===== */}
          {tab==="home" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle
                  icon="ğŸ "
                  title="ä»Šæ—¥ã®çŠ¶æ³"
                  sub="ã¾ãšã¯ã“ã“ã ã‘è¦‹ã‚Œã°OK"
                  right={
                    isLoggedIn ? (
                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print"
                        onClick={openNew}
                      >
                        ï¼‹äºˆç´„è¿½åŠ 
                      </button>
                    ) : null
                  }
                />
                <div className="mt-4 grid md:grid-cols-3 gap-3">
                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="text-xs font-black text-slate-500">éƒ¨å±‹äºˆç´„ï¼ˆä»¶æ•°ï¼‰</div>
                    <div className="text-3xl font-black text-slate-800 mt-1">{reservations.length}</div>
                    <div className="text-xs font-bold text-slate-400 mt-2">æ—¥ä»˜ï¼š{selectedDate}</div>
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4 space-y-2">
                    <div className="text-xs font-black text-slate-500">æ©Ÿæä½¿ç”¨ï¼ˆåˆè¨ˆï¼‰</div>
                    <div className="flex items-center justify-between">
                      <div className="font-black text-slate-800">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼</div>
                      <div className="font-black text-slate-800">
                        {equipmentUsed.projector} / {equipmentsMap.projector?.countTotal ?? "â€”"}
                      </div>
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="font-black text-slate-800">PC</div>
                      <div className="font-black text-slate-800">
                        {equipmentUsed.pc} / {equipmentsMap.pc?.countTotal ?? "â€”"}
                      </div>
                    </div>
                    <div className="text-xs font-bold text-slate-400">â€»äºˆç´„ã«ç´ã¥ãã€Œä½¿ç”¨å°æ•°ã€ã®åˆè¨ˆ</div>
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="text-xs font-black text-slate-500">å‹•é™ï¼ˆä»Šæ—¥ï¼‰</div>
                    <div className="mt-2 space-y-2">
                      <PresenceMini label="æ›¸è¨˜é•·" data={presence?.chief}/>
                      <PresenceMini label="æ›¸è¨˜æ¬¡é•·" data={presence?.deputy}/>
                    </div>
                  </div>
                </div>

                <div className="mt-4 text-sm font-black text-slate-700">éƒ¨å±‹ã”ã¨ã®äºˆç´„ï¼ˆ{selectedDate}ï¼‰</div>

                <div className="mt-3 grid md:grid-cols-2 gap-3">
                  {ROOMS.map(room => (
                    <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                      <div className="flex items-center justify-between">
                        <div className="space-y-0.5">
                          <div className="text-xs font-black text-slate-400">{room.building}</div>
                          <div className="font-black text-slate-800">{room.name}</div>
                        </div>
                        <Pill tone="slate">{(byRoom[room.id]||[]).length}ä»¶</Pill>
                      </div>

                      <div className="mt-3 space-y-2">
                        {(byRoom[room.id]||[]).length === 0 ? (
                          <div className="text-xs font-bold text-slate-400">äºˆç´„ãªã—</div>
                        ) : (
                          (byRoom[room.id]||[]).map(r => (
                            <div key={r.id} className="flex items-start justify-between gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                              <div className="min-w-0">
                                <div className="font-black text-slate-800">
                                  {minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)} / {r.groupName}
                                </div>
                                <div className="text-xs font-bold text-slate-500 mt-1 flex gap-2 flex-wrap">
                                  {(Number(r?.equipment?.projector||0)>0) && <Pill tone="sky">PJ {r.equipment.projector}</Pill>}
                                  {(Number(r?.equipment?.pc||0)>0) && <Pill tone="sky">PC {r.equipment.pc}</Pill>}
                                  {r.note ? <Pill tone="slate">ãƒ¡ãƒ¢</Pill> : null}
                                </div>
                              </div>

                              {isLoggedIn ? (
                                <div className="shrink-0 flex items-center gap-2 no-print">
                                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700"
                                    onClick={()=>openEdit(r)}
                                  >
                                    ç·¨é›†
                                  </button>
                                </div>
                              ) : null}
                            </div>
                          ))
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </Card>
            </div>
          )}

          {/* ===== éƒ¨å±‹äºˆç´„ ===== */}
          {tab==="reserve" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle
                  icon="ğŸ“…"
                  title="éƒ¨å±‹äºˆç´„"
                  sub={reserveView==="day" ? "æ—¥è¡¨ç¤ºï¼ˆé¸æŠä¸­ã®æ—¥ä»˜ï¼‰" : `é€±è¡¨ç¤ºï¼ˆ${weekStart}ã€œ${weekEnd}ï¼‰`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button
                        className={classNames("px-4 py-2 rounded-2xl font-black border shadow-sm",
                          reserveView==="day" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
                        onClick={()=>setReserveView("day")}
                      >
                        æ—¥è¡¨ç¤º
                      </button>
                      <button
                        className={classNames("px-4 py-2 rounded-2xl font-black border shadow-sm",
                          reserveView==="week" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
                        onClick={async ()=>{
                          setReserveView("week");
                          // åˆ‡æ›¿æ™‚ã«é€±ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°è»½ãå–å¾—ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³æ–¹å¼ã‚’å°Šé‡ã—ã¤ã¤ã€ã“ã“ã ã‘è‡ªå‹•ï¼‰
                          if((weekReservations||[]).length===0){
                            setBusy(true);
                            try{ await refreshWeek(); } finally { setBusy(false); }
                          }
                        }}
                      >
                        é€±è¡¨ç¤º
                      </button>

                      {isLoggedIn ? (
                        <button
                          className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm"
                          onClick={openNew}
                        >
                          ï¼‹äºˆç´„è¿½åŠ 
                        </button>
                      ) : null}

                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
                        onClick={()=>setCsvOpen(true)}
                      >
                        CSV/å°åˆ·
                      </button>

                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
                        onClick={doPrint}
                        title="A4æ¨ªã§å°åˆ·"
                      >
                        å°åˆ·
                      </button>
                    </div>
                  }
                />

                {/* æ—¥è¡¨ç¤º */}
                {reserveView==="day" && (
                  <div className="mt-4 space-y-2">
                    {reservations.length===0 ? (
                      <div className="text-sm font-bold text-slate-400 p-3">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ›´æ–°ã§èª­ã¿è¾¼ã¿ï¼‰</div>
                    ) : reservations
                      .slice()
                      .sort((a,b)=> (a.startMin||0)-(b.startMin||0))
                      .map(r => (
                        <div key={r.id} className="p-4 rounded-3xl border border-slate-100 bg-white">
                          <div className="flex items-start justify-between gap-3 flex-wrap">
                            <div className="space-y-1 min-w-0">
                              <div className="text-xs font-black text-slate-400">
                                {roomBuilding(r.roomId)} / {roomName(r.roomId)}
                              </div>
                              <div className="text-base font-black text-slate-800">
                                {minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)}ã€€{r.groupName}
                              </div>
                              <div className="text-xs font-bold text-slate-500 flex gap-2 flex-wrap">
                                {(Number(r?.equipment?.projector||0)>0) && <Pill tone="sky">PJ {r.equipment.projector}</Pill>}
                                {(Number(r?.equipment?.pc||0)>0) && <Pill tone="sky">PC {r.equipment.pc}</Pill>}
                                {r.note ? <Pill tone="slate">{r.note}</Pill> : <span className="text-slate-400">ãƒ¡ãƒ¢ãªã—</span>}
                              </div>
                            </div>

                            {isLoggedIn ? (
                              <div className="flex items-center gap-2 no-print">
                                <button className="px-4 py-2 rounded-2xl bg-slate-100 font-black text-slate-700"
                                  onClick={()=>openEdit(r)}
                                >
                                  ç·¨é›†
                                </button>
                                <button className="px-4 py-2 rounded-2xl bg-rose-50 border border-rose-100 font-black text-rose-700"
                                  onClick={()=>deleteReservation(r.id)}
                                >
                                  å‰Šé™¤
                                </button>
                              </div>
                            ) : null}
                          </div>
                        </div>
                      ))}
                  </div>
                )}

                {/* é€±è¡¨ç¤ºï¼ˆéƒ¨å±‹Ã—æ›œæ—¥ï¼‰ */}
                {reserveView==="week" && (
                  <div className="mt-4 overflow-x-auto">
                    <table className="min-w-[1100px] w-full border-separate border-spacing-2 print-table print-tight">
                      <thead>
                        <tr>
                          <th className="text-left text-xs font-black text-slate-500 px-3 py-2">éƒ¨å±‹</th>
                          {weekKeys.map(d => (
                            <th key={d} className="text-left text-xs font-black text-slate-600 px-3 py-2 bg-slate-50 border border-slate-100 rounded-2xl">
                              <div className="font-black">{d}</div>
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {ROOMS.map(room => (
                          <tr key={room.id}>
                            <td className="align-top px-3 py-3 bg-white border border-slate-100 rounded-2xl">
                              <div className="text-[11px] font-black text-slate-400">{room.building}</div>
                              <div className="font-black text-slate-800">{room.name}</div>
                            </td>
                            {weekKeys.map(d => {
                              const list = (weekMap[d]?.[room.id] || []);
                              return (
                                <td key={d} className="align-top px-3 py-3 bg-white border border-slate-100 rounded-2xl">
                                  {list.length===0 ? (
                                    <div className="text-xs font-bold text-slate-300">â€”</div>
                                  ) : (
                                    <div className="space-y-2">
                                      {list.map(r => (
                                        <div key={r.id} className="p-2 rounded-2xl bg-slate-50 border border-slate-100">
                                          <div className="font-black text-slate-800 text-xs">
                                            {cellText(r)}
                                          </div>
                                          <div className="mt-1 flex gap-1 flex-wrap">
                                            {(Number(r?.equipment?.projector||0)>0) && <span className="text-[10px] font-black text-sky-700">PJ{r.equipment.projector}</span>}
                                            {(Number(r?.equipment?.pc||0)>0) && <span className="text-[10px] font-black text-sky-700">PC{r.equipment.pc}</span>}
                                          </div>
                                          {isLoggedIn ? (
                                            <div className="mt-2 flex gap-2 no-print">
                                              <button className="px-3 py-1.5 rounded-2xl bg-white border border-slate-200 font-black text-xs text-slate-700"
                                                onClick={()=>openEdit(r)}
                                              >
                                                ç·¨é›†
                                              </button>
                                            </div>
                                          ) : null}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </td>
                              );
                            })}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <div className="mt-3 text-xs font-bold text-slate-400 no-print">
                      â€»é€±è¡¨ç¤ºã®å†…å®¹ã¯ã€Œé€±è¡¨ç¤ºã«åˆ‡æ›¿ã€ã¾ãŸã¯ã€Œæ›´æ–°ã€ã§èª­ã¿è¾¼ã¿ï¼ˆæ¦‚ç®—readã«åæ˜ ã•ã‚Œã¾ã™ï¼‰
                    </div>
                  </div>
                )}
              </Card>

              {/* å°åˆ·ç”¨ï¼ˆç”»é¢ã®é€±/æ—¥è¡¨ç¤ºã«è¿‘ã„å½¢ã§å‡ºã™ï¼‰ */}
              <div className="print-area">
                <div className="text-lg font-black">å¤·éš…æ•™è‚²ä¼šé¤¨ äºˆç´„è¡¨</div>
                <div className="text-sm font-bold text-slate-600">
                  {reserveView==="day" ? `æ—¥ä»˜ï¼š${selectedDate}` : `é€±ï¼š${weekStart}ã€œ${weekEnd}`}
                </div>
              </div>
            </div>
          )}

          {/* ===== æ©Ÿæ ===== */}
          {tab==="equip" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle icon="ğŸ§°" title="æ©Ÿæ" sub="ç·æ•°ï¼ˆãƒã‚¹ã‚¿ï¼‰ã¨ã€äºˆç´„ã«ç´ã¥ãä½¿ç”¨æ•°ã‚’ç®¡ç†" />
                <div className="mt-4 flex items-center justify-between flex-wrap gap-2">
                  <div className="text-sm font-black text-slate-700">æ©Ÿæãƒã‚¹ã‚¿</div>
                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700 no-print"
                      onClick={seedEquipments}
                    >
                      åˆæœŸãƒ‡ãƒ¼ã‚¿ä½œæˆ
                    </button>
                  ) : (
                    <div className="text-xs font-bold text-slate-400">â€»ç·¨é›†ã¯ãƒ­ã‚°ã‚¤ãƒ³å¾Œ</div>
                  )}
                </div>

                <div className="mt-3 grid md:grid-cols-2 gap-3">
                  {(equipments || []).map(e => (
                    <div key={e.id} className="p-4 rounded-3xl border border-slate-100 bg-slate-50">
                      <div className="flex items-center justify-between gap-2">
                        <div className="font-black text-slate-800">{e.name}</div>
                        <Pill tone="slate">ç·æ•°ï¼š{e.countTotal ?? "â€”"}</Pill>
                      </div>
                      <div className="mt-2 text-xs font-bold text-slate-500">
                        â€»ç·æ•°å¤‰æ›´UIã¯å¿…è¦ãªã‚‰è¿½åŠ ã§ãã¾ã™ï¼ˆä»Šã¯MVPï¼‰
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-4 rounded-3xl border border-slate-100 bg-white p-4">
                  <div className="font-black text-slate-800">ã“ã®æ—¥ã®ä½¿ç”¨åˆè¨ˆï¼ˆäºˆç´„ã‹ã‚‰é›†è¨ˆï¼‰</div>
                  <div className="mt-2 text-sm font-bold text-slate-700">
                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ï¼š{equipmentUsed.projector} ï¼ PCï¼š{equipmentUsed.pc}
                  </div>
                  <div className="mt-1 text-xs font-bold text-slate-400">
                    â€»åŒæ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯ã¯ã€Œä¿å­˜æ™‚ã€ã«å‹•ãã¾ã™ï¼ˆè¶…éã™ã‚‹ã¨è­¦å‘Šï¼‰
                  </div>
                </div>
              </Card>
            </div>
          )}

          {/* ===== å‹•é™ ===== */}
          {tab==="presence" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle icon="ğŸŸ¢" title="å‹•é™" sub="åˆå‰ãƒ»åˆå¾Œãƒ»å¤•æ–¹ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§æ›´æ–°ï¼‰" />

                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  <PresenceEditor
                    title="æ›¸è¨˜é•·"
                    value={presence?.chief || {}}
                    onSet={(slot,val)=>setPresenceValue("chief", slot, val)}
                    disabled={!isLoggedIn || busy}
                  />
                  <PresenceEditor
                    title="æ›¸è¨˜æ¬¡é•·"
                    value={presence?.deputy || {}}
                    onSet={(slot,val)=>setPresenceValue("deputy", slot, val)}
                    disabled={!isLoggedIn || busy}
                  />
                </div>

                {!isLoggedIn ? (
                  <div className="mt-3 text-xs font-bold text-slate-400">â€»å‹•é™ã®æ›´æ–°ã¯ãƒ­ã‚°ã‚¤ãƒ³å¾Œ</div>
                ) : null}
              </Card>
            </div>
          )}

          {/* ===== äºˆç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */}
          <Modal
            open={editorOpen}
            onClose={()=>{ setEditorOpen(false); setEditTarget(null); }}
            title={editTarget?.id ? "äºˆç´„ã‚’ç·¨é›†" : "äºˆç´„ã‚’è¿½åŠ "}
          >
            {editTarget ? (
              <ReservationEditor
                model={editTarget}
                setModel={setEditTarget}
                rooms={ROOMS}
                opts10={opts10}
                onSave={saveReservation}
                onCancel={()=>{ setEditorOpen(false); setEditTarget(null); }}
                busy={busy}
                isLoggedIn={isLoggedIn}
              />
            ) : null}
          </Modal>

          {/* ===== CSV/å°åˆ·ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */}
          <Modal
            open={csvOpen}
            onClose={()=>setCsvOpen(false)}
            title="CSV å…¥å‡ºåŠ› / å°åˆ·ï¼ˆA4æ¨ªï¼‰"
          >
            <div className="space-y-4">
              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="font-black text-slate-800">å°åˆ·ï¼ˆA4æ¨ªï¼‰</div>
                <div className="text-xs font-bold text-slate-500 mt-1">
                  ç”»é¢ã®ã€Œæ—¥è¡¨ç¤º/é€±è¡¨ç¤ºã€ãã®ã¾ã¾å°åˆ·ã§ãã¾ã™ã€‚
                </div>
                <div className="mt-3 flex gap-2 flex-wrap">
                  <button
                    className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700"
                    onClick={()=>{ setCsvOpen(false); setTimeout(()=>window.print(), 100); }}
                  >
                    ä»Šã®ç”»é¢ã‚’å°åˆ·
                  </button>
                </div>
              </div>

              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="font-black text-slate-800">CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆäºˆç´„ï¼‰</div>
                <div className="text-xs font-bold text-slate-500 mt-1">
                  é€±è¡¨ç¤ºãªã‚‰ã€Œé€±ã®ç¯„å›²ã€ã€æ—¥è¡¨ç¤ºãªã‚‰ã€Œãã®æ—¥ã€ã‚’ãŠã™ã™ã‚ã€‚
                </div>
                <CSVExportPanel
                  selectedDate={selectedDate}
                  weekStart={weekStart}
                  weekEnd={weekEnd}
                  reserveView={reserveView}
                  onExport={exportCSV}
                  busy={busy}
                />
              </div>

              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="font-black text-slate-800">CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆäºˆç´„ï¼‰</div>
                <div className="text-xs font-bold text-slate-500 mt-1">
                  â€»ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚é‡è¤‡ï¼ˆåŒå®¤åŒæ™‚é–“ï¼‰/æ©Ÿæè¶…éã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å®‰å…¨ã«å–ã‚Šè¾¼ã¿ã¾ã™ã€‚
                </div>
                <CSVImportPanel
                  disabled={!isLoggedIn || busy}
                  onImport={importCSV}
                />
              </div>

              <div className="text-xs font-bold text-slate-400">
                CSVãƒ˜ãƒƒãƒ€ä¾‹ï¼šid,date,building,roomId,roomName,start,end,groupName,projector,pc,note
              </div>
            </div>
          </Modal>

          {/* ===== Toast ===== */}
          {toast ? (
            <div className={classNames(
              "fixed left-1/2 -translate-x-1/2 bottom-4 z-50 px-4 py-3 rounded-3xl shadow-lg border font-black no-print",
              toast.type==="ok" ? "bg-emerald-600 text-white border-emerald-700" : "bg-rose-600 text-white border-rose-700"
            )}>
              {toast.msg}
            </div>
          ) : null}

          {/* Footer */}
          <div className="fixed inset-x-0 bottom-0 z-30 bg-white/85 glass border-t border-slate-100 no-print">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
              <div className="text-xs font-bold text-slate-500">
                â€»ã€Œæ›´æ–°ã€ã§Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤ºï¼‰
              </div>
              <div className="text-xs font-bold text-slate-400">
                å…±é€šIDï¼š{SHARED_LOGIN_CODE}
              </div>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * Login
     **********************/
    function LoginButton({busy, onLogin}){
      const [open, setOpen] = useState(false);
      const [pw, setPw] = useState("");

      return (
        <>
          <button
            className={classNames("rounded-2xl px-3 py-2 font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
            onClick={()=>setOpen(true)}
            disabled={busy}
            title="ç·¨é›†ã™ã‚‹å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³"
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>

          <Modal open={open} onClose={()=>setOpen(false)} title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå…±é€šIDæ–¹å¼ï¼‰">
            <div className="space-y-3">
              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="text-xs font-black text-slate-500">å…±é€šID</div>
                <div className="text-xl font-black text-slate-800 mt-1">ismkaikan</div>
                <div className="text-xs font-bold text-slate-400 mt-1">â€»IDã¯å›ºå®šã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¿å…¥åŠ›ã—ã¾ã™ã€‚</div>
              </div>

              <div className="space-y-2">
                <div className="text-sm font-black text-slate-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
                <input
                  type="password"
                  className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                  value={pw}
                  onChange={(e)=>setPw(e.target.value)}
                  placeholder="Firebaseã§ä½œæˆã—ãŸPW"
                />
              </div>

              <div className="flex items-center gap-2">
                <button
                  className="w-full rounded-2xl px-4 py-3 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm"
                  onClick={()=>{ onLogin(pw); setOpen(false); setPw(""); }}
                >
                  ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç·¨é›†ã™ã‚‹
                </button>
                <button
                  className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700"
                  onClick={()=>{ setOpen(false); setPw(""); }}
                >
                  ã‚„ã‚ã‚‹
                </button>
              </div>

              <div className="text-xs font-bold text-slate-400">
                â€»Firebase Authenticationã«ã€Œismkaikan@shared.localã€ã‚’ä½œæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
              </div>
            </div>
          </Modal>
        </>
      );
    }

    /**********************
     * Reservation Editor
     **********************/
    function ReservationEditor({model, setModel, rooms, opts10, onSave, onCancel, busy, isLoggedIn}){
      const roomGroups = useMemo(() => {
        const g = { "æœ¬é¤¨": [], "åˆ¥é¤¨": [] };
        for(const r of rooms){
          if(!g[r.building]) g[r.building] = [];
          g[r.building].push(r);
        }
        return g;
      }, [rooms]);

      function setField(k,v){
        setModel(prev => ({ ...prev, [k]: v }));
      }
      function setEquip(k,v){
        const n = Math.max(0, Math.min(999, Number(v)||0));
        setModel(prev => ({ ...prev, equipment: { ...(prev.equipment||{}), [k]: n }}));
      }

      // çµ‚äº†æ™‚åˆ»ã®é¸æŠè‚¢ï¼šé–‹å§‹+10ä»¥ä¸Š
      const endOpts = opts10.filter(o => o.value >= (Number(model.startMin)||0) + 10);

      return (
        <div className="space-y-4">
          {!isLoggedIn ? (
            <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">
              ç·¨é›†ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼ˆé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¿å­˜ã§ãã¾ã›ã‚“ï¼‰
            </div>
          ) : null}

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">æ—¥ä»˜</div>
              <input
                type="date"
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.date}
                onChange={(e)=>setField("date", e.target.value)}
              />
            </div>

            <div>
              <div className="text-sm font-black text-slate-700 mb-2">éƒ¨å±‹</div>
              <select
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.roomId}
                onChange={(e)=>setField("roomId", e.target.value)}
              >
                {Object.keys(roomGroups).map(b => (
                  <optgroup key={b} label={b}>
                    {roomGroups[b].map(r => (
                      <option key={r.id} value={r.id}>{r.name}</option>
                    ))}
                  </optgroup>
                ))}
              </select>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">é–‹å§‹ï¼ˆ10åˆ†å˜ä½ï¼‰</div>
              <select
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.startMin}
                onChange={(e)=>{
                  const s = Number(e.target.value);
                  const eMin = Number(model.endMin)||0;
                  setField("startMin", s);
                  if(eMin <= s) setField("endMin", s+10);
                }}
              >
                {opts10.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <div className="text-sm font-black text-slate-700 mb-2">çµ‚äº†ï¼ˆé–‹å§‹ï¼‹10åˆ†ä»¥ä¸Šï¼‰</div>
              <select
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.endMin}
                onChange={(e)=>setField("endMin", Number(e.target.value))}
              >
                {endOpts.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>
          </div>

          <div>
            <div className="text-sm font-black text-slate-700 mb-2">å›£ä½“åï¼ˆå¿…é ˆï¼‰</div>
            <input
              className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
              value={model.groupName}
              onChange={(e)=>setField("groupName", e.target.value)}
              placeholder="ä¾‹ï¼šâ—‹â—‹ç ”ç©¶ä¼šã€â–³â–³ã‚¯ãƒ©ãƒ– ãªã©"
            />
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">æ©Ÿæ</div>
              <div className="mt-3 space-y-3">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-bold text-slate-700">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼</div>
                  <input
                    type="number" min="0" max="999"
                    className="w-24 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                    value={model?.equipment?.projector ?? 0}
                    onChange={(e)=>setEquip("projector", e.target.value)}
                  />
                </div>
                <div className="flex items-center justify-between gap-2">
                  <div className="font-bold text-slate-700">PC</div>
                  <input
                    type="number" min="0" max="999"
                    className="w-24 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                    value={model?.equipment?.pc ?? 0}
                    onChange={(e)=>setEquip("pc", e.target.value)}
                  />
                </div>
                <div className="text-xs font-bold text-slate-400">
                  â€»ä¿å­˜å‰ã«ã€ŒåŒæ™‚é–“å¸¯ã§ç·æ•°è¶…éã€ã‚’è­¦å‘Šã—ã¾ã™
                </div>
              </div>
            </div>

            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
              <textarea
                className="mt-3 w-full h-28 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700"
                value={model.note}
                onChange={(e)=>setField("note", e.target.value)}
                placeholder="ä¾‹ï¼šæœºé…ç½®ã€æ¥é¤¨æ™‚é–“ã®ç›®å®‰ã€éµã®å—ã‘æ¸¡ã— ãªã©"
              />
            </div>
          </div>

          <div className="flex items-center gap-2">
            <button
              className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                (!isLoggedIn || busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
              disabled={!isLoggedIn || busy}
              onClick={()=>onSave(model)}
            >
              ä¿å­˜
            </button>
            <button
              className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700"
              onClick={onCancel}
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      );
    }

    /**********************
     * Presence
     **********************/
    function PresenceMini({label, data}){
      const d = data || {};
      const f = (x)=> x ? x : "â€”";
      return (
        <div className="rounded-2xl bg-white border border-slate-100 p-3">
          <div className="text-xs font-black text-slate-500">{label}</div>
          <div className="mt-1 text-xs font-bold text-slate-700">
            åˆå‰ï¼š{f(d.am)} ï¼ åˆå¾Œï¼š{f(d.pm)} ï¼ å¤•æ–¹ï¼š{f(d.eve)}
          </div>
        </div>
      );
    }

    function PresenceEditor({title, value, onSet, disabled}){
      const states = [
        { key:"åœ¨é¤¨" },
        { key:"å¤–å‡º" },
        { key:"ä¼šè­°" },
        { key:"ä¼‘" },
      ];
      const slots = [
        { id:"am", label:"åˆå‰" },
        { id:"pm", label:"åˆå¾Œ" },
        { id:"eve", label:"å¤•æ–¹" },
      ];
      const v = value || {};

      return (
        <div className="rounded-3xl border border-slate-100 bg-white p-4">
          <div className="font-black text-slate-800">{title}</div>
          <div className="mt-3 space-y-3">
            {slots.map(s => (
              <div key={s.id} className="rounded-3xl bg-slate-50 border border-slate-100 p-3">
                <div className="flex items-center justify-between gap-2 flex-wrap">
                  <div className="font-black text-slate-700">{s.label}</div>
                  <Pill tone="slate">ç¾åœ¨ï¼š{v[s.id] || "â€”"}</Pill>
                </div>
                <div className="mt-2 flex gap-2 flex-wrap">
                  {states.map(st => (
                    <button
                      key={st.key}
                      disabled={disabled}
                      onClick={()=>onSet(s.id, st.key)}
                      className={classNames(
                        "px-3 py-2 rounded-2xl border font-black shadow-sm",
                        (v[s.id]===st.key)
                          ? "bg-slate-900 text-white border-slate-900"
                          : "bg-white text-slate-700 border-slate-200",
                        disabled ? "opacity-50" : ""
                      )}
                    >
                      {st.key}
                    </button>
                  ))}
                  <button
                    disabled={disabled}
                    onClick={()=>onSet(s.id, "")}
                    className={classNames(
                      "px-3 py-2 rounded-2xl border font-black shadow-sm bg-white text-slate-500 border-slate-200",
                      disabled ? "opacity-50" : ""
                    )}
                    title="æœªè¨­å®šã«æˆ»ã™"
                  >
                    ã‚¯ãƒªã‚¢
                  </button>
                </div>
              </div>
            ))}
          </div>
          <div className="mt-2 text-xs font-bold text-slate-400">â€»ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§ä¿å­˜ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿ï¼‰</div>
        </div>
      );
    }

    /**********************
     * CSV Panels
     **********************/
    function CSVExportPanel({ selectedDate, weekStart, weekEnd, reserveView, onExport, busy }){
      const [mode, setMode] = useState(reserveView==="week" ? "week" : "day"); // day | week | range
      const [start, setStart] = useState(weekStart);
      const [end, setEnd] = useState(weekEnd);

      useEffect(() => {
        if(reserveView==="week"){
          setMode("week");
          setStart(weekStart); setEnd(weekEnd);
        }else{
          setMode("day");
          setStart(selectedDate); setEnd(selectedDate);
        }
      }, [reserveView, selectedDate, weekStart, weekEnd]);

      function run(){
        if(mode==="day") onExport(selectedDate, selectedDate);
        else if(mode==="week") onExport(weekStart, weekEnd);
        else onExport(start, end);
      }

      return (
        <div className="mt-3 space-y-3">
          <div className="flex gap-2 flex-wrap">
            <button
              className={classNames("px-4 py-2 rounded-2xl font-black border",
                mode==="day" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
              onClick={()=>setMode("day")}
            >
              æ—¥ï¼ˆ{selectedDate}ï¼‰
            </button>
            <button
              className={classNames("px-4 py-2 rounded-2xl font-black border",
                mode==="week" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
              onClick={()=>setMode("week")}
            >
              é€±ï¼ˆ{weekStart}ã€œ{weekEnd}ï¼‰
            </button>
            <button
              className={classNames("px-4 py-2 rounded-2xl font-black border",
                mode==="range" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
              onClick={()=>setMode("range")}
            >
              ç¯„å›²æŒ‡å®š
            </button>
          </div>

          {mode==="range" ? (
            <div className="grid grid-cols-2 gap-2">
              <div>
                <div className="text-xs font-black text-slate-600 mb-1">é–‹å§‹</div>
                <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold"
                  value={start} onChange={(e)=>setStart(e.target.value)}
                />
              </div>
              <div>
                <div className="text-xs font-black text-slate-600 mb-1">çµ‚äº†</div>
                <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold"
                  value={end} onChange={(e)=>setEnd(e.target.value)}
                />
              </div>
            </div>
          ) : null}

          <button
            className={classNames("w-full px-4 py-3 rounded-2xl font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
            onClick={run}
            disabled={busy}
          >
            CSVã‚’æ›¸ãå‡ºã™
          </button>
        </div>
      );
    }

    function CSVImportPanel({ disabled, onImport }){
      const fileRef = useRef(null);

      return (
        <div className="mt-3 space-y-3">
          <input
            ref={fileRef}
            type="file"
            accept=".csv,text/csv"
            className="block w-full text-sm"
            disabled={disabled}
          />
          <button
            className={classNames("w-full px-4 py-3 rounded-2xl font-black border shadow-sm",
              disabled ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
            disabled={disabled}
            onClick={()=>{
              const f = fileRef.current?.files?.[0];
              if(!f){ alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
              onImport(f);
              fileRef.current.value = "";
            }}
          >
            CSVã‚’å–ã‚Šè¾¼ã‚€ï¼ˆå®‰å…¨ãƒ¢ãƒ¼ãƒ‰ï¼‰
          </button>
        </div>
      );
    }

    // Render
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);
  </script>
</body>
</html>
