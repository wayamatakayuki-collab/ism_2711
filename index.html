<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>夷隅教育会館 予約管理システム</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }

    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .print-card { break-inside: avoid; page-break-inside: avoid; }
      .print-tight { font-size: 11px; }
    }
    .print-only { display: none; }
    .break-avoid { break-inside: avoid; page-break-inside: avoid; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="boot" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;">
    <div style="max-width:720px;padding:24px;">
      <div style="font-weight:800;font-size:18px;margin-bottom:8px;">読み込み中…</div>
      <div id="bootMsg" style="color:#334155;font-size:14px;line-height:1.6;">必要なライブラリを読み込んでいます。</div>
      <pre id="bootErr" style="display:none;margin-top:12px;white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:12px;overflow:auto;max-height:45vh;"></pre>
      <div style="margin-top:10px;color:#64748b;font-size:12px;">※ここにエラーが表示された場合、その内容をそのまま送ってください。</div>
    </div>
  </div>
  <div id="app"></div>

  <script>
  (function(){
    const boot = document.getElementById("boot");
    const msg = document.getElementById("bootMsg");
    const errBox = document.getElementById("bootErr");
    const setMsg = (t)=>{ try{ msg.textContent = t; }catch(e){} };
    const showErr = (e)=>{
      try{
        errBox.style.display = "block";
        errBox.textContent = String(e && (e.stack || e.message) || e);
        setMsg("起動に失敗しました。下のエラー内容をご確認ください。");
      }catch(_){ }
    };
    window.addEventListener("error", (ev)=>{ showErr(ev.error || ev.message); });
    window.addEventListener("unhandledrejection", (ev)=>{ showErr(ev.reason); });

    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.crossOrigin = "anonymous";
        s.onload = ()=>resolve(url);
        s.onerror = ()=>reject(new Error("Failed to load: " + url));
        document.head.appendChild(s);
      });
    }

    async function loadWithFallback(name, primary, fallback){
      setMsg(name + " を読み込み中…");
      try{
        return await loadScript(primary);
      }catch(e1){
        try{
          return await loadScript(fallback);
        }catch(e2){
          throw new Error(name + " の読み込みに失敗しました。\n" + e1.message + "\n" + e2.message);
        }
      }
    }

    async function bootApp(){
      try{
        await loadWithFallback("React", "https://unpkg.com/react@18/umd/react.production.min.js", "https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js");
        await loadWithFallback("ReactDOM", "https://unpkg.com/react-dom@18/umd/react-dom.production.min.js", "https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js");
        await loadWithFallback("Babel", "https://unpkg.com/@babel/standalone/babel.min.js", "https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js");

        if(!window.React || !window.ReactDOM || !window.Babel){
          throw new Error("必要なライブラリが読み込めませんでした（React/ReactDOM/Babel）。");
        }

        setMsg("アプリを起動しています…");
        const src = document.getElementById("appCode").textContent;
        const transformed = window.Babel.transform(src, { presets: ["react"] }).code;
        (new Function(transformed))();
        boot.style.display = "none";
      }catch(e){
        showErr(e);
      }
    }

    bootApp();
  })();
  </script>

  <script id="appCode" type="text/plain">
const { useEffect, useMemo, useRef, useState } = React;

/**********************
 * 固定設定
 **********************/
const SHARED_LOGIN_CODE = "ismkaikan";
const SHARED_EMAIL = `${SHARED_LOGIN_CODE}@shared.local`;
const CACHE_PREFIX = "ismkaikan_cache_v5";
const OPS_KEY = "ismkaikan_ops_v1";

/**********************
 * Firebase 初期化
 **********************/
const firebaseConfig = {
  apiKey: "AIzaSyAfO6ZAOlAZg-yG8ja3fR3U-zEnqMwmpw8",
  authDomain: "ism2711-49523.firebaseapp.com",
  projectId: "ism2711-49523",
  storageBucket: "ism2711-49523.firebasestorage.app",
  messagingSenderId: "44334771941",
  appId: "1:44334771941:web:a55badc93b3f6bdf59ee0c",
  measurementId: "G-M4SWCYYH82"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

/**********************
 * 既定（初期フォールバック）
 **********************/
const DEFAULT_ROOMS = [
  { id: "honkan_oo", name: "大会議室", building: "本館", active: true, order: 10 },
  { id: "honkan_chu", name: "中会議室", building: "本館", active: true, order: 20 },
  { id: "honkan_sho", name: "小会議室", building: "本館", active: true, order: 30 },
  { id: "honkan_ousetsu", name: "応接室", building: "本館", active: true, order: 40 },
  { id: "honkan_nihon", name: "日本間", building: "本館", active: true, order: 50 },
  { id: "honkan_print", name: "印刷室", building: "本館", active: true, order: 60 },
  { id: "honkan_library", name: "図書室", building: "本館", active: true, order: 70 },
  { id: "honkan_lab", name: "研究所", building: "本館", active: true, order: 80 },
  { id: "bekkan_1f", name: "１階会議室", building: "別館", active: true, order: 110 },
  { id: "bekkan_2f", name: "２階会議室", building: "別館", active: true, order: 120 },
];

const DEFAULT_EQUIPMENTS = [
  { id: "projector", name: "プロジェクター", abbr: "PJ", countTotal: 3, active: true, order: 10 },
  { id: "pc", name: "PC", abbr: "PC", countTotal: 10, active: true, order: 20 },
];

/**********************
 * utils
 **********************/
const pad2 = (n) => String(n).padStart(2, "0");
const monthKeyLocal = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
const todayKeyLocal = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const parseKeyToDate = (key) => {
  const [y,m,d] = key.split("-").map(Number);
  return new Date(y, m-1, d);
};
const addDaysKey = (key, add) => {
  const dt = parseKeyToDate(key);
  dt.setDate(dt.getDate()+add);
  return todayKeyLocal(dt);
};
const startOfWeekSunday = (key) => {
  const dt = parseKeyToDate(key);
  const dow = dt.getDay();
  dt.setDate(dt.getDate() - dow);
  return todayKeyLocal(dt);
};
const hhmmToMin = (hhmm) => {
  const [h,m] = hhmm.split(":").map(Number);
  return h*60+m;
};
const minToHHMM = (min) => `${pad2(Math.floor(min/60))}:${pad2(min%60)}`;
const overlaps = (aS,aE,bS,bE) => (aS < bE) && (bS < aE);
const isValidDateKey = (k) => /^\d{4}-\d{2}-\d{2}$/.test(k);

const monthKeyFromDateKey = (k) => String(k || "").slice(0,7);
const dateKeyFromParts = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
const startOfMonthKey = (monthKey) => `${monthKey}-01`;
const endOfMonthKey = (monthKey) => {
  const parts = String(monthKey || "").split("-");
  const y = Number(parts[0]);
  const m = Number(parts[1]);
  if(!Number.isFinite(y) || !Number.isFinite(m)) return `${monthKey}-28`;
  const last = new Date(y, m, 0).getDate();
  return dateKeyFromParts(y, m, last);
};
const addMonthsKey = (monthKey, add) => {
  const parts = String(monthKey || "").split("-");
  const y0 = Number(parts[0]);
  const m0 = Number(parts[1]);
  const dt = new Date(Number.isFinite(y0) ? y0 : new Date().getFullYear(), (Number.isFinite(m0)?m0:1)-1, 1);
  dt.setMonth(dt.getMonth() + Number(add||0));
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;
};

const parseDateLooseToKey = (raw) => {
  const s = String(raw ?? "").trim();
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if(/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
  const m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})$/);
  if(m){
    const y = Number(m[1]);
    const mo = Number(m[2]);
    const d = Number(m[3]);
    if(!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;
    if(mo<1||mo>12||d<1||d>31) return null;
    return `${y}-${pad2(mo)}-${pad2(d)}`;
  }
  return null;
};

const parseHHMMLoose = (raw) => {
  const s = String(raw ?? "").trim();
  if(!s) return null;
  const m = s.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
  if(m){
    const h = Number(m[1]);
    const mm = m[2] == null ? 0 : Number(m[2]);
    if(h<0||h>23||mm<0||mm>59) return null;
    return h*60+mm;
  }
  if(/^\d{3,4}$/.test(s)){
    const n = Number(s);
    const h = Math.floor(n/100);
    const mm = n%100;
    if(h<0||h>23||mm<0||mm>59) return null;
    return h*60+mm;
  }
  return null;
};

function classNames(...xs){ return xs.filter(Boolean).join(" "); }

/**********************
 * monitor settings
 **********************/
const MONITOR_SETTINGS_KEY = "ismkaikan_monitor_settings_v1";
const MONITOR_VIEW_KEY = "ismkaikan_monitor_view_v1";
const DEFAULT_MONITOR_SETTINGS = { startHHMM:"08:00", endHHMM:"20:00", autoPage:true, intervalSec:12, roomsPerPage:"auto" };

function loadMonitorSettings(){
  try{
    const raw = localStorage.getItem(MONITOR_SETTINGS_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj) return null;
    return {
      startHHMM: String(obj.startHHMM || DEFAULT_MONITOR_SETTINGS.startHHMM),
      endHHMM: String(obj.endHHMM || DEFAULT_MONITOR_SETTINGS.endHHMM),
      autoPage: obj.autoPage !== false,
      intervalSec: Number(obj.intervalSec || DEFAULT_MONITOR_SETTINGS.intervalSec),
      roomsPerPage: String(obj.roomsPerPage || DEFAULT_MONITOR_SETTINGS.roomsPerPage),
    };
  }catch(e){ return null; }
}
function saveMonitorSettingsLocal(obj){
  try{ localStorage.setItem(MONITOR_SETTINGS_KEY, JSON.stringify(obj)); }catch(e){}
}
function loadMonitorView(){
  try{ return localStorage.getItem(MONITOR_VIEW_KEY) || "timeline"; }catch(e){ return "timeline"; }
}
function saveMonitorView(v){
  try{ localStorage.setItem(MONITOR_VIEW_KEY, String(v||"timeline")); }catch(e){}
}

/**********************
 * Auto refresh & revision
 **********************/
const AUTO_REFRESH_KEY = "ismkaikan_auto_refresh_v1";
const LAST_REV_KEY = "ismkaikan_last_rev_v1";
function loadAutoRefresh(){ try{ const raw = localStorage.getItem(AUTO_REFRESH_KEY); if(raw==null) return true; return raw==="1"; }catch(e){ return true; } }
function saveAutoRefreshLocal(v){ try{ localStorage.setItem(AUTO_REFRESH_KEY, v ? "1" : "0"); }catch(e){} }
function loadLastRev(){ try{ const raw=localStorage.getItem(LAST_REV_KEY); if(raw==null||raw==="") return null; return String(raw);}catch(e){return null;} }
function saveLastRevLocal(v){ try{ if(v==null) localStorage.removeItem(LAST_REV_KEY); else localStorage.setItem(LAST_REV_KEY,String(v)); }catch(e){} }

/**********************
 * cache + ops
 **********************/
function saveCache(key, value){ try{ localStorage.setItem(key, JSON.stringify({ at: Date.now(), value })); }catch(e){} }
function loadCache(key){ try{ const raw=localStorage.getItem(key); if(!raw) return null; const obj=JSON.parse(raw); return obj?.value ?? null; }catch(e){ return null; } }
function clearCachePrefix(prefix){
  try{
    const ks=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && String(k).startsWith(prefix)) ks.push(k);
    }
    ks.forEach(k=>{ try{ localStorage.removeItem(k);}catch(e){} });
  }catch(e){}
}

function loadOps(){
  const mk = monthKeyLocal();
  try{
    const raw = localStorage.getItem(OPS_KEY);
    if(!raw) return { month: mk, reads: 0, writes: 0 };
    const obj = JSON.parse(raw);
    if(obj?.month !== mk) return { month: mk, reads: 0, writes: 0 };
    return { month: mk, reads: Number(obj.reads||0), writes: Number(obj.writes||0) };
  }catch(e){ return { month: mk, reads: 0, writes: 0 }; }
}
function saveOps(ops){ try{ localStorage.setItem(OPS_KEY, JSON.stringify(ops)); }catch(e){} }

/**********************
 * deterministic id for import
 **********************/
function fnv1a32(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return h >>> 0;
}
function deterministicIdForReservation(m){
  const base = `${m.date}|${m.roomId}|${m.startMin}|${m.endMin}|${String(m.groupName||"").trim()}`;
  return `imp_${fnv1a32(base).toString(36)}`;
}

async function touchRevisionDoc(reason){
  try{
    await db.collection("meta").doc("revision").set({
      rev: firebase.firestore.FieldValue.increment(1),
      updatedAt: serverTimestamp(),
      reason: String(reason||"").slice(0, 60),
    }, { merge:true });
  }catch(e){ console.warn("touchRevisionDoc failed", e); }
}

/**********************
 * UI primitives
 **********************/
const Pill = ({children, tone="slate"}) => {
  const map = {
    slate: "bg-slate-100 text-slate-700 border-slate-200",
    sky: "bg-sky-50 text-sky-700 border-sky-200",
    emerald: "bg-emerald-50 text-emerald-700 border-emerald-200",
    rose: "bg-rose-50 text-rose-700 border-rose-200",
    amber: "bg-amber-50 text-amber-700 border-amber-200",
    violet: "bg-violet-50 text-violet-700 border-violet-200",
  };
  return (
    <span className={classNames("inline-flex items-center gap-1 px-2 py-1 rounded-xl text-[12px] font-black border", map[tone]||map.slate)}>
      {children}
    </span>
  );
};

const Card = ({children, printCard=false}) => (
  <div className={classNames("bg-white rounded-3xl p-4 shadow-sm border border-slate-100", printCard ? "print-card" : "")}>
    {children}
  </div>
);

const SectionTitle = ({icon, title, sub, right}) => (
  <div className="flex items-end justify-between gap-2 flex-wrap">
    <div className="space-y-1">
      <div className="flex items-center gap-2">
        <div className="w-9 h-9 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-700 font-black">
          {icon}
        </div>
        <div className="text-lg font-black text-slate-800">{title}</div>
      </div>
      {sub ? <div className="text-xs font-bold text-slate-400">{sub}</div> : null}
    </div>
    {right ? <div className="flex items-center gap-2">{right}</div> : null}
  </div>
);

function TabButton({active, onClick, children}){
  return (
    <button
      onClick={onClick}
      className={classNames(
        "rounded-2xl py-3 font-black border shadow-sm",
        active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200"
      )}
    >
      {children}
    </button>
  );
}

const Modal = ({open, onClose, title, children}) => {
  if(!open) return null;
  return (
    <div className="fixed inset-0 z-50 no-print">
      <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
      <div className="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-3">
        <div className="w-full md:max-w-4xl bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
          <div className="p-4 border-b border-slate-100 flex items-center justify-between">
            <div className="font-black text-slate-800">{title}</div>
            <button className="px-3 py-2 rounded-2xl bg-slate-100 font-black text-slate-700" onClick={onClose}>閉じる</button>
          </div>
          <div className="p-4 space-y-4">
            {children}
          </div>
        </div>
      </div>
    </div>
  );
};

/**********************
 * Main App
 **********************/
function App(){
  const [tab, setTab] = useState("dashboard");
  const [selectedDate, setSelectedDate] = useState(todayKeyLocal());
  const [monitorDate, setMonitorDate] = useState(todayKeyLocal());

  const [monthCursor, setMonthCursor] = useState(() => monthKeyFromDateKey(todayKeyLocal()));
  const [monthReservations, setMonthReservations] = useState([]);
  const [monthBusy, setMonthBusy] = useState(false);

  const [monitorSettings, setMonitorSettings] = useState(() => loadMonitorSettings() || DEFAULT_MONITOR_SETTINGS);
  const [monitorDraft, setMonitorDraft] = useState(() => loadMonitorSettings() || DEFAULT_MONITOR_SETTINGS);
  const [monitorView, setMonitorView] = useState(() => loadMonitorView());

  // 年間予定：団体名（完全一致） + 部屋
  const [yearGroupExact, setYearGroupExact] = useState("");
  const [yearRoomFilter, setYearRoomFilter] = useState("all");

  const [importOpen, setImportOpen] = useState(false);
  const [importText, setImportText] = useState("");
  const [importPreview, setImportPreview] = useState(null);
  const [importBusy, setImportBusy] = useState(false);

  const [user, setUser] = useState(null);
  const [authReady, setAuthReady] = useState(false);
  const isLoggedIn = !!user;

  const [busy, setBusy] = useState(false);
  const [toast, setToast] = useState(null);

  const [rooms, setRooms] = useState(DEFAULT_ROOMS);
  const [equipments, setEquipments] = useState(DEFAULT_EQUIPMENTS);

  // 団体マスタ（最大100）
  const [groups, setGroups] = useState([]);

  const [dayReservations, setDayReservations] = useState([]);
  const [monitorReservations, setMonitorReservations] = useState([]);

  const [weekStart, setWeekStart] = useState(startOfWeekSunday(selectedDate));
  const [weekReservations, setWeekReservations] = useState([]);
  const [yearReservations, setYearReservations] = useState([]);
  const [yearBusy, setYearBusy] = useState(false);

  const [editorOpen, setEditorOpen] = useState(false);
  const [editModel, setEditModel] = useState(null);

  const [ops, setOps] = useState(loadOps());
  useEffect(()=>{ saveOps(ops); }, [ops]);

  const [autoRefresh, setAutoRefresh] = useState(() => loadAutoRefresh());
  useEffect(() => { saveAutoRefreshLocal(autoRefresh); }, [autoRefresh]);

  const [lastRev, setLastRev] = useState(() => loadLastRev());
  const lastRevRef = useRef(lastRev);
  useEffect(() => { lastRevRef.current = lastRev; saveLastRevLocal(lastRev); }, [lastRev]);
  const [lastCheckAt, setLastCheckAt] = useState(null);
  const [lastChangeAt, setLastChangeAt] = useState(null);

  // スタッフ予定（ログイン時のみ）
  const [staffDate, setStaffDate] = useState(todayKeyLocal());
  const [staffBusy, setStaffBusy] = useState(false);
  const [staffData, setStaffData] = useState({
    chief: { morning:"", afternoon:"", evening:"", note:"" },
    deputy:{ morning:"", afternoon:"", evening:"", note:"" },
  });

  useEffect(() => {
    const cache = loadCache(`${CACHE_PREFIX}:month:${monthCursor}`);
    if(cache) setMonthReservations(cache);
  }, [monthCursor]);

  useEffect(() => { setMonitorDraft(monitorSettings); }, [monitorSettings]);

  function bumpReads(n){
    const mk = monthKeyLocal();
    setOps(prev => {
      const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
      return { ...base, reads: base.reads + Number(n||0) };
    });
  }
  function bumpWrites(n){
    const mk = monthKeyLocal();
    setOps(prev => {
      const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
      return { ...base, writes: base.writes + Number(n||0) };
    });
  }
  function resetOps(){
    const mk = monthKeyLocal();
    if(!confirm(`${mk} の read/write（概算）をリセットしますか？`)) return;
    setOps({ month: mk, reads: 0, writes: 0 });
  }

  const roomsActive = useMemo(() =>
    (rooms||[])
      .filter(r => r.active !== false)
      .slice()
      .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.building||"").localeCompare(String(b.building||"")) || String(a.name||"").localeCompare(String(b.name||"")))
  , [rooms]);

  const roomsMap = useMemo(() => {
    const m = {};
    for(const r of rooms||[]) m[r.id] = r;
    return m;
  }, [rooms]);

  const equipmentsActive = useMemo(() =>
    (equipments||[])
      .filter(e => e.active !== false)
      .slice()
      .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
  , [equipments]);

  const equipmentsMap = useMemo(() => {
    const m = {};
    for(const e of equipments||[]) m[e.id] = e;
    return m;
  }, [equipments]);

  const roomName = (id) => roomsMap[id]?.name ?? id;
  const roomBuilding = (id) => roomsMap[id]?.building ?? "";

  const activeGroupNames = useMemo(() => {
    return (groups||[])
      .filter(g => g.active !== false)
      .slice()
      .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
      .map(g => String(g.name||"").trim())
      .filter(Boolean);
  }, [groups]);

  const blankEquipment = (base={}) => {
    const out = {};
    for(const e of equipmentsActive){
      out[e.id] = Math.max(0, Math.min(999, Number(base?.[e.id] ?? 0) || 0));
    }
    return out;
  };

  const dayEquipmentUsed = useMemo(() => {
    const used = {};
    for(const e of equipmentsActive) used[e.id] = 0;
    for(const r of dayReservations){
      const eq = r?.equipment || {};
      for(const e of equipmentsActive){
        used[e.id] += Number(eq?.[e.id] ?? 0);
      }
    }
    return used;
  }, [dayReservations, equipmentsActive]);

  useEffect(() => {
    const unsub = auth.onAuthStateChanged(u => { setUser(u||null); setAuthReady(true); });
    return () => unsub && unsub();
  }, []);

  useEffect(() => { setWeekStart(startOfWeekSunday(selectedDate)); }, [selectedDate]);

  // Load caches on mount
  useEffect(() => {
    const rCache = loadCache(`${CACHE_PREFIX}:rooms`);
    const eCache = loadCache(`${CACHE_PREFIX}:equipments`);
    const gCache = loadCache(`${CACHE_PREFIX}:groups`);
    const dCache = loadCache(`${CACHE_PREFIX}:reservations:${selectedDate}`);
    const mCache = loadCache(`${CACHE_PREFIX}:monitor:${monitorDate}`);
    const moCache = loadCache(`${CACHE_PREFIX}:month:${monthCursor}`);
    const yCache = loadCache(`${CACHE_PREFIX}:year:${monthKeyFromDateKey(selectedDate).slice(0,4)}`);

    if(rCache?.length) setRooms(rCache);
    if(eCache?.length) setEquipments(eCache);
    if(gCache?.length) setGroups(gCache);
    if(dCache) setDayReservations(dCache);
    if(mCache) setMonitorReservations(mCache);
    if(moCache) setMonthReservations(moCache);
    if(yCache) setYearReservations(yCache);

    const ms = loadMonitorSettings();
    if(ms) { setMonitorSettings(ms); setMonitorDraft(ms); }
    const mv = loadMonitorView();
    if(mv) setMonitorView(mv);
  }, []);

  useEffect(() => {
    const dCache = loadCache(`${CACHE_PREFIX}:reservations:${selectedDate}`);
    if(dCache) setDayReservations(dCache);
  }, [selectedDate]);

  useEffect(() => {
    const mCache = loadCache(`${CACHE_PREFIX}:monitor:${monitorDate}`);
    if(mCache) setMonitorReservations(mCache);
  }, [monitorDate]);

  async function loginWithShared(password){
    setBusy(true);
    try{
      await auth.signInWithEmailAndPassword(SHARED_EMAIL, password);
      setToast({ type:"ok", msg:"ログインしました（編集できます）" });
    }catch(err){
      console.error(err);
      setToast({ type:"ng", msg:"ログインできません（PWが違う/ユーザー未作成）" });
    }finally{
      setBusy(false);
      setTimeout(()=>setToast(null), 2600);
    }
  }
  async function logout(){
    await auth.signOut();
    setToast({ type:"ok", msg:"ログアウトしました" });
    setTimeout(()=>setToast(null), 2000);
    // 念のためスタッフタブは閉じる
    if(tab==="staff") setTab("dashboard");
  }

  async function refreshMasters(opts={}){
    const silent = !!opts.silent;
    if(!silent) setBusy(true);
    let usedFallback = false;
    try{
      async function getList(col, fallback, cacheKey){
        try{
          const snap = await db.collection(col).get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          if(list.length){
            saveCache(`${CACHE_PREFIX}:${cacheKey}`, list);
            return list;
          }
          saveCache(`${CACHE_PREFIX}:${cacheKey}`, fallback);
          return fallback;
        }catch(err){
          usedFallback = true;
          const cached = loadCache(`${CACHE_PREFIX}:${cacheKey}`);
          if(cached && Array.isArray(cached) && cached.length) return cached;
          return fallback;
        }
      }

      const roomsList = await getList("rooms", DEFAULT_ROOMS, "rooms");
      const eqList = await getList("equipments", DEFAULT_EQUIPMENTS, "equipments");
      // groups は最大100想定。空なら空配列でOK（fallback = []）
      const gList = await getList("groups", [], "groups");

      setRooms(roomsList);
      setEquipments(eqList);
      setGroups(gList);

      if(!silent){
        setToast({ type:"ok", msg: usedFallback ? "マスタ更新：キャッシュ/初期値を使用しました" : "マスタを更新しました" });
      }
    }catch(err){
      console.error(err);
      if(!silent) setToast({ type:"ng", msg:"マスタ更新に失敗しました" });
    }finally{
      if(!silent){
        setBusy(false);
        setTimeout(()=>setToast(null), 2200);
      }
    }
  }

  async function refreshDay(dateKey, opts={}){
    const silent = !!opts.silent;
    if(!silent) setBusy(true);
    try{
      const snap = await db.collection("reservations").where("date","==",dateKey).get();
      bumpReads(snap.size);
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b)=>(String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
      setDayReservations(list);
      saveCache(`${CACHE_PREFIX}:reservations:${dateKey}`, list);
      if(!silent) setToast({ type:"ok", msg:"更新しました" });
    }catch(err){
      console.error(err);
      if(!silent) setToast({ type:"ng", msg:"更新に失敗しました" });
    }finally{
      if(!silent){
        setBusy(false);
        setTimeout(()=>setToast(null), 2000);
      }
    }
  }

  async function refreshMonitor(dateKey, opts={}){
    const silent = !!opts.silent;
    if(!silent) setBusy(true);
    try{
      const snap = await db.collection("reservations").where("date","==",dateKey).get();
      bumpReads(snap.size);
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b)=>(String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
      setMonitorReservations(list);
      saveCache(`${CACHE_PREFIX}:monitor:${dateKey}`, list);
      if(!silent) setToast({ type:"ok", msg:"モニターを更新しました" });
    }catch(err){
      console.error(err);
      if(!silent) setToast({ type:"ng", msg:"更新に失敗しました" });
    }finally{
      if(!silent){
        setBusy(false);
        setTimeout(()=>setToast(null), 2000);
      }
    }
  }

  async function refreshWeek(startKey, opts={}){
    const silent = !!opts.silent;
    if(!silent) setBusy(true);
    try{
      const endKey = addDaysKey(startKey, 6);
      const snap = await db.collection("reservations")
        .where("date", ">=", startKey)
        .where("date", "<=", endKey)
        .get();
      bumpReads(snap.size);
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
      setWeekReservations(list);
      saveCache(`${CACHE_PREFIX}:week:${startKey}`, list);
      if(!silent) setToast({ type:"ok", msg:"週を更新しました" });
    }catch(err){
      console.error(err);
      if(!silent) setToast({ type:"ng", msg:"週の更新に失敗しました" });
    }finally{
      if(!silent){
        setBusy(false);
        setTimeout(()=>setToast(null), 2000);
      }
    }
  }

  async function refreshMonth(monthKey, opts={}){
    const silent = !!opts.silent;
    if(!silent) setMonthBusy(true);
    try{
      const start = startOfMonthKey(monthKey);
      const end = endOfMonthKey(monthKey);
      const snap = await db.collection("reservations")
        .where("date", ">=", start)
        .where("date", "<=", end)
        .get();
      bumpReads(snap.size);
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||""))));
      setMonthReservations(list);
      saveCache(`${CACHE_PREFIX}:month:${monthKey}`, list);
      if(!silent){
        setToast({ type:"ok", msg:"月予定を更新しました" });
        setTimeout(()=>setToast(null), 1800);
      }
    }catch(err){
      console.error(err);
      if(!silent){
        setToast({ type:"ng", msg:"月予定の更新に失敗しました" });
        setTimeout(()=>setToast(null), 2400);
      }
    }finally{
      if(!silent) setMonthBusy(false);
    }
  }

  async function refreshYear(opts={}){
    const silent = !!opts.silent;
    if(!silent) setYearBusy(true);
    try{
      const fy = (()=>{
        const d = parseKeyToDate(selectedDate);
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        return (m>=4) ? y : (y-1);
      })();
      const start = `${fy}-04-01`;
      const end = `${fy+1}-03-31`;

      const snap = await db.collection("reservations")
        .where("date", ">=", start)
        .where("date", "<=", end)
        .get();
      bumpReads(snap.size);
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
      setYearReservations(list);
      saveCache(`${CACHE_PREFIX}:year:${fy}`, list);
      if(!silent){
        setToast({ type:"ok", msg:"年度一覧を更新しました" });
        setTimeout(()=>setToast(null), 1800);
      }
    }catch(err){
      console.error(err);
      if(!silent){
        setToast({ type:"ng", msg:"年度一覧の取得に失敗しました" });
        setTimeout(()=>setToast(null), 2400);
      }
    }finally{
      if(!silent) setYearBusy(false);
    }
  }

  async function refreshStaff(dateKey, opts={}){
    if(!isLoggedIn) return;
    const silent = !!opts.silent;
    if(!silent) setStaffBusy(true);
    try{
      const ids = [`${dateKey}_chief`, `${dateKey}_deputy`];
      const snaps = await Promise.all(ids.map(id => db.collection("staffSchedules").doc(id).get()));
      bumpReads(snaps.length);
      const next = { chief:{morning:"",afternoon:"",evening:"",note:""}, deputy:{morning:"",afternoon:"",evening:"",note:""} };
      snaps.forEach((s, idx) => {
        if(!s.exists) return;
        const d = s.data()||{};
        const role = (idx===0) ? "chief" : "deputy";
        next[role] = {
          morning: String(d.morning||""),
          afternoon: String(d.afternoon||""),
          evening: String(d.evening||""),
          note: String(d.note||""),
        };
      });
      setStaffData(next);
      saveCache(`${CACHE_PREFIX}:staff:${dateKey}`, next);
      if(!silent){
        setToast({type:"ok", msg:"書記予定を更新しました"});
        setTimeout(()=>setToast(null), 1600);
      }
    }catch(e){
      console.error(e);
      if(!silent){
        setToast({type:"ng", msg:"書記予定の取得に失敗しました"});
        setTimeout(()=>setToast(null), 2200);
      }
    }finally{
      if(!silent) setStaffBusy(false);
    }
  }

  async function refreshAllSilent(){
    await refreshMasters({ silent:true });
    await refreshDay(selectedDate, { silent:true });
    await refreshMonitor(monitorDate, { silent:true });
    await refreshWeek(weekStart, { silent:true });
    await refreshMonth(monthCursor, { silent:true });
    await refreshYear({ silent:true });
    if(isLoggedIn) await refreshStaff(staffDate, { silent:true });
  }

  async function smartRefresh(opts={}){
    const silent = !!opts.silent;
    const scope = String(opts.scope || 'current');
    if(!authReady) return false;
    if(busy || monthBusy || yearBusy || importBusy || staffBusy) return false;
    try{
      setLastCheckAt(Date.now());

      async function probeLatestUpdatedMsSafe(col){
        try{
          const qs = await db.collection(col).orderBy('updatedAt','desc').limit(1).get();
          if(qs.empty) return 0;
          const d = qs.docs[0].data() || {};
          const u = d.updatedAt;
          const ms = (u && typeof u.toMillis === 'function') ? u.toMillis() : (typeof u === 'number' ? u : 0);
          return Number(ms || 0);
        }catch(err){
          const code = err?.code || '';
          const msg = String(err?.message || '');
          if(code === 'permission-denied' || /permission[- ]denied/i.test(msg)) return null;
          throw err;
        }
      }

      let token = null;
      let changeMs = null;

      try{
        const snap = await db.collection('meta').doc('revision').get();
        const rev = snap.exists ? Number((snap.data()||{}).rev || 0) : 0;
        const updatedAt = snap.exists ? (snap.data()||{}).updatedAt : null;
        const updatedMs = (updatedAt && typeof updatedAt.toMillis === 'function') ? updatedAt.toMillis() : null;
        token = `rev:${rev}`;
        changeMs = updatedMs || null;
      }catch(e){
        const wantRes = (scope !== 'masters');
        const wantMasters = (scope === 'masters' || scope === 'all');
        const rMs = wantRes ? (await probeLatestUpdatedMsSafe('reservations')) : null;
        const roomsMs = wantMasters ? (await probeLatestUpdatedMsSafe('rooms')) : null;
        const eqMs = wantMasters ? (await probeLatestUpdatedMsSafe('equipments')) : null;
        const gMs = wantMasters ? (await probeLatestUpdatedMsSafe('groups')) : null;
        const sMs = (scope === 'staff' || scope === 'all') ? (await probeLatestUpdatedMsSafe('staffSchedules')) : null;
        const rr = Number(rMs||0);
        const rm = Number(roomsMs||0);
        const em = Number(eqMs||0);
        const gm = Number(gMs||0);
        const sm = Number(sMs||0);
        token = `probe:${rr}:${rm}:${em}:${gm}:${sm}`;
        changeMs = Math.max(rr, rm, em, gm, sm);
      }

      const prev = (lastRevRef.current == null) ? null : String(lastRevRef.current);

      async function refreshByScope(){
        if(scope === 'all'){
          await refreshAllSilent();
        }else if(scope === 'masters'){
          await refreshMasters({ silent:true });
        }else if(scope === 'monitor'){
          await refreshMonitor(monitorDate, { silent:true });
        }else if(scope === 'week'){
          await refreshWeek(weekStart, { silent:true });
        }else if(scope === 'month'){
          await refreshMonth(monthCursor, { silent:true });
        }else if(scope === 'year'){
          await refreshYear({ silent:true });
        }else if(scope === 'staff'){
          await refreshStaff(staffDate, { silent:true });
        }else{
          await refreshDay(selectedDate, { silent:true });
        }
      }

      if(prev == null){
        setLastRev(token);
        if(changeMs) setLastChangeAt(changeMs);
        if(!silent){
          await refreshByScope();
          setToast({ type:'ok', msg:'更新しました' });
          setTimeout(()=>setToast(null), 1500);
          return true;
        }
        return false;
      }

      if(token === prev){
        if(!silent){
          setToast({ type:'ok', msg:'変更なし（取得しません）' });
          setTimeout(()=>setToast(null), 1200);
        }
        return false;
      }

      setLastRev(token);
      if(changeMs) setLastChangeAt(changeMs);

      await refreshByScope();

      if(!silent){
        setToast({ type:'ok', msg:'更新しました' });
        setTimeout(()=>setToast(null), 1500);
      }
      return true;
    }catch(err){
      console.error(err);
      if(!silent){
        const detail = err?.code || err?.message || '';
        const s = String(detail || '').replace(/\s+/g,' ').slice(0, 60);
        setToast({ type:'ng', msg: '更新に失敗しました' + (s ? `（${s}）` : '') });
        setTimeout(()=>setToast(null), 2800);
      }
      return false;
    }
  }

  function openNew(){
    const firstRoom = roomsActive[0]?.id || DEFAULT_ROOMS[0].id;
    setEditModel({
      id: null,
      date: selectedDate,
      roomId: firstRoom,
      startMin: hhmmToMin("09:00"),
      endMin: hhmmToMin("10:00"),
      groupName: "",
      note: "",
      equipment: blankEquipment({}),
    });
    setEditorOpen(true);
  }

  function openNewForDate(dk){
    const firstRoom = roomsActive[0]?.id || DEFAULT_ROOMS[0].id;
    const dateKey = dk || selectedDate;
    setSelectedDate(dateKey);
    setEditModel({
      id: null,
      date: dateKey,
      roomId: firstRoom,
      startMin: hhmmToMin("09:00"),
      endMin: hhmmToMin("10:00"),
      groupName: "",
      note: "",
      equipment: blankEquipment({}),
    });
    setEditorOpen(true);
  }

  function openEdit(r){
    setEditModel({
      id: r.id,
      date: r.date,
      roomId: r.roomId,
      startMin: Number(r.startMin||0),
      endMin: Number(r.endMin||0),
      groupName: r.groupName || "",
      note: r.note || "",
      equipment: blankEquipment(r.equipment || {}),
    });
    setEditorOpen(true);
  }

  async function saveReservation(model){
    if(!isLoggedIn){
      setToast({ type:"ng", msg:"編集にはログインが必要です" });
      setTimeout(()=>setToast(null), 2200);
      return;
    }
    const g = (model.groupName||"").trim();
    if(!g){
      setToast({ type:"ng", msg:"団体名は必須です" });
      setTimeout(()=>setToast(null), 2200);
      return;
    }
    if(!isValidDateKey(model.date)){
      setToast({ type:"ng", msg:"日付が不正です" });
      setTimeout(()=>setToast(null), 2200);
      return;
    }
    const sMin = Number(model.startMin);
    const eMin = Number(model.endMin);
    if(!(eMin > sMin)){
      setToast({ type:"ng", msg:"終了時刻は開始時刻より後にしてください" });
      setTimeout(()=>setToast(null), 2200);
      return;
    }

    setBusy(true);
    try{
      const sameSnap = await db.collection("reservations").where("date","==",model.date).get();
      bumpReads(sameSnap.size);
      const sameDate = sameSnap.docs.map(d => ({ id:d.id, ...d.data() }));

      const sameRoom = sameDate.filter(x => x.roomId === model.roomId && x.id !== model.id);
      const conflict = sameRoom.some(x => overlaps(sMin,eMin, Number(x.startMin||0), Number(x.endMin||0)));
      if(conflict){
        setToast({ type:"ng", msg:"同じ部屋で時間が重複しています（予約不可）" });
        setTimeout(()=>setToast(null), 2800);
        return;
      }

      const overlapsAny = sameDate
        .filter(x => x.id !== model.id)
        .filter(x => overlaps(sMin,eMin, Number(x.startMin||0), Number(x.endMin||0)));

      const need = blankEquipment(model.equipment || {});
      const used = {};
      for(const e of equipmentsActive) used[e.id] = 0;

      for(const r of overlapsAny){
        const eq = r?.equipment || {};
        for(const e of equipmentsActive){
          used[e.id] += Number(eq?.[e.id] ?? 0);
        }
      }

      const warnings = [];
      for(const e of equipmentsActive){
        const total = Number(e.countTotal ?? 0) || 0;
        const after = used[e.id] + (need[e.id]||0);
        if(total > 0 && after > total){
          warnings.push(`${e.name}が総数 ${total} を超えます（同時間帯 合計 ${after}）`);
        }
      }
      if(warnings.length){
        const ok = confirm(`【機材の警告】\n${warnings.join("\n")}\n\nそれでも保存しますか？`);
        if(!ok) return;
      }

      const payload = {
        date: model.date,
        roomId: model.roomId,
        startMin: sMin,
        endMin: eMin,
        groupName: g,
        note: (model.note||"").trim(),
        equipment: need,
        updatedAt: serverTimestamp(),
      };

      if(model.id){
        await db.collection("reservations").doc(model.id).set(payload, { merge:true });
        bumpWrites(1);
      }else{
        await db.collection("reservations").add({ ...payload, createdAt: serverTimestamp() });
        bumpWrites(1);
      }

      await touchRevisionDoc("reservation");

      setEditorOpen(false);
      setEditModel(null);

      await refreshDay(selectedDate, { silent:true });
      if(tab === "monitor") await refreshMonitor(monitorDate, { silent:true });
      if(tab === "week") await refreshWeek(weekStart, { silent:true });
      if(tab === "month") await refreshMonth(monthCursor, { silent:true });
      if(tab === "year") await refreshYear({ silent:true });

      setToast({ type:"ok", msg:"保存しました" });
      setTimeout(()=>setToast(null), 1500);
    }catch(err){
      console.error(err);
      setToast({ type:"ng", msg:"保存に失敗しました" });
      setTimeout(()=>setToast(null), 2400);
    }finally{
      setBusy(false);
    }
  }

  async function deleteReservation(id){
    if(!isLoggedIn) return;
    if(!confirm("この予約を削除しますか？")) return;
    setBusy(true);
    try{
      await db.collection("reservations").doc(id).delete();
      bumpWrites(1);
      await touchRevisionDoc("reservation_delete");
      await refreshDay(selectedDate, { silent:true });
      if(tab === "monitor") await refreshMonitor(monitorDate, { silent:true });
      if(tab === "week") await refreshWeek(weekStart, { silent:true });
      if(tab === "month") await refreshMonth(monthCursor, { silent:true });
      if(tab === "year") await refreshYear({ silent:true });
    }catch(err){
      console.error(err);
      setToast({ type:"ng", msg:"削除に失敗しました" });
      setTimeout(()=>setToast(null), 2400);
    }finally{
      setBusy(false);
    }
  }

  async function deleteAllReservations(){
    if(!isLoggedIn) return;
    const ok1 = confirm('【危険】全ての予定（予約）を削除します。よろしいですか？');
    if(!ok1) return;
    const ok2 = confirm('最終確認：本当に全削除しますか？（元に戻せません）');
    if(!ok2) return;
    setBusy(true);
    try{
      let total = 0;
      while(true){
        const snap = await db.collection('reservations').limit(420).get();
        bumpReads(snap.size);
        if(snap.empty) break;
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        bumpWrites(snap.size);
        total += snap.size;
        if(snap.size < 420) break;
      }
      await touchRevisionDoc("reservation_delete_all");

      clearCachePrefix(`${CACHE_PREFIX}:reservations:`);
      clearCachePrefix(`${CACHE_PREFIX}:monitor:`);
      clearCachePrefix(`${CACHE_PREFIX}:week:`);
      clearCachePrefix(`${CACHE_PREFIX}:month:`);
      clearCachePrefix(`${CACHE_PREFIX}:year:`);
      setDayReservations([]);
      setMonitorReservations([]);
      setWeekReservations([]);
      setMonthReservations([]);
      setYearReservations([]);

      setToast({ type:'ok', msg:`全予定を削除しました（${total}件）` });
      setTimeout(()=>setToast(null), 3200);
    }catch(err){
      console.error(err);
      setToast({ type:'ng', msg:'全削除に失敗しました' });
      setTimeout(()=>setToast(null), 3200);
    }finally{
      setBusy(false);
    }
  }

  function doPrint(){
    setTimeout(()=>window.print(), 120);
  }

  // 追加：日誌印刷（A4縦・1枚想定：別ウィンドウで印刷）
  function printDailyLog(){
    const dk = selectedDate;
    const dt = parseKeyToDate(dk);
    const w = ["日","月","火","水","木","金","土"][dt.getDay()];
    const title = `夷隅教育会館 日誌（${dk} ${w}）`;
    const rows = [];
    const roomOrder = roomsActive.slice();
    roomOrder.forEach(room => {
      const list = (dayReservations||[])
        .filter(r=>r.roomId===room.id)
        .slice()
        .sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
      list.forEach(r=>{
        const eqText = equipmentsActive
          .filter(e=>Number(r?.equipment?.[e.id]||0)>0)
          .map(e=>`${e.abbr||e.name}:${Number(r.equipment[e.id]||0)}`)
          .join(" / ");
        rows.push({
          time: `${minToHHMM(r.startMin||0)}–${minToHHMM(r.endMin||0)}`,
          room: `${room.building ? room.building + " / " : ""}${room.name}`,
          group: String(r.groupName||""),
          eq: eqText || "—",
          note: String(r.note||"") || "—",
        });
      });
    });

    const html = `
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${escapeHtml(title)}</title>
<style>
  @page{ size:A4 portrait; margin:12mm; }
  body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; color:#0f172a; }
  .h1{ font-weight:900; font-size:16px; margin:0 0 8px; }
  .meta{ font-size:12px; font-weight:700; color:#334155; margin-bottom:10px; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid #cbd5e1; padding:6px 7px; vertical-align:top; }
  th{ background:#f1f5f9; font-size:11px; text-align:left; }
  td{ font-size:11px; }
  .small{ font-size:10px; color:#475569; font-weight:700; margin-top:10px; }
</style>
</head>
<body>
  <div class="h1">夷隅教育会館　日誌</div>
  <div class="meta">日付：${escapeHtml(dk)}（${escapeHtml(w)}）</div>

  <table>
    <thead>
      <tr>
        <th style="width:14%;">時間</th>
        <th style="width:18%;">部屋</th>
        <th style="width:22%;">団体</th>
        <th style="width:16%;">機材</th>
        <th>備考</th>
      </tr>
    </thead>
    <tbody>
      ${rows.length ? rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.room)}</td>
          <td>${escapeHtml(r.group)}</td>
          <td>${escapeHtml(r.eq)}</td>
          <td>${escapeHtml(r.note)}</td>
        </tr>
      `).join("") : `<tr><td colspan="5">予定なし</td></tr>`}
    </tbody>
  </table>

  <div class="small">※本紙は保管用（日予定→「日誌印刷」で生成）</div>
  <script>window.onload=()=>{ setTimeout(()=>window.print(), 150); }<\/script>
</body>
</html>`;
    const win = window.open("", "_blank");
    if(!win){
      alert("ポップアップがブロックされました。ブラウザ設定をご確認ください。");
      return;
    }
    win.document.open();
    win.document.write(html);
    win.document.close();
  }

  function escapeHtml(s){
    return String(s??"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // Auto refresh every minute (silent)
  const autoRefreshingRef = useRef(false);
  useEffect(() => {
    if(!authReady) return;
    if(!autoRefresh) return;

    const tick = async () => {
      if(autoRefreshingRef.current) return;
      if(busy || monthBusy || yearBusy || importBusy || staffBusy) return;
      autoRefreshingRef.current = true;
      try{
        await smartRefresh({ silent:true, scope:'all' });
      }catch(e){ console.error(e); }
      finally{ autoRefreshingRef.current = false; }
    };

    const id = setInterval(tick, 60*1000);
    tick();
    return () => clearInterval(id);
  }, [authReady, autoRefresh, selectedDate, monitorDate, weekStart, monthCursor, staffDate, busy, monthBusy, yearBusy, importBusy, staffBusy]);

  const fyInfo = useMemo(() => {
    const d = parseKeyToDate(selectedDate);
    const y = d.getFullYear();
    const m = d.getMonth()+1;
    const fy = (m>=4) ? y : (y-1);
    return { fy, start: `${fy}-04-01`, end: `${fy+1}-03-31`, label: `${fy}年度` };
  }, [selectedDate]);

  // 年度：月ボタン並び（4月→3月）
  const fyMonthsOrdered = useMemo(() => {
    const arr = [];
    for(let m=4; m<=12; m++) arr.push(`${fyInfo.fy}-${pad2(m)}`);
    for(let m=1; m<=3; m++) arr.push(`${fyInfo.fy+1}-${pad2(m)}`);
    return arr;
  }, [fyInfo]);

  // 年間一括エクスポート
  function exportYearCSV(){
    const headersBase = ["日付","開始","終了","部屋","団体名","メモ"];
    const eqHeaders = equipmentsActive.map(e => (e.abbr || e.id));
    const headers = headersBase.concat(eqHeaders);

    const roomLabel = (rid) => {
      const r = roomsMap?.[rid];
      if(!r) return rid;
      const b = (r.building||"").trim();
      return b ? `${b}/${r.name}` : r.name;
    };

    const lines = [];
    lines.push(headers.map(csvEscape).join(","));

    const list = (yearReservations||[])
      .slice()
      .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||""))));

    list.forEach(r=>{
      const row = [];
      row.push(String(r.date||""));
      row.push(minToHHMM(Number(r.startMin||0)));
      row.push(minToHHMM(Number(r.endMin||0)));
      row.push(roomLabel(r.roomId));
      row.push(String(r.groupName||""));
      row.push(String(r.note||""));
      equipmentsActive.forEach(e=>{
        const n = Number(r?.equipment?.[e.id]||0);
        row.push(n ? String(n) : "");
      });
      lines.push(row.map(csvEscape).join(","));
    });

    const csv = lines.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `年間予定_${fyInfo.label}_${fyInfo.start}_to_${fyInfo.end}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setToast({type:"ok", msg:"年間一括エクスポート（CSV）を作成しました"});
    setTimeout(()=>setToast(null), 1800);
  }

  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }

  function openStaffTab(){
    if(!isLoggedIn){
      setToast({type:"ng", msg:"書記予定はログイン中のみ表示できます"});
      setTimeout(()=>setToast(null), 2200);
      return;
    }
    setTab("staff");
    // cache first
    const cached = loadCache(`${CACHE_PREFIX}:staff:${staffDate}`);
    if(cached) setStaffData(cached);
    refreshStaff(staffDate, { silent:true });
  }

  return (
    <div className="min-h-screen pb-24">
      <div className="max-w-7xl mx-auto px-4 pt-5">
        <div className="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div className="text-2xl font-black text-slate-900">夷隅教育会館 予約管理システム</div>
            <div className="text-xs font-bold text-slate-400 mt-1">部屋予約 / 掲示板 / 週・月・年度一覧 / マスタ・団体管理 / 書記予定</div>
          </div>

          <div className="flex items-center gap-2">
            <button
              className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                (busy || monthBusy || yearBusy || importBusy || staffBusy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
              disabled={busy || monthBusy || yearBusy || importBusy || staffBusy}
              onClick={() => {
                if(tab === 'rooms' || tab === 'equip' || tab === 'help') return smartRefresh({ scope:'masters' });
                if(tab === 'monitor') return smartRefresh({ scope:'monitor' });
                if(tab === 'week') return smartRefresh({ scope:'week' });
                if(tab === 'month') return smartRefresh({ scope:'month' });
                if(tab === 'year') return smartRefresh({ scope:'year' });
                if(tab === 'staff') return smartRefresh({ scope:'staff' });
                return smartRefresh({ scope:'day' });
              }}
            >
              更新
            </button>
            <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>smartRefresh({ scope:'masters' })} disabled={busy}>
              マスタ更新
            </button>
            <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={doPrint}>
              印刷
            </button>

            {isLoggedIn ? (
              <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={logout}>
                ログアウト
              </button>
            ) : (
              <LoginButton busy={busy} onLogin={loginWithShared} />
            )}
          </div>
        </div>

        <div className="mt-3 flex items-center gap-2 flex-wrap">
          <Pill tone={isLoggedIn ? "emerald" : "slate"}>{isLoggedIn ? "編集モード（ログイン中）" : "閲覧モード（ログインなし）"}</Pill>
          <Pill tone="sky">共通ID：{SHARED_LOGIN_CODE}</Pill>
          <Pill tone="violet">年度：{fyInfo.fy}（{fyInfo.start}〜{fyInfo.end}）</Pill>
          <Pill tone="amber">概算 reads：{ops.reads}</Pill>
          <Pill tone="amber">概算 writes：{ops.writes}</Pill>
          <button className="px-3 py-1.5 rounded-xl bg-white border border-slate-200 font-black text-xs text-slate-700" onClick={resetOps}>
            read/write リセット
          </button>
          {busy ? <Pill tone="amber">処理中…</Pill> : null}
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 mt-3">
        <div className="grid grid-cols-3 md:grid-cols-10 gap-2 no-print">
          <TabButton active={tab==="dashboard"} onClick={()=>setTab("dashboard")}>全体</TabButton>
          <TabButton active={tab==="monitor"} onClick={()=>{ setTab("monitor"); setMonitorDate(todayKeyLocal()); }}>掲示板</TabButton>
          <TabButton active={tab==="day"} onClick={()=>setTab("day")}>日予定</TabButton>
          <TabButton active={tab==="week"} onClick={()=>{ setTab("week"); }}>週予定</TabButton>
          <TabButton active={tab==="month"} onClick={()=>{ setMonthCursor(monthKeyFromDateKey(selectedDate)); setTab("month"); }}>月予定</TabButton>
          <TabButton active={tab==="year"} onClick={()=>{ setTab("year"); }}>年間予定</TabButton>

          {/* 追加：書記長/書記次長 予定（ログイン中のみ表示） */}
          {isLoggedIn ? (
            <TabButton active={tab==="staff"} onClick={openStaffTab}>予定</TabButton>
          ) : (
            <div className="hidden md:block"></div>
          )}

          <TabButton active={tab==="equip"} onClick={()=>setTab("equip")}>機材管理</TabButton>
          <TabButton active={tab==="rooms"} onClick={()=>setTab("rooms")}>部屋マスタ</TabButton>
          <TabButton active={tab==="help"} onClick={()=>setTab("help")}>設定</TabButton>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 mt-4 space-y-4">
        {tab === "dashboard" && (
          <div className="space-y-4">
            <Card printCard>
              <SectionTitle
                icon="🏠"
                title="今日の状況"
                sub="まずはここだけ見ればOK"
                right={isLoggedIn ? (
                  <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print" onClick={openNew}>
                    ＋予約追加
                  </button>
                ) : null}
              />

              <div className="mt-4 grid md:grid-cols-3 gap-3">
                <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="text-xs font-black text-slate-500">部屋予約（件数）</div>
                  <div className="text-3xl font-black text-slate-800 mt-1">{dayReservations.length}</div>
                  <div className="text-xs font-bold text-slate-400 mt-2">日付：{selectedDate}</div>
                </div>

                <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="text-xs font-black text-slate-500">機材使用（合計）</div>
                  <div className="mt-2 space-y-2">
                    {equipmentsActive.length === 0 ? (
                      <div className="text-xs font-bold text-slate-400">機材が未設定です</div>
                    ) : equipmentsActive.map(e => (
                      <div key={e.id} className="flex items-center justify-between">
                        <div className="font-black text-slate-800">{e.name}</div>
                        <div className="font-black text-slate-800">{dayEquipmentUsed[e.id]||0} / {(e.countTotal ?? "—")}</div>
                      </div>
                    ))}
                  </div>
                  <div className="text-xs font-bold text-slate-400 mt-2">※予約に紐づく「使用台数」の合計</div>
                </div>

                <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="text-xs font-black text-slate-500">クイック操作</div>
                  <div className="mt-3 flex flex-wrap gap-2">
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("day"); }}>
                      日予定へ
                    </button>
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("week"); }}>
                      週予定へ
                    </button>
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("year"); }}>
                      年間予定へ
                    </button>
                    {isLoggedIn ? (
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={openStaffTab}>
                        書記予定へ
                      </button>
                    ) : null}
                  </div>
                </div>
              </div>

              <div className="mt-4 flex items-center justify-between gap-2 flex-wrap">
                <div className="text-sm font-black text-slate-700">日付</div>
                <div className="flex items-center gap-2 no-print">
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(todayKeyLocal())}>今日</button>
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(addDaysKey(todayKeyLocal(),1))}>明日</button>
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(addDaysKey(todayKeyLocal(),2))}>明後日</button>
                </div>
                <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={selectedDate} onChange={(e)=>setSelectedDate(e.target.value)} />
                <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>smartRefresh({ scope:'day' })} disabled={busy}>この日を更新</button>
              </div>

              <div className="mt-4 text-sm font-black text-slate-700">部屋ごとの予約（{selectedDate}）</div>
              <div className="mt-3 grid md:grid-cols-2 gap-3">
                {roomsActive.map(room => {
                  const list = dayReservations.filter(r => r.roomId === room.id).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                  return (
                    <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                      <div className="flex items-center justify-between">
                        <div className="space-y-0.5">
                          <div className="text-xs font-black text-slate-400">{room.building}</div>
                          <div className="font-black text-slate-800">{room.name}</div>
                        </div>
                        <Pill tone="slate">{list.length}件</Pill>
                      </div>

                      <div className="mt-3 space-y-2">
                        {list.length === 0 ? (
                          <div className="text-xs font-bold text-slate-400">予約なし</div>
                        ) : list.map(r => (
                          <div key={r.id} className="flex items-start justify-between gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                            <div className="min-w-0">
                              <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                              <div className="text-xs font-bold text-slate-500 mt-1 flex gap-2 flex-wrap">
                                {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                  <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                ) : null)}
                                {r.note ? <Pill tone="slate">メモ</Pill> : null}
                              </div>
                            </div>
                            {isLoggedIn ? (
                              <div className="shrink-0 flex items-center gap-2 no-print">
                                <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                  編集
                                </button>
                              </div>
                            ) : null}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>
          </div>
        )}

        {tab === "day" && (
          <Card printCard>
            <SectionTitle
              icon="📅"
              title="日予約"
              sub="日ごとの予約一覧（重複は保存時にブロック）"
              right={
                <div className="flex items-center gap-2 flex-wrap no-print">
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={printDailyLog}>
                    日誌印刷
                  </button>
                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm" onClick={openNew}>
                      ＋予約追加
                    </button>
                  ) : null}
                </div>
              }
            />

            <div className="mt-4 flex items-center gap-2 flex-wrap">
              <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={selectedDate} onChange={(e)=>setSelectedDate(e.target.value)} />
              <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>smartRefresh({ scope:'day' })} disabled={busy}>
                この日を更新
              </button>
              <div className="text-xs font-bold text-slate-400">※表示が古い場合は「更新」</div>
            </div>

            <div className="mt-4 grid md:grid-cols-2 gap-3">
              {roomsActive.map(room => {
                const list = dayReservations.filter(r => r.roomId === room.id).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                return (
                  <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <div className="text-xs font-black text-slate-400">{room.building}</div>
                        <div className="font-black text-slate-800">{room.name}</div>
                      </div>
                      <Pill tone="slate">{list.length}件</Pill>
                    </div>
                    <div className="mt-3 space-y-2">
                      {list.length === 0 ? (
                        <div className="text-xs font-bold text-slate-400">予約なし</div>
                      ) : list.map(r => (
                        <div key={r.id} className="p-3 rounded-2xl bg-slate-50 border border-slate-100">
                          <div className="flex items-start justify-between gap-2">
                            <div className="min-w-0">
                              <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                              <div className="mt-1 flex flex-wrap gap-2">
                                {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                  <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                ) : null)}
                                {r.note ? <Pill tone="slate">メモ</Pill> : null}
                              </div>
                              {r.note ? <div className="text-xs font-bold text-slate-500 mt-2">{r.note}</div> : null}
                            </div>
                            {isLoggedIn ? (
                              <div className="shrink-0 flex flex-col gap-2 no-print">
                                <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                  編集
                                </button>
                                <button className="px-3 py-2 rounded-2xl bg-rose-50 border border-rose-200 font-black text-rose-700" onClick={()=>deleteReservation(r.id)}>
                                  削除
                                </button>
                              </div>
                            ) : null}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </Card>
        )}

        {tab === "monitor" && (
          <Card printCard>
            <SectionTitle
              icon="🖥️"
              title="掲示板"
              sub="1日分を全画面で見やすく（スクロール最小化）"
              right={
                <div className="flex items-center gap-2 flex-wrap no-print">
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(todayKeyLocal())}>今日</button>
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(addDaysKey(todayKeyLocal(),1))}>明日</button>
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(addDaysKey(todayKeyLocal(),2))}>明後日</button>

                  <div className="flex items-center gap-2 rounded-2xl bg-white border border-slate-200 px-2 py-1">
                    <button className={classNames("px-3 py-2 rounded-2xl font-black", monitorView==="timeline" ? "bg-slate-900 text-white" : "bg-white text-slate-700")} onClick={()=>{ setMonitorView("timeline"); saveMonitorView("timeline"); }}>タイムライン</button>
                    <button className={classNames("px-3 py-2 rounded-2xl font-black", monitorView==="cards" ? "bg-slate-900 text-white" : "bg-white text-slate-700")} onClick={()=>{ setMonitorView("cards"); saveMonitorView("cards"); }}>カード</button>
                  </div>

                  <button
                    className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900"
                    onClick={() => {
                      const el = document.documentElement;
                      if(el.requestFullscreen) el.requestFullscreen();
                    }}
                  >
                    全画面
                  </button>
                </div>
              }
            />

            <div className="mt-4 flex items-center gap-2 flex-wrap">
              <div className="text-sm font-black text-slate-800">表示日</div>
              <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDate} onChange={(e)=>setMonitorDate(e.target.value)} />
              <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>smartRefresh({ scope:'monitor' })} disabled={busy}>
                この日を更新
              </button>
              <div className="text-xs font-bold text-slate-400">時間軸：{monitorSettings.startHHMM}〜{monitorSettings.endHHMM}（変更は「設定」）</div>
            </div>

            {monitorView === "timeline" ? (
              <MonitorTimelineBoard
                dateKey={monitorDate}
                rooms={roomsActive}
                reservations={monitorReservations}
                equipmentsActive={equipmentsActive}
                startHHMM={monitorSettings.startHHMM}
                endHHMM={monitorSettings.endHHMM}
                autoPage={monitorSettings.autoPage}
                intervalSec={monitorSettings.intervalSec}
                roomsPerPage={monitorSettings.roomsPerPage}
              />
            ) : (
              <MonitorBoard
                dateKey={monitorDate}
                rooms={roomsActive}
                equipmentsActive={equipmentsActive}
                reservations={monitorReservations}
              />
            )}
          </Card>
        )}

        {tab === "week" && (
          <Card printCard>
            <SectionTitle
              icon="🧾"
              title="週予定"
              sub={`週：${weekStart}〜${addDaysKey(weekStart,6)}（日曜始まり）`}
              right={
                <div className="flex items-center gap-2 flex-wrap no-print">
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const prev=addDaysKey(weekStart,-7); setWeekStart(prev); }}>
                    ◀ 前週
                  </button>
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const next=addDaysKey(weekStart,7); setWeekStart(next); }}>
                    次週 ▶
                  </button>
                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600"
                      onClick={()=>{ const end=addDaysKey(weekStart,6); const dk=(selectedDate>=weekStart && selectedDate<=end)?selectedDate:weekStart; openNewForDate(dk); }}
                    >
                      + 予約追加
                    </button>
                  ) : null}
                  <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                    busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                    onClick={()=>smartRefresh({ scope:'week' })} disabled={busy}
                  >
                    この週を更新
                  </button>
                </div>
              }
            />

            <RangeList
              startKey={weekStart}
              endKey={addDaysKey(weekStart,6)}
              reservations={weekReservations}
              roomsMap={roomsMap}
              equipmentsActive={equipmentsActive}
              isLoggedIn={isLoggedIn}
              onPickDate={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
              onEdit={(r)=>openEdit(r)}
              showMonthHeaders={false}
              maxHeight="70vh"
            />

            <div className="mt-3 text-xs font-bold text-slate-400">※週予定は「この週を更新」でFirestoreから取得（概算readに反映）</div>
          </Card>
        )}

        {tab === "month" && (
          <Card printCard>
            <SectionTitle
              icon="🗓️"
              title="月予定"
              sub={`月：${monthCursor}`}
              right={
                <div className="flex items-center gap-2 flex-wrap no-print">
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const prev = addMonthsKey(monthCursor,-1); setMonthCursor(prev); }}>
                    ◀ 前月
                  </button>
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const next = addMonthsKey(monthCursor,1); setMonthCursor(next); }}>
                    次月 ▶
                  </button>
                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600"
                      onClick={()=>{ const dk = (String(selectedDate||"").slice(0,7)===monthCursor) ? selectedDate : `${monthCursor}-01`; openNewForDate(dk); }}
                    >
                      + 予約追加
                    </button>
                  ) : null}
                  <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                    monthBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                    onClick={()=>smartRefresh({ scope:'month' })} disabled={monthBusy}
                  >
                    この月を更新
                  </button>
                  <button className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900" onClick={()=>{ setMonthCursor(monthKeyFromDateKey(todayKeyLocal())); }}>
                    今月
                  </button>
                </div>
              }
            />

            <div className="mt-3 text-xs font-bold text-slate-400">※月予定は「この月を更新」でFirestoreから取得（概算readに反映）</div>

            <MonthList
              monthKey={monthCursor}
              reservations={monthReservations}
              roomsMap={roomsMap}
              onPickDate={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
            />
          </Card>
        )}

        {tab === "year" && (
          <Card printCard>
            <SectionTitle
              icon="🗓️"
              title="年間予定（年度）"
              sub={`年度：${fyInfo.fy}（${fyInfo.start}〜${fyInfo.end}） / 4月始まり`}
              right={
                <div className="flex items-center gap-2 flex-wrap no-print">
                  <button
                    className={classNames("rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700",
                      yearBusy ? "opacity-50" : "")}
                    onClick={exportYearCSV}
                    disabled={yearBusy}
                    title="年度内の一覧をCSVで出力"
                  >
                    年間一括エクスポート
                  </button>

                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900" onClick={()=>setImportOpen(true)} disabled={importBusy||yearBusy}>
                      年間一括インポート
                    </button>
                  ) : null}

                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-rose-600 text-white border border-rose-600" onClick={deleteAllReservations} disabled={busy||importBusy||yearBusy}>
                      全予定削除
                    </button>
                  ) : null}

                  <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                    yearBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                    disabled={yearBusy}
                    onClick={()=>smartRefresh({ scope:'year' })}
                  >
                    年間を更新
                  </button>
                </div>
              }
            />

            <div className="mt-3 grid lg:grid-cols-3 gap-3">
              <div className="rounded-3xl border border-slate-100 bg-white p-4 lg:col-span-2">
                <div className="flex flex-wrap items-center gap-2">
                  <div className="text-sm font-black text-slate-800">絞り込み</div>
                  <input
                    className="flex-1 min-w-[220px] rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                    value={yearGroupExact}
                    onChange={(e)=>setYearGroupExact(e.target.value)}
                    placeholder="団体名（完全一致）"
                    list="groupDatalistYear"
                  />
                  <datalist id="groupDatalistYear">
                    {activeGroupNames.map((name, i)=><option key={i} value={name} />)}
                  </datalist>

                  <select
                    className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                    value={yearRoomFilter}
                    onChange={(e)=>setYearRoomFilter(e.target.value)}
                  >
                    <option value="all">全部屋</option>
                    {roomsActive.map(r => (
                      <option key={r.id} value={r.id}>{r.building} / {r.name}</option>
                    ))}
                  </select>
                  <Pill tone="slate">{yearReservations.length}件</Pill>
                </div>

                <div className="mt-3 text-xs font-bold text-slate-400">※「年間を更新」で年度内（4月〜翌3月）をまとめて取得します。件数が多いとreadが増えます。</div>

                <YearGroupedList
                  fyInfo={fyInfo}
                  roomsMap={roomsMap}
                  equipmentsActive={equipmentsActive}
                  reservations={yearReservations}
                  groupExact={yearGroupExact}
                  roomFilter={yearRoomFilter}
                  isLoggedIn={isLoggedIn}
                  onEdit={(r)=>openEdit(r)}
                  onJumpDay={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
                />
              </div>

              <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                <div className="font-black text-slate-800">月へジャンプ（4月→3月）</div>
                <div className="mt-2 grid grid-cols-3 gap-2">
                  {fyMonthsOrdered.map(mk => (
                    <button
                      key={mk}
                      type="button"
                      onClick={()=>{ const el=document.getElementById(`ym-${mk}`); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); }}
                      className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700 text-center"
                      title={mk}
                    >
                      {mk.slice(5)}
                    </button>
                  ))}
                </div>
                <div className="mt-4 text-xs font-bold text-slate-500 space-y-1">
                  <div>・「年間一括インポート」は、Excel/スプレッドシートから貼り付け→プレビュー→一括登録。</div>
                  <div>・インポート/編集はログイン中のみ。</div>
                  <div>・「年間一括エクスポート」は、年度内一覧をCSV出力。</div>
                </div>
              </div>
            </div>
          </Card>
        )}

        {/* 追加タブ：書記長・書記次長 予定（ログイン中のみ） */}
        {tab === "staff" && isLoggedIn && (
          <Card printCard>
            <SectionTitle
              icon="🗂️"
              title="書記長／書記次長 予定（動静）"
              sub="打ち合わせ・来校者・出張など（午前/午後/夕方）"
              right={
                <div className="flex items-center gap-2 flex-wrap no-print">
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setStaffDate(todayKeyLocal())}>今日</button>
                  <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                    staffBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                    onClick={()=>smartRefresh({scope:"staff"})}
                    disabled={staffBusy}
                  >
                    この日を更新
                  </button>
                </div>
              }
            />

            <div className="mt-4 flex items-center gap-2 flex-wrap">
              <div className="text-sm font-black text-slate-800">日付</div>
              <input
                type="date"
                className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                value={staffDate}
                onChange={(e)=>{
                  const v = e.target.value;
                  setStaffDate(v);
                  const cached = loadCache(`${CACHE_PREFIX}:staff:${v}`);
                  if(cached) setStaffData(cached);
                  refreshStaff(v, { silent:true });
                }}
              />
              <div className="text-xs font-bold text-slate-400">※このタブはログイン中のみ表示/編集できます</div>
            </div>

            <StaffScheduleEditor
              dateKey={staffDate}
              value={staffData}
              onChange={setStaffData}
              busy={staffBusy}
              onSave={async ()=>{
                if(!isLoggedIn) return;
                setStaffBusy(true);
                try{
                  const makePayload = (roleKey, obj) => ({
                    date: staffDate,
                    role: roleKey,
                    morning: String(obj.morning||""),
                    afternoon: String(obj.afternoon||""),
                    evening: String(obj.evening||""),
                    note: String(obj.note||""),
                    updatedAt: serverTimestamp(),
                  });
                  const batch = db.batch();
                  batch.set(db.collection("staffSchedules").doc(`${staffDate}_chief`), makePayload("chief", staffData.chief), {merge:true});
                  batch.set(db.collection("staffSchedules").doc(`${staffDate}_deputy`), makePayload("deputy", staffData.deputy), {merge:true});
                  await batch.commit();
                  bumpWrites(2);
                  await touchRevisionDoc("staffSchedules");
                  saveCache(`${CACHE_PREFIX}:staff:${staffDate}`, staffData);
                  setToast({type:"ok", msg:"書記予定を保存しました"});
                  setTimeout(()=>setToast(null), 1600);
                }catch(e){
                  console.error(e);
                  setToast({type:"ng", msg:"書記予定の保存に失敗しました"});
                  setTimeout(()=>setToast(null), 2400);
                }finally{
                  setStaffBusy(false);
                }
              }}
            />
          </Card>
        )}

        {tab === "equip" && (
          <Card printCard>
            <SectionTitle
              icon="🧰"
              title="機材マスタ"
              sub="機材の種類・台数（総数）を追加/変更できます"
            />

            <div className="mt-4">
              {!isLoggedIn ? (
                <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">編集するにはログインしてください</div>
              ) : null}

              <EquipmentManager
                equipments={equipments}
                setEquipments={setEquipments}
                isLoggedIn={isLoggedIn}
                busy={busy}
                onSaved={async () => { await refreshMasters(); await touchRevisionDoc("masters_equip"); }}
                bumpReads={bumpReads}
                bumpWrites={bumpWrites}
              />
            </div>

            <div className="mt-4 rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">メモ</div>
              <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                <li>「active = false」は削除ではなく<strong>非表示</strong>です（過去データ保護）。</li>
                <li>予約入力/超過チェック/モニター表示は、activeな機材に追従します。</li>
              </ul>
            </div>
          </Card>
        )}

        {tab === "rooms" && (
          <Card printCard>
            <SectionTitle
              icon="🏢"
              title="部屋マスタ"
              sub="部屋名の追加/変更/非表示（削除しない）"
            />

            <div className="mt-4">
              {!isLoggedIn ? (
                <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">編集するにはログインしてください</div>
              ) : null}

              <RoomManager
                rooms={rooms}
                setRooms={setRooms}
                isLoggedIn={isLoggedIn}
                busy={busy}
                onSaved={async () => { await refreshMasters(); await touchRevisionDoc("masters_rooms"); }}
                bumpReads={bumpReads}
                bumpWrites={bumpWrites}
              />
            </div>

            <div className="mt-4 rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">メモ</div>
              <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                <li>「active = false」は<strong>非表示</strong>です（予約データを壊しません）。</li>
                <li>表示順は order で調整できます（小さいほど上）。</li>
              </ul>
            </div>
          </Card>
        )}

        {tab === "help" && (
          <Card printCard>
            <SectionTitle
              icon="⚙️"
              title="設定"
              sub="掲示板の時間軸 / 団体マスタ（最大100） / read-write（概算） / 運用"
            />

            <div className="mt-4 grid md:grid-cols-2 gap-3">
              <div className="rounded-3xl border border-slate-100 bg-white p-4">
                <div className="font-black text-slate-800">掲示板設定</div>
                <div className="text-xs font-bold text-slate-500 mt-2">※変更・保存は <span className="text-slate-900">ログイン中のみ</span> できます（表示は全員OK）</div>

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <div>
                    <div className="text-xs font-black text-slate-600 mb-1">開始</div>
                    <input type="time" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDraft.startHHMM} onChange={(e)=>setMonitorDraft(d=>({ ...d, startHHMM:e.target.value }))} disabled={!isLoggedIn||busy} />
                  </div>
                  <div>
                    <div className="text-xs font-black text-slate-600 mb-1">終了</div>
                    <input type="time" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDraft.endHHMM} onChange={(e)=>setMonitorDraft(d=>({ ...d, endHHMM:e.target.value }))} disabled={!isLoggedIn||busy} />
                  </div>
                </div>

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-3">
                    <div className="text-xs font-black text-slate-600">自動ページ送り</div>
                    <label className="mt-2 flex items-center gap-2 font-black text-slate-700">
                      <input type="checkbox" checked={!!monitorDraft.autoPage} onChange={(e)=>setMonitorDraft(d=>({ ...d, autoPage:e.target.checked }))} disabled={!isLoggedIn||busy} />
                      ON
                    </label>
                    <div className="text-[11px] font-bold text-slate-400 mt-1">部屋が多い時に自動で切替</div>
                  </div>
                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-3">
                    <div className="text-xs font-black text-slate-600">切替間隔（秒）</div>
                    <input type="number" min="5" max="120" className="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={Number(monitorDraft.intervalSec||12)} onChange={(e)=>setMonitorDraft(d=>({ ...d, intervalSec:Number(e.target.value||12) }))} disabled={!isLoggedIn||busy} />
                    <div className="text-[11px] font-bold text-slate-400 mt-1">5〜120</div>
                  </div>
                </div>

                <div className="mt-3">
                  <div className="text-xs font-black text-slate-600 mb-1">1画面に表示する部屋数</div>
                  <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={String(monitorDraft.roomsPerPage||"auto")} onChange={(e)=>setMonitorDraft(d=>({ ...d, roomsPerPage:e.target.value }))} disabled={!isLoggedIn||busy}>
                    <option value="auto">自動（画面サイズ）</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="12">12</option>
                    <option value="16">16</option>
                  </select>
                </div>

                <div className="mt-3 flex gap-2">
                  <button
                    className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                      (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                    disabled={!isLoggedIn||busy}
                    onClick={() => {
                      const s = hhmmToMin(monitorDraft.startHHMM||"08:00");
                      const e = hhmmToMin(monitorDraft.endHHMM||"20:00");
                      if(!(e > s)){
                        setToast({ type:"ng", msg:"終了は開始より後にしてください" });
                        setTimeout(()=>setToast(null), 2200);
                        return;
                      }
                      const next = {
                        startHHMM: monitorDraft.startHHMM || "08:00",
                        endHHMM: monitorDraft.endHHMM || "20:00",
                        autoPage: !!monitorDraft.autoPage,
                        intervalSec: Math.max(5, Math.min(120, Number(monitorDraft.intervalSec||12))),
                        roomsPerPage: String(monitorDraft.roomsPerPage||"auto"),
                      };
                      setMonitorSettings(next);
                      saveMonitorSettingsLocal(next);
                      setToast({ type:"ok", msg:"掲示板設定を保存しました" });
                      setTimeout(()=>setToast(null), 1800);
                    }}
                  >
                    保存
                  </button>
                  <button
                    className={classNames("rounded-2xl px-4 py-3 font-black shadow-sm border",
                      busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                    onClick={() => setMonitorDraft(monitorSettings)}
                    disabled={busy}
                  >
                    戻す
                  </button>
                </div>
              </div>

              <div className="space-y-3">
                <div className="rounded-3xl border border-slate-100 bg-white p-4">
                  <div className="font-black text-slate-800">団体マスタ（最大100）</div>
                  <div className="text-xs font-bold text-slate-500 mt-2">※登録した団体名は「予約追加」の候補として選べます（手入力もOK）。編集はログイン中のみ。</div>

                  <GroupManager
                    groups={groups}
                    setGroups={setGroups}
                    isLoggedIn={isLoggedIn}
                    busy={busy}
                    bumpReads={bumpReads}
                    bumpWrites={bumpWrites}
                    onSaved={async ()=>{ await refreshMasters(); await touchRevisionDoc("masters_groups"); }}
                  />
                </div>

                <div className="rounded-3xl border border-slate-100 bg-white p-4">
                  <div className="font-black text-slate-800">自動更新（1分）</div>
                  <div className="text-xs font-bold text-slate-500 mt-2">差分判定：変更があった時だけ取得します（変化がなければ read/write（概算）は増えません）</div>

                  <label className="mt-3 flex items-center justify-between gap-3 rounded-3xl border border-slate-100 bg-slate-50 p-3">
                    <div>
                      <div className="text-xs font-black text-slate-600">自動更新</div>
                      <div className="text-sm font-bold text-slate-800 mt-1">{autoRefresh ? 'ON' : 'OFF'}</div>
                    </div>
                    <input type="checkbox" checked={!!autoRefresh} onChange={(e)=>setAutoRefresh(e.target.checked)} />
                  </label>

                  <div className="mt-3 text-[11px] font-bold text-slate-500 space-y-1">
                    <div>最終チェック：{lastCheckAt ? new Date(lastCheckAt).toLocaleString('ja-JP') : '—'}</div>
                    <div>最終更新検知：{lastChangeAt ? new Date(lastChangeAt).toLocaleString('ja-JP') : '—'}</div>
                    <div>revision：{(lastRev==null) ? '—' : String(lastRev)}</div>
                  </div>

                  <div className="mt-3 text-[11px] font-bold text-slate-400">※差分判定のために1ドキュメントだけ取得します（概算readには加算していません）。</div>
                </div>

                <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="font-black text-slate-800">read/write カウント（概算）</div>
                  <div className="text-sm font-bold text-slate-700 mt-2 space-y-1">
                    <div>・Firestoreの取得(get)で read を、保存(set/add/delete)で write を<strong>概算</strong>加算します。</div>
                    <div>・マスタ更新/週・月・年度の更新は read が増えます（必要時だけ更新推奨）。</div>
                  </div>
                  <div className="mt-3">
                    <button className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={resetOps}>今月のread/writeをリセット</button>
                  </div>

                  <div className="mt-4 font-black text-slate-800">運用ヒント</div>
                  <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                    <li>掲示板は「タイムライン」推奨（部屋が多いと自動でページ送りします）。</li>
                    <li>部屋/機材/団体は削除ではなく「非表示」で運用できます。</li>
                    <li>週・月・年度は「更新」でまとめて取得（必要時のみ）。</li>
                    <li>インポートは同一内容なら同じIDで上書き（重複しにくい方式）。</li>
                  </ul>
                </div>
              </div>
            </div>
          </Card>
        )}
      </div>

      <Modal
        open={editorOpen}
        onClose={()=>{ setEditorOpen(false); setEditModel(null); }}
        title={editModel?.id ? "予約を編集" : "予約を追加"}
      >
        {editModel ? (
          <ReservationEditor
            model={editModel}
            setModel={setEditModel}
            roomsActive={roomsActive}
            equipmentsActive={equipmentsActive}
            groupCandidates={activeGroupNames}
            busy={busy}
            isLoggedIn={isLoggedIn}
            onSave={saveReservation}
            onCancel={()=>{ setEditorOpen(false); setEditModel(null); }}
          />
        ) : null}
      </Modal>

      <Modal
        open={importOpen}
        onClose={()=>{ if(!importBusy) setImportOpen(false); }}
        title="年間一括インポート"
      >
        <ImportModal
          open={importOpen}
          fyInfo={fyInfo}
          roomsActive={roomsActive}
          roomsMap={roomsMap}
          equipmentsActive={equipmentsActive}
          isLoggedIn={isLoggedIn}
          importText={importText}
          setImportText={setImportText}
          importPreview={importPreview}
          setImportPreview={setImportPreview}
          importBusy={importBusy}
          setImportBusy={setImportBusy}
          bumpWrites={bumpWrites}
          bumpReads={bumpReads}
          setToast={setToast}
          onDone={async ()=>{ setImportOpen(false); await refreshYear({ silent:true }); }}
        />
      </Modal>

      {toast ? (
        <div className={classNames(
          "fixed left-1/2 -translate-x-1/2 bottom-4 z-50 px-4 py-3 rounded-3xl shadow-lg border font-black no-print",
          toast.type==="ok" ? "bg-emerald-600 text-white border-emerald-700" : "bg-rose-600 text-white border-rose-700"
        )}>
          {toast.msg}
        </div>
      ) : null}

      <div className="fixed inset-x-0 bottom-0 z-30 bg-white/85 glass border-t border-slate-100 no-print">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
          <div className="text-xs font-bold text-slate-500">©️2026 Takayuki WAYAMA</div>
          <div className="text-xs font-bold text-slate-400">共通ID：{SHARED_LOGIN_CODE}</div>
        </div>
      </div>
    </div>
  );
}

/**********************
 * Login
 **********************/
function LoginButton({busy, onLogin}){
  const [open, setOpen] = useState(false);
  const [pw, setPw] = useState("");

  return (
    <>
      <button
        className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
          busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")}
        disabled={busy}
        onClick={()=>setOpen(true)}
      >
        ログイン
      </button>

      <Modal open={open} onClose={()=>setOpen(false)} title="共通IDログイン">
        <div className="space-y-3">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">パスワード</div>
            <div className="text-xs font-bold text-slate-500 mt-1">共通ID：{SHARED_LOGIN_CODE}</div>
            <input
              type="password"
              className="mt-3 w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
              value={pw}
              onChange={(e)=>setPw(e.target.value)}
              placeholder="パスワード"
            />
            <div className="mt-3 flex gap-2">
              <button
                className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                  busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                disabled={busy}
                onClick={()=>{ onLogin(pw); setOpen(false); setPw(""); }}
              >
                ログイン
              </button>
              <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setOpen(false)}>
                キャンセル
              </button>
            </div>
          </div>
        </div>
      </Modal>
    </>
  );
}

/**********************
 * Reservation Editor（団体マスタ候補 + 手入力 両対応）
 **********************/
function ReservationEditor({model, setModel, roomsActive, equipmentsActive, groupCandidates=[], busy, isLoggedIn, onSave, onCancel}){
  const roomGroups = useMemo(() => {
    const g = {};
    for(const r of roomsActive){
      const b = r.building || "その他";
      if(!g[b]) g[b] = [];
      g[b].push(r);
    }
    return g;
  }, [roomsActive]);

  function setField(k,v){ setModel(prev => ({ ...prev, [k]: v })); }
  function setEquip(k,v){
    const n = Math.max(0, Math.min(999, Number(v)||0));
    setModel(prev => ({ ...prev, equipment: { ...(prev.equipment||{}), [k]: n }}));
  }

  const opts10 = useMemo(() => {
    const a = [];
    for(let m=0; m<=23*60+50; m+=10) a.push({ value:m, label:minToHHMM(m) });
    return a;
  }, []);
  const endOpts = opts10.filter(o => o.value >= (Number(model.startMin)||0) + 10);

  // 団体：選択→入力に反映（手入力も維持）
  const [groupPick, setGroupPick] = useState("");
  useEffect(()=>{ setGroupPick(""); }, [model?.id, model?.date]);

  return (
    <div className="space-y-4">
      {!isLoggedIn ? (
        <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">
          編集するにはログインしてください（閲覧モードでは保存できません）
        </div>
      ) : null}

      <div className="grid md:grid-cols-2 gap-3">
        <div>
          <div className="text-sm font-black text-slate-700 mb-2">日付</div>
          <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.date} onChange={(e)=>setField("date", e.target.value)} />
        </div>
        <div>
          <div className="text-sm font-black text-slate-700 mb-2">部屋</div>
          <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.roomId} onChange={(e)=>setField("roomId", e.target.value)}>
            {Object.keys(roomGroups).map(b => (
              <optgroup key={b} label={b}>
                {roomGroups[b].map(r => (
                  <option key={r.id} value={r.id}>{r.name}</option>
                ))}
              </optgroup>
            ))}
          </select>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-3">
        <div>
          <div className="text-sm font-black text-slate-700 mb-2">開始（10分単位）</div>
          <select
            className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
            value={model.startMin}
            onChange={(e)=>{
              const s = Number(e.target.value);
              const eMin = Number(model.endMin)||0;
              setField("startMin", s);
              if(eMin <= s) setField("endMin", s+10);
            }}
          >
            {opts10.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
          </select>
        </div>
        <div>
          <div className="text-sm font-black text-slate-700 mb-2">終了（開始＋10分以上）</div>
          <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.endMin} onChange={(e)=>setField("endMin", Number(e.target.value))}>
            {endOpts.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
          </select>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-3">
        <div>
          <div className="text-sm font-black text-slate-700 mb-2">団体名（必須）</div>
          <input
            className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
            value={model.groupName}
            onChange={(e)=>setField("groupName", e.target.value)}
            placeholder="例：○○研究会、△△クラブ など"
            list="groupDatalist"
          />
          <datalist id="groupDatalist">
            {groupCandidates.map((name, i)=><option key={i} value={name} />)}
          </datalist>
          <div className="text-[11px] font-bold text-slate-400 mt-1">※候補は「設定 → 団体マスタ」で登録（手入力もOK）</div>
        </div>

        <div>
          <div className="text-sm font-black text-slate-700 mb-2">団体名を選ぶ（任意）</div>
          <select
            className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
            value={groupPick}
            onChange={(e)=>{
              const v = e.target.value;
              setGroupPick(v);
              if(v) setField("groupName", v);
            }}
          >
            <option value="">（選択しない：手入力）</option>
            {groupCandidates.map((name, i)=>(
              <option key={i} value={name}>{name}</option>
            ))}
          </select>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-3">
        <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
          <div className="font-black text-slate-800">機材</div>
          <div className="mt-3 space-y-3">
            {equipmentsActive.length === 0 ? (
              <div className="text-xs font-bold text-slate-400">機材マスタが未設定です（機材タブで追加）</div>
            ) : equipmentsActive.map(e => (
              <div key={e.id} className="flex items-center justify-between gap-2">
                <div className="font-bold text-slate-700">{e.name}</div>
                <input type="number" min="0" max="999" className="w-28 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={model?.equipment?.[e.id] ?? 0} onChange={(ev)=>setEquip(e.id, ev.target.value)} />
              </div>
            ))}
            <div className="text-xs font-bold text-slate-400">※保存前に「同時間帯で総数超過」を警告します</div>
          </div>
        </div>

        <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
          <div className="font-black text-slate-800">メモ（任意）</div>
          <textarea className="mt-3 w-full h-28 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" value={model.note} onChange={(e)=>setField("note", e.target.value)} placeholder="例：机配置、来館時間の目安、鍵の受け渡し など" />
        </div>
      </div>

      <div className="flex items-center gap-2">
        <button
          className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
            (!isLoggedIn || busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
          disabled={!isLoggedIn || busy}
          onClick={()=>onSave(model)}
        >
          保存
        </button>
        <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={onCancel}>
          キャンセル
        </button>
      </div>
    </div>
  );
}

/**********************
 * Year Grouped List（団体名：完全一致）
 **********************/
function YearGroupedList({fyInfo, roomsMap, equipmentsActive, reservations, groupExact, roomFilter, isLoggedIn, onEdit, onJumpDay}){
  const q = (groupExact||"").trim().toLowerCase();

  const filtered = useMemo(() => {
    return (reservations||[]).filter(r => {
      if(roomFilter !== "all" && r.roomId !== roomFilter) return false;
      if(!q) return true;
      return String(r.groupName||"").trim().toLowerCase() === q; // 完全一致
    });
  }, [reservations, q, roomFilter]);

  return (
    <RangeList
      startKey={fyInfo.start}
      endKey={fyInfo.end}
      reservations={filtered}
      roomsMap={roomsMap}
      equipmentsActive={equipmentsActive}
      isLoggedIn={isLoggedIn}
      onPickDate={(dk)=>onJumpDay?.(dk)}
      onEdit={(r)=>onEdit?.(r)}
      showMonthHeaders={true}
      maxHeight="65vh"
    />
  );
}

/**********************
 * Monitor Timeline Board
 **********************/
function MonitorTimelineBoard({dateKey, rooms, reservations, equipmentsActive, startHHMM, endHHMM, autoPage, intervalSec, roomsPerPage}){
  const startMin = hhmmToMin(startHHMM||"08:00");
  const endMin = hhmmToMin(endHHMM||"20:00");
  const range = Math.max(60, endMin - startMin);

  const byRoom = useMemo(() => {
    const m = {};
    for(const r of rooms) m[r.id] = [];
    for(const rr of reservations||[]){
      if(!m[rr.roomId]) m[rr.roomId] = [];
      m[rr.roomId].push(rr);
    }
    for(const k of Object.keys(m)) m[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
    return m;
  }, [rooms, reservations]);

  const usedRooms = useMemo(() => rooms.filter(r => (byRoom[r.id]||[]).length > 0), [rooms, byRoom]);

  const wrapRef = useRef(null);
  const [autoPerPage, setAutoPerPage] = useState(8);
  useEffect(() => {
    if(String(roomsPerPage||"auto") !== "auto") return;
    const calc = () => {
      const h = wrapRef.current?.clientHeight || 600;
      const per = Math.max(4, Math.min(16, Math.floor((h - 64) / 74)));
      setAutoPerPage(per);
    };
    calc();
    window.addEventListener("resize", calc);
    return () => window.removeEventListener("resize", calc);
  }, [roomsPerPage]);

  const perPage = (String(roomsPerPage||"auto") === "auto") ? autoPerPage : Math.max(1, Number(roomsPerPage||autoPerPage));
  const pages = Math.max(1, Math.ceil(usedRooms.length / perPage));
  const [page, setPage] = useState(0);

  useEffect(() => { setPage(0); }, [dateKey, perPage, usedRooms.length]);

  useEffect(() => {
    if(!autoPage || pages<=1) return;
    const ms = Math.max(5, Number(intervalSec||12)) * 1000;
    const t = setInterval(() => setPage(p => (p+1)%pages), ms);
    return () => clearInterval(t);
  }, [autoPage, intervalSec, pages]);

  const pageRooms = usedRooms.slice(page*perPage, (page+1)*perPage);

  const hourTicks = useMemo(() => {
    const ticks = [];
    const startH = Math.ceil(startMin/60);
    const endH = Math.floor(endMin/60);
    for(let h=startH; h<=endH; h++){
      const t = h*60;
      if(t>=startMin && t<=endMin) ticks.push(t);
    }
    return ticks;
  }, [startMin, endMin]);

  const leftW = 220;

  return (
    <div className="mt-4 rounded-3xl border border-slate-100 bg-white overflow-hidden" style={{height:"calc(100vh - 280px)", minHeight:480}}>
      <div className="h-full flex flex-col" ref={wrapRef}>
        <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100 bg-slate-50">
          <div className="font-black text-slate-800">{dateKey} / 予約のある部屋のみ表示</div>
          <div className="flex items-center gap-2">
            {pages>1 ? (
              <div className="text-xs font-black text-slate-600">{page+1}/{pages}</div>
            ) : null}
            {pages>1 ? (
              <>
                <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setPage(p=> (p-1+pages)%pages)}>前</button>
                <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setPage(p=> (p+1)%pages)}>次</button>
              </>
            ) : null}
          </div>
        </div>

        {usedRooms.length===0 ? (
          <div className="p-6 text-sm font-bold text-slate-500">この日は予約がありません。</div>
        ) : (
          <div className="flex-1 overflow-hidden">
            <div className="h-full grid" style={{gridTemplateColumns:`${leftW}px 1fr`}}>
              <div className="px-3 py-2 border-b border-slate-100 bg-white font-black text-slate-600">部屋</div>
              <div className="px-3 py-2 border-b border-slate-100 bg-white relative">
                <div className="relative h-8">
                  {hourTicks.map(t => {
                    const x = ((t-startMin)/range)*100;
                    return (
                      <div key={t} className="absolute top-0 bottom-0" style={{left:`${x}%`}}>
                        <div className="w-px h-full bg-slate-200"></div>
                        <div className="text-[10px] font-black text-slate-500 -translate-x-1/2 mt-1">{minToHHMM(t)}</div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {pageRooms.map(room => {
                const list = byRoom[room.id] || [];
                return (
                  <React.Fragment key={room.id}>
                    <div className="px-3 py-3 border-b border-slate-100 bg-white">
                      <div className="text-xs font-black text-slate-500">{room.building}</div>
                      <div className="font-black text-slate-800">{room.name}</div>
                    </div>
                    <div className="px-3 py-2 border-b border-slate-100 bg-white relative">
                      <div className="relative h-14 rounded-2xl bg-slate-50 border border-slate-100 overflow-hidden">
                        {hourTicks.map(t => {
                          const x = ((t-startMin)/range)*100;
                          return <div key={t} className="absolute top-0 bottom-0" style={{left:`${x}%`}}><div className="w-px h-full bg-slate-200"></div></div>;
                        })}
                        {list.map(r => {
                          const s = Math.max(startMin, Number(r.startMin||0));
                          const e = Math.min(endMin, Number(r.endMin||0));
                          const left = ((s-startMin)/range)*100;
                          const width = Math.max(1, ((e-s)/range)*100);
                          const eqBadges = equipmentsActive
                            .filter(e0 => Number(r?.equipment?.[e0.id]||0)>0)
                            .slice(0,3)
                            .map(e0 => `${e0.abbr||e0.name}${Number(r.equipment[e0.id]||0)}`)
                            .join(" ");
                          return (
                            <div
                              key={r.id}
                              className="absolute top-2 bottom-2 rounded-xl bg-sky-600/90 text-white px-2 flex items-center"
                              style={{left:`${left}%`, width:`${width}%`}}
                              title={`${minToHHMM(r.startMin||0)}-${minToHHMM(r.endMin||0)} ${r.groupName}`}
                            >
                              <div className="min-w-0">
                                <div className="text-[11px] font-black truncate">{r.groupName}</div>
                                <div className="text-[10px] font-black text-white/90 truncate">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)}{eqBadges ? ` / ${eqBadges}` : ""}</div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </React.Fragment>
                );
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function MonitorBoard({dateKey, rooms, reservations, equipmentsActive}){
  const byRoom = useMemo(() => {
    const m = {};
    for(const r of rooms) m[r.id] = [];
    for(const rr of reservations||[]){
      if(!m[rr.roomId]) m[rr.roomId] = [];
      m[rr.roomId].push(rr);
    }
    for(const k of Object.keys(m)) m[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
    return m;
  }, [rooms, reservations]);

  const usedRooms = rooms.filter(r => (byRoom[r.id]||[]).length > 0);

  return (
    <div className="mt-4">
      {usedRooms.length === 0 ? (
        <div className="rounded-3xl border border-slate-100 bg-slate-50 p-6">
          <div className="text-2xl font-black text-slate-800">{dateKey} の予約はありません</div>
          <div className="text-sm font-bold text-slate-500 mt-2">※更新が必要な場合は「更新」</div>
        </div>
      ) : (
        <div className="grid lg:grid-cols-2 gap-4">
          {usedRooms.map(room => (
            <div key={room.id} className="rounded-3xl border border-slate-100 bg-white p-5">
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div className="text-xs font-black text-slate-400">{room.building}</div>
                  <div className="text-2xl md:text-3xl font-black text-slate-900 mt-1">{room.name}</div>
                </div>
                <Pill tone="slate">{(byRoom[room.id]||[]).length}件</Pill>
              </div>

              <div className="mt-4 space-y-3">
                {(byRoom[room.id]||[]).map(r => (
                  <div key={r.id} className="p-4 rounded-3xl bg-slate-50 border border-slate-100">
                    <div className="text-2xl md:text-3xl font-black text-slate-900">
                      {minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)}
                    </div>
                    <div className="text-xl md:text-2xl font-black text-slate-800 mt-1 break-words">{r.groupName}</div>
                    <div className="mt-2 flex flex-wrap gap-2">
                      {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                        <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                      ) : null)}
                      {r.note ? <Pill tone="slate">メモ</Pill> : null}
                    </div>
                    {r.note ? <div className="text-sm font-bold text-slate-600 mt-2">{r.note}</div> : null}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

/**********************
 * Month (vertical list)
 **********************/
function MonthList({monthKey, reservations, roomsMap, onPickDate}){
  const [y, m] = String(monthKey||'').split('-').map(Number);
  const days = new Date(y, m, 0).getDate();
  const byDate = {};
  (reservations||[]).forEach(r => {
    const dk = r.date;
    if(!byDate[dk]) byDate[dk] = [];
    byDate[dk].push(r);
  });
  for(const k of Object.keys(byDate)){
    byDate[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||'').localeCompare(String(b.roomId||'')));
  }
  const w = ['日','月','火','水','木','金','土'];

  const roomLabel = (rid) => {
    const r = roomsMap?.[rid];
    if(!r) return rid;
    const b = (r.building||'').trim();
    return b ? `${b}/${r.name}` : r.name;
  };

  return (
    <div className="mt-4">
      <div className="rounded-3xl border border-slate-100 bg-white overflow-hidden">
        <div className="max-h-[70vh] overflow-auto">
          {Array.from({length:days}, (_,i)=>i+1).map(d => {
            const dk = `${y}-${pad2(m)}-${pad2(d)}`;
            const dow = parseKeyToDate(dk).getDay();
            const list = byDate[dk] || [];
            return (
              <div key={dk} className="border-b border-slate-100 last:border-b-0">
                <button
                  className="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 flex items-center justify-between gap-3"
                  onClick={()=>onPickDate?.(dk)}
                  type="button"
                >
                  <div className="font-black text-slate-800">{d}日（{w[dow]}）</div>
                  <div className="text-xs font-black text-slate-500">{list.length}件</div>
                </button>

                <div className="px-4 py-3 space-y-2">
                  {list.length===0 ? (
                    <div className="text-xs font-bold text-slate-400">予定なし</div>
                  ) : list.map(r => (
                    <div key={r.id} className="p-3 rounded-2xl bg-white border border-slate-200">
                      <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {roomLabel(r.roomId)}</div>
                      <div className="text-sm font-black text-slate-700 mt-1 break-words">{r.groupName}</div>
                      {r.note ? <div className="text-xs font-bold text-slate-500 mt-1 break-words">{r.note}</div> : null}
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

/**********************
 * Range (vertical list)
 **********************/
function RangeList({startKey, endKey, reservations, roomsMap, equipmentsActive=[], isLoggedIn=false, onPickDate, onEdit, showMonthHeaders=false, maxHeight="70vh"}){
  const byDate = {};
  (reservations||[]).forEach(r => {
    const dk = r.date;
    if(!byDate[dk]) byDate[dk] = [];
    byDate[dk].push(r);
  });
  for(const k of Object.keys(byDate)){
    byDate[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||"")));
  }

  const w = ["日","月","火","水","木","金","土"];

  const roomLabel = (rid) => {
    const r = roomsMap?.[rid];
    if(!r) return rid;
    const b = (r.building||"").trim();
    return b ? `${b}/${r.name}` : r.name;
  };

  const days = [];
  let dk = startKey;
  let guard = 0;
  while(dk && endKey && dk <= endKey && guard < 400){
    days.push(dk);
    dk = addDaysKey(dk, 1);
    guard++;
  }

  return (
    <div className="mt-4">
      <div className="rounded-3xl border border-slate-100 bg-white overflow-hidden">
        <div className="overflow-auto" style={{maxHeight}}>
          {days.map((dayKey) => {
            const d = parseKeyToDate(dayKey);
            const list = byDate[dayKey] || [];
            const mk = String(dayKey).slice(0,7);
            const isFirstOfMonth = String(dayKey).endsWith("-01");
            return (
              <div key={dayKey} className="border-b border-slate-100 last:border-b-0">
                {showMonthHeaders && isFirstOfMonth ? (
                  <div id={`ym-${mk}`} className="px-4 py-3 bg-slate-900 text-white font-black">{mk}</div>
                ) : null}

                <button
                  className="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 flex items-center justify-between gap-3"
                  onClick={()=>onPickDate?.(dayKey)}
                  type="button"
                >
                  <div className="font-black text-slate-800">{Number(String(dayKey).slice(8))}日（{w[d.getDay()]}）</div>
                  <div className="text-xs font-black text-slate-500">{list.length}件</div>
                </button>

                <div className="px-4 py-3 space-y-2">
                  {list.length===0 ? (
                    <div className="text-xs font-bold text-slate-400">予定なし</div>
                  ) : list.map(r => (
                    <div key={r.id} className="p-3 rounded-2xl bg-white border border-slate-200">
                      <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {roomLabel(r.roomId)}</div>
                      <div className="text-sm font-black text-slate-700 mt-1 break-words">{r.groupName}</div>
                      {r.note ? <div className="text-xs font-bold text-slate-500 mt-1 break-words">{r.note}</div> : null}
                      {equipmentsActive?.length ? (
                        <div className="mt-2 flex flex-wrap gap-1">
                          {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                            <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                          ) : null)}
                        </div>
                      ) : null}
                      {isLoggedIn && onEdit ? (
                        <div className="mt-2 flex gap-2 no-print">
                          <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={(ev)=>{ ev.stopPropagation(); onEdit(r); }}>編集</button>
                        </div>
                      ) : null}
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

/**********************
 * Import Modal（年間一括インポート）
 **********************/
function ImportModal({open, fyInfo, roomsActive, roomsMap, equipmentsActive, isLoggedIn, importText, setImportText, importPreview, setImportPreview, importBusy, setImportBusy, bumpWrites, bumpReads, setToast, onDone}){
  const templateHeaders = useMemo(() => {
    const base = ["日付","開始","終了","部屋","団体名","メモ"];
    const eq = equipmentsActive.map(e => e.abbr || e.id);
    return base.concat(eq);
  }, [equipmentsActive]);

  const roomIndex = useMemo(() => {
    const idx = {};
    for(const r of roomsActive||[]){
      idx[String(r.id).toLowerCase()] = r.id;
      idx[String(r.name).toLowerCase()] = r.id;
      idx[`${String(r.building||"")}/${String(r.name||"")}`.toLowerCase()] = r.id;
      idx[`${String(r.building||"")} ${String(r.name||"")}`.toLowerCase()] = r.id;
    }
    return idx;
  }, [roomsActive]);

  const eqIndex = useMemo(() => {
    const idx = {};
    for(const e of equipmentsActive||[]){
      idx[String(e.id).toLowerCase()] = e.id;
      if(e.abbr) idx[String(e.abbr).toLowerCase()] = e.id;
      idx[String(e.name).toLowerCase()] = e.id;
    }
    return idx;
  }, [equipmentsActive]);

  const detectDelimiter = (firstLine) => (String(firstLine||"").includes("\t") ? "\t" : ",");

  const splitLine = (line, delim) => {
    const s = String(line||"");
    if(delim === "\t") return s.split("\t");
    const res = [];
    let cur = "";
    let inQ = false;
    for(let i=0;i<s.length;i++){
      const ch = s[i];
      if(ch === '"'){
        if(inQ && s[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        res.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    res.push(cur);
    return res;
  };

  const norm = (v) => String(v ?? "").trim();
  const normKey = (v) => norm(v).toLowerCase().replace(/\s/g, "");

  const makeHeaderIndex = (headers) => {
    const hs = headers.map(normKey);
    const find = (keys) => {
      for(const k of keys){
        const i = hs.indexOf(normKey(k));
        if(i>=0) return i;
      }
      return -1;
    };
    const map = {
      date: find(["日付","date","年月日","ymd" ]),
      start: find(["開始","start","starttime","開始時刻","開始時間" ]),
      end: find(["終了","end","endtime","終了時刻","終了時間" ]),
      room: find(["部屋","場所","room","roomid","roomname" ]),
      group: find(["団体名","予約名","団体","title","name","group","利用者" ]),
      note: find(["メモ","備考","note","notes" ])
    };
    const eqCols = {};
    headers.forEach((h, i) => {
      const k = normKey(h);
      if(eqIndex[k]) eqCols[i] = eqIndex[k];
    });
    return {map, eqCols};
  };

  const [showSample, setShowSample] = useState(false);

  const buildPreview = () => {
    const raw = String(importText||"").trim();
    if(!raw){
      setImportPreview(null);
      return;
    }
    const lines = raw.split(/\r?\n/).filter(l => String(l||"").trim() !== "");
    if(lines.length === 0){
      setImportPreview(null);
      return;
    }
    const delim = detectDelimiter(lines[0]);
    const first = splitLine(lines[0], delim);
    const headerLike = first.some(c => /日付|date/i.test(String(c||"")));
    const headers = headerLike ? first : templateHeaders;
    const startIdx = headerLike ? 1 : 0;
    const {map, eqCols} = makeHeaderIndex(headers);

    const rows = [];
    for(let i=startIdx;i<lines.length;i++){
      const cells = splitLine(lines[i], delim);
      const get = (idx) => (idx>=0 && idx<cells.length) ? norm(cells[idx]) : "";
      const errors = [];
      const warns = [];

      const dateRaw = get(map.date);
      const startRaw = get(map.start);
      const endRaw = get(map.end);
      const roomRaw = get(map.room);
      const groupRaw = get(map.group);
      const noteRaw = get(map.note);

      const dk = parseDateLooseToKey(dateRaw);
      if(!dk) errors.push(`日付が読めません: ${dateRaw}`);
      const sMin = parseHHMMLoose(startRaw);
      const eMin = parseHHMMLoose(endRaw);
      if(sMin==null) errors.push(`開始が読めません: ${startRaw}`);
      if(eMin==null) errors.push(`終了が読めません: ${endRaw}`);
      if(sMin!=null && eMin!=null && eMin <= sMin) errors.push(`終了<=開始 (${startRaw}〜${endRaw})`);

      let roomId = "";
      const rk = normKey(roomRaw);
      if(rk && roomIndex[rk]) roomId = roomIndex[rk];
      if(!roomId) errors.push(`部屋が見つかりません: ${roomRaw}`);

      if(!groupRaw) errors.push("団体名が空です");

      let skip = false;
      if(dk && (dk < fyInfo.start || dk > fyInfo.end)){
        warns.push(`年度外のためスキップ: ${dk}`);
        skip = true;
      }

      const equipment = {};
      for(const [col, eid] of Object.entries(eqCols)){
        const v = get(Number(col));
        if(v === "") continue;
        const n = Number(String(v).replace(/[^0-9.-]/g, ""));
        if(Number.isFinite(n) && n>0) equipment[eid] = Math.floor(n);
        else if(v) errors.push(`機材(${headers[Number(col)]})が数値でありません: ${v}`);
      }

      const model = (errors.length===0 && !skip) ? {
        date: dk,
        roomId,
        startMin: sMin,
        endMin: eMin,
        groupName: groupRaw,
        note: noteRaw,
        equipment,
        updatedAt: serverTimestamp(),
      } : null;

      rows.push({ line: i+1, raw: lines[i], errors, warns, skip, model });
    }

    // overlap check inside import
    const buckets = {};
    rows.forEach((r) => {
      if(!r.model) return;
      const key = `${r.model.date}|${r.model.roomId}`;
      if(!buckets[key]) buckets[key] = [];
      buckets[key].push(r);
    });
    Object.values(buckets).forEach(arr => {
      arr.sort((a,b)=>a.model.startMin - b.model.startMin);
      for(let i=1;i<arr.length;i++){
        const prev = arr[i-1].model;
        const cur = arr[i].model;
        if(cur.startMin < prev.endMin){
          arr[i].errors.push("同じ部屋で時間が重なっています（インポート内）");
          arr[i-1].errors.push("同じ部屋で時間が重なっています（インポート内）");
          arr[i].model = null;
          arr[i-1].model = null;
        }
      }
    });

    const ok = rows.filter(r => r.model && r.errors.length===0 && !r.skip).length;
    const ng = rows.filter(r => r.errors.length>0).length;
    const skipped = rows.filter(r => r.skip).length;
    setImportPreview({ headers, rows, ok, ng, skipped });
  };

  const runImport = async () => {
    if(!isLoggedIn){
      setToast({type:"ng", msg:"ログイン中のみインポートできます"});
      setTimeout(()=>setToast(null), 2500);
      return;
    }
    const rows = importPreview?.rows || [];
    const valids = rows.filter(r => r.model && r.errors.length===0 && !r.skip);
    if(valids.length===0){
      setToast({type:"ng", msg:"インポートできる行がありません"});
      setTimeout(()=>setToast(null), 2500);
      return;
    }
    setImportBusy(true);
    try{
      const CHUNK = 420;
      for(let i=0;i<valids.length;i+=CHUNK){
        const slice = valids.slice(i, i+CHUNK);
        const batch = db.batch();
        slice.forEach(row => {
          const m = row.model;
          const id = deterministicIdForReservation(m);
          const ref = db.collection("reservations").doc(id);
          const payload = {
            date: m.date,
            roomId: m.roomId,
            startMin: m.startMin,
            endMin: m.endMin,
            groupName: m.groupName,
            note: m.note,
            equipment: m.equipment,
            updatedAt: serverTimestamp(),
          };
          batch.set(ref, payload, {merge:true});
        });
        await batch.commit();
        bumpWrites(slice.length);
      }
      await touchRevisionDoc("reservation_import");
      setToast({type:"ok", msg:`インポート完了：${valids.length}件（年度：${fyInfo.label}）`});
      setTimeout(()=>setToast(null), 3500);
      setImportPreview(null);
      await onDone?.();
    }catch(e){
      console.error(e);
      setToast({type:"ng", msg:"インポートに失敗しました"});
      setTimeout(()=>setToast(null), 3500);
    }finally{
      setImportBusy(false);
    }
  };

  const sampleText = useMemo(() => {
    const header = templateHeaders.join(",");
    const room = (roomsActive && roomsActive[0]) ? roomsActive[0].name : "会議室";
    const line1 = `${fyInfo.fy}-04-10,09:00,10:00,${room},職員会議,,1`;
    return `${header}\n${line1}`;
  }, [templateHeaders, fyInfo, roomsActive]);

  return (
    <div className="space-y-3">
      <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
        <div className="font-black text-slate-800">貼り付け</div>
        <div className="text-xs font-bold text-slate-500 mt-1">Excel/スプレッドシートの範囲をコピー → ここに貼り付け（CSV/TSV対応）</div>

        <textarea
          className="mt-3 w-full h-40 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700"
          value={importText}
          onChange={(e)=>setImportText(e.target.value)}
          placeholder={templateHeaders.join(",")}
        />

        <div className="mt-3 flex flex-wrap gap-2">
          <button
            className={classNames("px-4 py-2 rounded-2xl font-black border",
              importBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
            onClick={buildPreview}
            disabled={importBusy}
          >
            プレビュー作成
          </button>
          <button
            className={classNames("px-4 py-2 rounded-2xl font-black border",
              (!importPreview || importBusy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")}
            onClick={runImport}
            disabled={!importPreview || importBusy}
          >
            一括登録（実行）
          </button>
          <button
            className="px-4 py-2 rounded-2xl font-black bg-white border border-slate-200 text-slate-700"
            onClick={()=>{ setImportText(""); setImportPreview(null); }}
            disabled={importBusy}
          >
            クリア
          </button>
          <button
            className="px-4 py-2 rounded-2xl font-black bg-white border border-slate-200 text-slate-700"
            onClick={()=>setShowSample(v=>!v)}
            disabled={importBusy}
          >
            サンプル
          </button>
        </div>

        {showSample ? (
          <pre className="mt-3 text-xs font-bold bg-white border border-slate-200 rounded-2xl p-3 overflow-auto">{sampleText}</pre>
        ) : null}

        <div className="mt-2 text-[11px] font-bold text-slate-500">
          ※年度外（日付が {fyInfo.start}〜{fyInfo.end} の範囲外）はスキップします。
        </div>
      </div>

      {importPreview ? (
        <div className="rounded-3xl border border-slate-100 bg-white p-4">
          <div className="flex items-center justify-between gap-2 flex-wrap">
            <div className="font-black text-slate-800">プレビュー</div>
            <div className="flex items-center gap-2">
              <Pill tone="emerald">OK: {importPreview.ok}</Pill>
              <Pill tone="rose">NG: {importPreview.ng}</Pill>
              <Pill tone="amber">SKIP: {importPreview.skipped}</Pill>
            </div>
          </div>

          <div className="mt-3 max-h-[45vh] overflow-auto border border-slate-100 rounded-2xl">
            <table className="w-full text-xs">
              <thead className="sticky top-0 bg-slate-50">
                <tr>
                  <th className="p-2 text-left font-black text-slate-600">行</th>
                  <th className="p-2 text-left font-black text-slate-600">結果</th>
                  <th className="p-2 text-left font-black text-slate-600">内容</th>
                </tr>
              </thead>
              <tbody>
                {importPreview.rows.map((r, idx) => {
                  const ok = !!r.model && r.errors.length===0 && !r.skip;
                  return (
                    <tr key={idx} className="border-t border-slate-100">
                      <td className="p-2 font-black text-slate-600">{r.line}</td>
                      <td className="p-2">
                        {ok ? <Pill tone="emerald">OK</Pill> : r.skip ? <Pill tone="amber">SKIP</Pill> : <Pill tone="rose">NG</Pill>}
                      </td>
                      <td className="p-2">
                        <div className="font-bold text-slate-700 break-words">{r.raw}</div>
                        {r.errors?.length ? (
                          <div className="mt-1 text-[11px] font-black text-rose-700">{r.errors.join(" / ")}</div>
                        ) : null}
                        {r.warns?.length ? (
                          <div className="mt-1 text-[11px] font-black text-amber-700">{r.warns.join(" / ")}</div>
                        ) : null}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="mt-3 text-[11px] font-bold text-slate-500">
            ※OKの行のみ一括登録されます（インポート内の同室重複はNG扱い）。
          </div>
        </div>
      ) : null}
    </div>
  );
}

/**********************
 * Equipment Manager
 **********************/
function EquipmentManager({equipments, setEquipments, isLoggedIn, busy, onSaved, bumpReads, bumpWrites}){
  const list = useMemo(() => (equipments||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||""))), [equipments]);
  const [draft, setDraft] = useState(list);

  useEffect(()=>{ setDraft(list); }, [equipments]);

  const addNew = () => {
    const id = `eq_${Date.now().toString(36)}`;
    setDraft(prev => prev.concat([{ id, name:"新しい機材", abbr:"", countTotal:1, active:true, order:(prev.length+1)*10 }]));
  };

  const saveAll = async () => {
    if(!isLoggedIn) return;
    try{
      const batch = db.batch();
      const col = db.collection("equipments");
      draft.forEach(item=>{
        const payload = {
          name: String(item.name||"").trim(),
          abbr: String(item.abbr||"").trim(),
          countTotal: Number(item.countTotal||0),
          active: item.active !== false,
          order: Number(item.order||0),
          updatedAt: serverTimestamp(),
        };
        batch.set(col.doc(item.id), payload, {merge:true});
      });
      await batch.commit();
      bumpWrites(draft.length);
      await onSaved?.();
      alert("保存しました");
    }catch(e){
      console.error(e);
      alert("保存に失敗しました");
    }
  };

  return (
    <div className="space-y-3">
      <div className="flex items-center gap-2 flex-wrap">
        <button className={classNames("px-4 py-2 rounded-2xl font-black border",
          (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
          onClick={addNew}
          disabled={!isLoggedIn||busy}
        >
          ＋追加
        </button>
        <button className={classNames("px-4 py-2 rounded-2xl font-black border",
          (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
          onClick={saveAll}
          disabled={!isLoggedIn||busy}
        >
          保存
        </button>
        <div className="text-xs font-bold text-slate-400">※非表示は active をOFF（削除しません）</div>
      </div>

      <div className="overflow-auto rounded-3xl border border-slate-100">
        <table className="w-full text-sm bg-white">
          <thead className="bg-slate-50 sticky top-0">
            <tr>
              <th className="p-3 text-left font-black text-slate-600">表示</th>
              <th className="p-3 text-left font-black text-slate-600">名前</th>
              <th className="p-3 text-left font-black text-slate-600">略称</th>
              <th className="p-3 text-left font-black text-slate-600">総数</th>
              <th className="p-3 text-left font-black text-slate-600">順</th>
            </tr>
          </thead>
          <tbody>
            {draft.map((e, idx)=>(
              <tr key={e.id} className="border-t border-slate-100">
                <td className="p-3">
                  <input type="checkbox" checked={e.active !== false} disabled={!isLoggedIn||busy} onChange={(ev)=>{
                    const v = ev.target.checked;
                    setDraft(prev=>prev.map(x=>x.id===e.id?{...x, active:v}:x));
                  }}/>
                </td>
                <td className="p-3">
                  <input className="w-full rounded-xl border border-slate-200 px-3 py-2 font-bold"
                    value={e.name||""}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===e.id?{...x, name:ev.target.value}:x))}
                  />
                </td>
                <td className="p-3">
                  <input className="w-28 rounded-xl border border-slate-200 px-3 py-2 font-bold"
                    value={e.abbr||""}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===e.id?{...x, abbr:ev.target.value}:x))}
                  />
                </td>
                <td className="p-3">
                  <input type="number" min="0" className="w-24 rounded-xl border border-slate-200 px-3 py-2 font-bold text-right"
                    value={Number(e.countTotal||0)}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===e.id?{...x, countTotal:Number(ev.target.value||0)}:x))}
                  />
                </td>
                <td className="p-3">
                  <input type="number" className="w-20 rounded-xl border border-slate-200 px-3 py-2 font-bold text-right"
                    value={Number(e.order||0)}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===e.id?{...x, order:Number(ev.target.value||0)}:x))}
                  />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div className="text-xs font-bold text-slate-400">※保存すると全行を上書き保存します（安全側）。</div>
    </div>
  );
}

/**********************
 * Room Manager
 **********************/
function RoomManager({rooms, setRooms, isLoggedIn, busy, onSaved, bumpReads, bumpWrites}){
  const list = useMemo(() => (rooms||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.building||"").localeCompare(String(b.building||"")) || String(a.name||"").localeCompare(String(b.name||""))), [rooms]);
  const [draft, setDraft] = useState(list);

  useEffect(()=>{ setDraft(list); }, [rooms]);

  const addNew = () => {
    const id = `room_${Date.now().toString(36)}`;
    setDraft(prev => prev.concat([{ id, name:"新しい部屋", building:"本館", active:true, order:(prev.length+1)*10 }]));
  };

  const saveAll = async () => {
    if(!isLoggedIn) return;
    try{
      const batch = db.batch();
      const col = db.collection("rooms");
      draft.forEach(item=>{
        const payload = {
          name: String(item.name||"").trim(),
          building: String(item.building||"").trim(),
          active: item.active !== false,
          order: Number(item.order||0),
          updatedAt: serverTimestamp(),
        };
        batch.set(col.doc(item.id), payload, {merge:true});
      });
      await batch.commit();
      bumpWrites(draft.length);
      await onSaved?.();
      alert("保存しました");
    }catch(e){
      console.error(e);
      alert("保存に失敗しました");
    }
  };

  return (
    <div className="space-y-3">
      <div className="flex items-center gap-2 flex-wrap">
        <button className={classNames("px-4 py-2 rounded-2xl font-black border",
          (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
          onClick={addNew}
          disabled={!isLoggedIn||busy}
        >
          ＋追加
        </button>
        <button className={classNames("px-4 py-2 rounded-2xl font-black border",
          (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
          onClick={saveAll}
          disabled={!isLoggedIn||busy}
        >
          保存
        </button>
        <div className="text-xs font-bold text-slate-400">※非表示は active をOFF（削除しません）</div>
      </div>

      <div className="overflow-auto rounded-3xl border border-slate-100">
        <table className="w-full text-sm bg-white">
          <thead className="bg-slate-50 sticky top-0">
            <tr>
              <th className="p-3 text-left font-black text-slate-600">表示</th>
              <th className="p-3 text-left font-black text-slate-600">建物</th>
              <th className="p-3 text-left font-black text-slate-600">部屋名</th>
              <th className="p-3 text-left font-black text-slate-600">順</th>
            </tr>
          </thead>
          <tbody>
            {draft.map((r)=>(
              <tr key={r.id} className="border-t border-slate-100">
                <td className="p-3">
                  <input type="checkbox" checked={r.active !== false} disabled={!isLoggedIn||busy} onChange={(ev)=>{
                    const v = ev.target.checked;
                    setDraft(prev=>prev.map(x=>x.id===r.id?{...x, active:v}:x));
                  }}/>
                </td>
                <td className="p-3">
                  <input className="w-40 rounded-xl border border-slate-200 px-3 py-2 font-bold"
                    value={r.building||""}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===r.id?{...x, building:ev.target.value}:x))}
                  />
                </td>
                <td className="p-3">
                  <input className="w-full rounded-xl border border-slate-200 px-3 py-2 font-bold"
                    value={r.name||""}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===r.id?{...x, name:ev.target.value}:x))}
                  />
                </td>
                <td className="p-3">
                  <input type="number" className="w-20 rounded-xl border border-slate-200 px-3 py-2 font-bold text-right"
                    value={Number(r.order||0)}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===r.id?{...x, order:Number(ev.target.value||0)}:x))}
                  />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div className="text-xs font-bold text-slate-400">※保存すると全行を上書き保存します（安全側）。</div>
    </div>
  );
}

/**********************
 * Group Manager（最大100）
 **********************/
function GroupManager({groups, setGroups, isLoggedIn, busy, bumpReads, bumpWrites, onSaved}){
  const list = useMemo(() =>
    (groups||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
  , [groups]);

  const [draft, setDraft] = useState(list);
  const [newName, setNewName] = useState("");

  useEffect(()=>{ setDraft(list); }, [groups]);

  const addOne = () => {
    const name = String(newName||"").trim();
    if(!name) return;
    if(draft.filter(x => x.active !== false).length >= 100){
      alert("最大100団体です。非表示にして枠を空けてください。");
      return;
    }
    const id = `grp_${Date.now().toString(36)}`;
    setDraft(prev => prev.concat([{ id, name, active:true, order:(prev.length+1)*10 }]));
    setNewName("");
  };

  const saveAll = async () => {
    if(!isLoggedIn) return;
    const activeCount = draft.filter(x => x.active !== false).length;
    if(activeCount > 100){
      alert(`active が ${activeCount} 件あります（最大100）。いくつか非表示にしてください。`);
      return;
    }
    try{
      const batch = db.batch();
      const col = db.collection("groups");
      draft.forEach(item=>{
        const payload = {
          name: String(item.name||"").trim(),
          active: item.active !== false,
          order: Number(item.order||0),
          updatedAt: serverTimestamp(),
        };
        batch.set(col.doc(item.id), payload, {merge:true});
      });
      await batch.commit();
      bumpWrites(draft.length);
      await onSaved?.();
      alert("保存しました");
    }catch(e){
      console.error(e);
      alert("保存に失敗しました");
    }
  };

  return (
    <div className="mt-3 space-y-3">
      <div className="flex items-center gap-2 flex-wrap">
        <input
          className="flex-1 min-w-[220px] rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
          placeholder="団体名を追加（例：〇〇研究会）"
          value={newName}
          onChange={(e)=>setNewName(e.target.value)}
          disabled={!isLoggedIn||busy}
        />
        <button
          className={classNames("px-4 py-2 rounded-2xl font-black border",
            (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
          onClick={addOne}
          disabled={!isLoggedIn||busy}
        >
          追加
        </button>
        <button
          className={classNames("px-4 py-2 rounded-2xl font-black border",
            (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
          onClick={saveAll}
          disabled={!isLoggedIn||busy}
        >
          保存
        </button>
        <Pill tone="slate">active {draft.filter(x=>x.active!==false).length}/100</Pill>
      </div>

      <div className="overflow-auto rounded-3xl border border-slate-100 bg-white max-h-[40vh]">
        <table className="w-full text-sm">
          <thead className="bg-slate-50 sticky top-0">
            <tr>
              <th className="p-3 text-left font-black text-slate-600">表示</th>
              <th className="p-3 text-left font-black text-slate-600">団体名</th>
              <th className="p-3 text-left font-black text-slate-600">順</th>
            </tr>
          </thead>
          <tbody>
            {draft.map(g=>(
              <tr key={g.id} className="border-t border-slate-100">
                <td className="p-3">
                  <input
                    type="checkbox"
                    checked={g.active !== false}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>{
                      const v = ev.target.checked;
                      setDraft(prev=>prev.map(x=>x.id===g.id?{...x, active:v}:x));
                    }}
                  />
                </td>
                <td className="p-3">
                  <input
                    className="w-full rounded-xl border border-slate-200 px-3 py-2 font-bold"
                    value={g.name||""}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===g.id?{...x, name:ev.target.value}:x))}
                  />
                </td>
                <td className="p-3">
                  <input
                    type="number"
                    className="w-20 rounded-xl border border-slate-200 px-3 py-2 font-bold text-right"
                    value={Number(g.order||0)}
                    disabled={!isLoggedIn||busy}
                    onChange={(ev)=>setDraft(prev=>prev.map(x=>x.id===g.id?{...x, order:Number(ev.target.value||0)}:x))}
                  />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {!isLoggedIn ? (
        <div className="text-xs font-bold text-amber-700 bg-amber-50 border border-amber-100 rounded-2xl p-3">
          編集（追加/保存）にはログインが必要です。
        </div>
      ) : null}
    </div>
  );
}

/**********************
 * Staff Schedule Editor
 **********************/
function StaffScheduleEditor({dateKey, value, onChange, busy, onSave}){
  const options = ["", "在館", "打ち合わせ", "来校者", "出張", "休", "その他"];

  function setRole(role, key, v){
    onChange(prev => ({ ...prev, [role]: { ...(prev[role]||{}), [key]: v }}));
  }

  const roleLabel = { chief:"書記長", deputy:"書記次長" };

  return (
    <div className="mt-4 space-y-3">
      <div className="rounded-3xl border border-slate-100 bg-white p-4">
        <div className="font-black text-slate-800">動静（{dateKey}）</div>
        <div className="text-xs font-bold text-slate-500 mt-1">午前 / 午後 / 夕方（必要なら「その他」＋メモ）</div>

        <div className="mt-3 overflow-auto rounded-2xl border border-slate-100">
          <table className="w-full text-sm">
            <thead className="bg-slate-50">
              <tr>
                <th className="p-3 text-left font-black text-slate-600 w-28">役職</th>
                <th className="p-3 text-left font-black text-slate-600">午前</th>
                <th className="p-3 text-left font-black text-slate-600">午後</th>
                <th className="p-3 text-left font-black text-slate-600">夕方</th>
              </tr>
            </thead>
            <tbody>
              {["chief","deputy"].map(role=>(
                <tr key={role} className="border-t border-slate-100">
                  <td className="p-3 font-black text-slate-800">{roleLabel[role]}</td>
                  {["morning","afternoon","evening"].map(k=>(
                    <td key={k} className="p-3">
                      <select
                        className="w-full rounded-xl border border-slate-200 px-3 py-2 font-bold"
                        value={value?.[role]?.[k] || ""}
                        onChange={(e)=>setRole(role, k, e.target.value)}
                        disabled={busy}
                      >
                        {options.map((o, i)=><option key={i} value={o}>{o || "—"}</option>)}
                      </select>
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div className="mt-3 grid md:grid-cols-2 gap-3">
          {["chief","deputy"].map(role=>(
            <div key={role} className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">{roleLabel[role]} メモ</div>
              <textarea
                className="mt-2 w-full h-24 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700"
                value={value?.[role]?.note || ""}
                onChange={(e)=>setRole(role, "note", e.target.value)}
                placeholder="例：13:30 来館者〇〇 / 16:00 外出 など"
                disabled={busy}
              />
            </div>
          ))}
        </div>

        <div className="mt-3 flex gap-2">
          <button
            className={classNames("w-full rounded-2xl px-4 py-3 font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
            onClick={onSave}
            disabled={busy}
          >
            保存
          </button>
        </div>
      </div>
    </div>
  );
}

/**********************
 * React render
 **********************/
ReactDOM.createRoot(document.getElementById("app")).render(<App />);
  </script>
</body>
</html>
