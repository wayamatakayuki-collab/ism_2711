<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>夷隅教育会館 管理（部屋予約・機材・動静）</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (CDN / compat) -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }

    /* ===== 週間表（時間軸） ===== */
    .weekgrid { --rowH: 26px; }
    .weekgrid .timeCol { width: 64px; }
    .weekgrid .dayCol { min-width: 180px; }

    /* 予約ブロック */
    .evt {
      position: absolute;
      border-radius: 14px;
      padding: 6px 8px;
      line-height: 1.2;
      overflow: hidden;
      border: 1px solid rgba(2,132,199,.25);
      background: rgba(224,242,254,.95);
    }
    .evt .t { font-size: 11px; font-weight: 900; color: #0f172a; }
    .evt .s { font-size: 11px; font-weight: 800; color: #075985; margin-top: 2px; }
    .evt .m { font-size: 10px; font-weight: 800; color: #64748b; margin-top: 2px; }

    /* 月表示 */
    .calGrid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 6px; }
    .calCell { min-height: 64px; }

    /* ===== 印刷（A4横） ===== */
    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .print-card { break-inside: avoid; page-break-inside: avoid; }
      .print-tight { font-size: 10.5px; }
      .print-table td, .print-table th { padding: 5px !important; }
      .weekgrid { --rowH: 18px; }
      .evt { padding: 4px 6px; }
      .evt .t, .evt .s { font-size: 9.5px; }
      .evt .m { display: none; }
    }
    .print-only { display: none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="app"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /**********************
     * 固定設定（共通ID方式）
     **********************/
    const SHARED_LOGIN_CODE = "ismkaikan";
    const SHARED_EMAIL = `${SHARED_LOGIN_CODE}@shared.local`; // Firebase Authはメール形式が必要
    const CACHE_PREFIX = "ismkaikan_cache_v3";
    const OPS_KEY = "ismkaikan_ops_v1"; // read/write概算（月単位で保存）

    // 週間表の表示範囲（ユーザー指定：A）
    const WEEK_START_MIN = 8*60;
    const WEEK_END_MIN   = 20*60;
    const SLOT_MIN = 10; // 内部は10分

    /**********************
     * Firebase 初期化（あなたの設定）
     **********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAfO6ZAOlAZg-yG8ja3fR3U-zEnqMwmpw8",
      authDomain: "ism2711-49523.firebaseapp.com",
      projectId: "ism2711-49523",
      storageBucket: "ism2711-49523.firebasestorage.app",
      messagingSenderId: "44334771941",
      appId: "1:44334771941:web:a55badc93b3f6bdf59ee0c",
      measurementId: "G-M4SWCYYH82"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    /**********************
     * マスタ（部屋）
     **********************/
    const ROOMS = [
      { id: "honkan_oo", name: "大会議室", building: "本館" },
      { id: "honkan_chu", name: "中会議室", building: "本館" },
      { id: "honkan_sho", name: "小会議室", building: "本館" },
      { id: "honkan_ousetsu", name: "応接室", building: "本館" },
      { id: "honkan_nihon", name: "日本間", building: "本館" },
      { id: "honkan_print", name: "印刷室", building: "本館" },
      { id: "honkan_library", name: "図書室", building: "本館" },
      { id: "honkan_lab", name: "研究所", building: "本館" },
      { id: "bekkan_1f", name: "１階会議室", building: "別館" },
      { id: "bekkan_2f", name: "２階会議室", building: "別館" },
    ];

    const DEFAULT_EQUIPMENTS = [
      { id: "projector", name: "プロジェクター", countTotal: 3, active: true },
      { id: "pc", name: "PC", countTotal: 10, active: true },
    ];

    /**********************
     * ユーティリティ
     **********************/
    function pad2(n){ return String(n).padStart(2,"0"); }

    function todayKeyLocal(d = new Date()){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      return `${y}-${m}-${day}`;
    }

    function monthKeyLocal(d = new Date()){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      return `${y}-${m}`;
    }

    function parseKeyToDate(key){
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    function addDaysKey(key, addDays){
      const dt = parseKeyToDate(key);
      dt.setDate(dt.getDate() + addDays);
      return todayKeyLocal(dt);
    }

    function startOfWeekMonday(key){
      const dt = parseKeyToDate(key);
      const dow = dt.getDay();
      const diff = (dow === 0) ? -6 : (1 - dow); // Monday start
      dt.setDate(dt.getDate() + diff);
      return todayKeyLocal(dt);
    }

    function minToHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return `${pad2(h)}:${pad2(m)}`;
    }

    function hhmmToMin(hhmm){
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    }

    function timeOptions10min(){
      const opts = [];
      for(let m=0; m<=23*60+50; m+=10){
        opts.push({ label: minToHHMM(m), value: m });
      }
      return opts;
    }

    function classNames(...xs){ return xs.filter(Boolean).join(" "); }

    function saveCache(key, value){
      try{ localStorage.setItem(key, JSON.stringify({ at: Date.now(), value })); }catch(e){}
    }
    function loadCache(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed?.value ?? null;
      }catch(e){ return null; }
    }

    function overlaps(aStart, aEnd, bStart, bEnd){
      return (aStart < bEnd) && (bStart < aEnd);
    }

    function clampInt(n, min, max){
      const v = Number(n);
      if(Number.isNaN(v)) return min;
      return Math.max(min, Math.min(max, Math.trunc(v)));
    }

    function isValidDateKey(key){
      return /^\d{4}-\d{2}-\d{2}$/.test(key);
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // RFC4180簡易CSVパーサ（クォート対応）
    function parseCSV(text){
      const rows = [];
      let i = 0;
      let field = "";
      let row = [];
      let inQuotes = false;

      while(i < text.length){
        const c = text[i];

        if(inQuotes){
          if(c === '"'){
            if(text[i+1] === '"'){
              field += '"';
              i += 2;
              continue;
            }else{
              inQuotes = false;
              i++;
              continue;
            }
          }else{
            field += c;
            i++;
            continue;
          }
        }else{
          if(c === '"'){
            inQuotes = true;
            i++;
            continue;
          }
          if(c === ','){
            row.push(field);
            field = "";
            i++;
            continue;
          }
          if(c === "\r"){ i++; continue; }
          if(c === "\n"){
            row.push(field);
            rows.push(row);
            row = [];
            field = "";
            i++;
            continue;
          }
          field += c;
          i++;
        }
      }
      row.push(field);
      const allEmpty = row.every(x => (x ?? "").trim() === "");
      if(!allEmpty) rows.push(row);
      return rows;
    }

    function toCSVRow(fields){
      return fields.map(v => {
        const s = (v ?? "").toString();
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(",");
    }

    function roomName(roomId){
      return ROOMS.find(r=>r.id===roomId)?.name ?? roomId;
    }
    function roomBuilding(roomId){
      return ROOMS.find(r=>r.id===roomId)?.building ?? "";
    }

    function fiscalYearFromDateKey(key){
      const d = parseKeyToDate(key);
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      return (m>=4) ? y : (y-1);
    }
    function fiscalRange(year){
      const start = `${year}-04-01`;
      const end = `${year+1}-03-31`;
      return { start, end };
    }

    function monthRange(year, month){
      // month: 1-12
      const start = `${year}-${pad2(month)}-01`;
      const dt = new Date(year, month, 0); // last day of month
      const end = `${year}-${pad2(month)}-${pad2(dt.getDate())}`;
      return { start, end };
    }

    function ymdFromDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function buildMonthCalendar(year, month){
      // returns array length multiple of 7 of {dateKey|null, day, inMonth}
      const first = new Date(year, month-1, 1);
      const last = new Date(year, month, 0);
      const daysInMonth = last.getDate();

      // weekday (Mon=0..Sun=6)
      const wk = (first.getDay()===0) ? 6 : (first.getDay()-1);
      const cells = [];
      for(let i=0;i<wk;i++) cells.push({ dateKey:null, day:"", inMonth:false });
      for(let d=1; d<=daysInMonth; d++){
        const dt = new Date(year, month-1, d);
        cells.push({ dateKey: ymdFromDate(dt), day: String(d), inMonth:true });
      }
      while(cells.length % 7 !== 0) cells.push({ dateKey:null, day:"", inMonth:false });
      return cells;
    }

    /**********************
     * UI部品
     **********************/
    const Pill = ({children, tone="slate"}) => {
      const map = {
        slate: "bg-slate-100 text-slate-700 border-slate-200",
        sky: "bg-sky-50 text-sky-700 border-sky-200",
        emerald: "bg-emerald-50 text-emerald-700 border-emerald-200",
        rose: "bg-rose-50 text-rose-700 border-rose-200",
        amber: "bg-amber-50 text-amber-700 border-amber-200",
        violet: "bg-violet-50 text-violet-700 border-violet-200",
      };
      return (
        <span className={classNames("inline-flex items-center gap-1 px-2 py-1 rounded-xl text-[12px] font-black border", map[tone] || map.slate)}>
          {children}
        </span>
      );
    };

    const Card = ({children, printCard=false}) => (
      <div className={classNames("bg-white rounded-3xl p-4 shadow-sm border border-slate-100", printCard ? "print-card" : "")}>
        {children}
      </div>
    );

    const SectionTitle = ({icon, title, sub, right}) => (
      <div className="flex items-end justify-between gap-2 flex-wrap">
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-700 font-black">
              {icon}
            </div>
            <div className="text-lg font-black text-slate-800">{title}</div>
          </div>
          {sub ? <div className="text-xs font-bold text-slate-400">{sub}</div> : null}
        </div>
        {right ? <div className="flex items-center gap-2">{right}</div> : null}
      </div>
    );

    const Modal = ({open, onClose, title, children}) => {
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 no-print">
          <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
          <div className="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-3">
            <div className="w-full md:max-w-3xl bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
              <div className="p-4 border-b border-slate-100 flex items-center justify-between">
                <div className="font-black text-slate-800">{title}</div>
                <button className="px-3 py-2 rounded-2xl bg-slate-100 font-black text-slate-700" onClick={onClose}>閉じる</button>
              </div>
              <div className="p-4 space-y-4">
                {children}
              </div>
            </div>
          </div>
        </div>
      );
    };

    function TabButton({active, onClick, children}){
      return (
        <button
          onClick={onClick}
          className={classNames(
            "rounded-2xl py-3 font-black border shadow-sm",
            active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200"
          )}
        >
          {children}
        </button>
      );
    }

    /**********************
     * read/write概算カウンタ（月単位）
     **********************/
    function loadOps(){
      const mk = monthKeyLocal();
      try{
        const raw = localStorage.getItem(OPS_KEY);
        if(!raw) return { month: mk, reads: 0, writes: 0 };
        const obj = JSON.parse(raw);
        if(obj?.month !== mk){
          return { month: mk, reads: 0, writes: 0 };
        }
        return {
          month: mk,
          reads: Number(obj.reads || 0),
          writes: Number(obj.writes || 0),
        };
      }catch(e){
        return { month: mk, reads: 0, writes: 0 };
      }
    }
    function saveOps(ops){
      try{ localStorage.setItem(OPS_KEY, JSON.stringify(ops)); }catch(e){}
    }

    /**********************
     * 週間表：重なりレイアウト
     **********************/
    function layoutOverlaps(events){
      // events: [{startMin,endMin,...}]
      const list = (events||[]).slice().sort((a,b)=>(a.startMin||0)-(b.startMin||0) || (a.endMin||0)-(b.endMin||0));
      const placed = [];

      // Greedy column assignment
      const active = []; // {endMin, col, evt}
      let maxCol = 0;

      for(const evt of list){
        // remove ended
        for(let i=active.length-1;i>=0;i--){
          if((active[i].endMin||0) <= (evt.startMin||0)) active.splice(i,1);
        }
        // find first free col
        const usedCols = new Set(active.map(x=>x.col));
        let col = 0;
        while(usedCols.has(col)) col++;
        active.push({ endMin: evt.endMin||0, col, evt });
        maxCol = Math.max(maxCol, col);

        placed.push({ ...evt, _col: col });
      }

      // Now compute max columns per overlap group.
      // Simple approach: for each evt, find max concurrent among those overlapping it.
      const maxColsFor = new Map();
      for(const a of placed){
        let cols = 1;
        for(const b of placed){
          if(a===b) continue;
          if(overlaps(a.startMin,a.endMin,b.startMin,b.endMin)){
            cols = Math.max(cols, Math.max(a._col,b._col)+1);
          }
        }
        maxColsFor.set(a.id, cols);
      }

      return placed.map(e => ({ ...e, _cols: maxColsFor.get(e.id) || 1 }));
    }

    /**********************
     * メイン
     **********************/
    function App(){
      const [user, setUser] = useState(null);
      const [authReady, setAuthReady] = useState(false);

      const [tab, setTab] = useState("home"); // home | monitor | reserve | year | equip | presence | settings
      const [selectedDate, setSelectedDate] = useState(todayKeyLocal());

      const [busy, setBusy] = useState(false);
      const [toast, setToast] = useState(null);

      const [reservations, setReservations] = useState([]);         // 選択日
      const [weekReservations, setWeekReservations] = useState([]); // 週範囲
      const [presence, setPresence] = useState(null);
      const [equipments, setEquipments] = useState(DEFAULT_EQUIPMENTS);
      const [templates, setTemplates] = useState([]); // 団体テンプレ

      const [editorOpen, setEditorOpen] = useState(false);
      const [editTarget, setEditTarget] = useState(null);

      const [reserveView, setReserveView] = useState("day"); // day | weektime | month
      const [csvOpen, setCsvOpen] = useState(false);

      const [ops, setOps] = useState(loadOps());

      // 年度/月表示
      const fy = useMemo(()=>fiscalYearFromDateKey(selectedDate), [selectedDate]);
      const fyRange = useMemo(()=>fiscalRange(fy), [fy]);
      const [fyMonth, setFyMonth] = useState(null); // 4-12,1-3
      const [monthReservations, setMonthReservations] = useState([]);
      const [monthBusy, setMonthBusy] = useState(false);

// 月一覧（部屋予約タブ用）
const [monthReserveKey, setMonthReserveKey] = useState(null); // "YYYY-MM"
const [monthReserveList, setMonthReserveList] = useState([]);
const [monthReserveBusy, setMonthReserveBusy] = useState(false);

// 年間：動静（月）
const [presenceMonth, setPresenceMonth] = useState([]);
const [presenceMonthBusy, setPresenceMonthBusy] = useState(false);

const presenceMonthMap = useMemo(() => {
  const m = {};
  for(const p of presenceMonth || []){
    if(p?.date) m[p.date] = p;
  }
  return m;
}, [presenceMonth]);

const [presenceDayOpen, setPresenceDayOpen] = useState(false);
const [presenceDayKey, setPresenceDayKey] = useState(null);


      // 検索
      const [searchOpen, setSearchOpen] = useState(false);
      const [searchQ, setSearchQ] = useState("");
      const [searchRes, setSearchRes] = useState([]);
      const [searchBusy, setSearchBusy] = useState(false);

      const isLoggedIn = !!user;
      const opts10 = useMemo(() => timeOptions10min(), []);

      const weekStart = useMemo(() => startOfWeekMonday(selectedDate), [selectedDate]);
      const weekKeys = useMemo(() => Array.from({length:7}, (_,i)=>addDaysKey(weekStart, i)), [weekStart]);
      const weekEnd = weekKeys[6];

      const equipmentsMap = useMemo(() => {
        const m = {};
        for(const e of equipments || []) m[e.id] = e;
        return m;
      }, [equipments]);

      // Auth監視
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          setUser(u || null);
          setAuthReady(true);
        });
        return () => unsub && unsub();
      }, []);

      // ops永続化
      useEffect(() => { saveOps(ops); }, [ops]);

      function bumpReads(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, reads: base.reads + Number(n||0) };
        });
      }
      function bumpWrites(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, writes: base.writes + Number(n||0) };
        });
      }
      function resetOps(){
        const mk = monthKeyLocal();
        if(!confirm(`${mk} の read/write（概算）をリセットしますか？`)) return;
        setOps({ month: mk, reads: 0, writes: 0 });
      }

      // キャッシュ読み込み（選択日・週）
      useEffect(() => {
        const rKey = `${CACHE_PREFIX}:reservations:${selectedDate}`;
        const pKey = `${CACHE_PREFIX}:presence:${selectedDate}`;
        const eKey = `${CACHE_PREFIX}:equipments`;
        const tKey = `${CACHE_PREFIX}:templates`;
        const wKey = `${CACHE_PREFIX}:weekReservations:${weekStart}`;

        const cr = loadCache(rKey);
        const cp = loadCache(pKey);
        const ce = loadCache(eKey);
        const ct = loadCache(tKey);
        const cw = loadCache(wKey);

        if(cr) setReservations(cr);
        if(cp) setPresence(cp);
        if(ce) setEquipments(ce);
        if(ct) setTemplates(ct);
        if(cw) setWeekReservations(cw);
      }, [selectedDate, weekStart]);

      // 初期：年度月を4月に
      useEffect(() => {
        if(fyMonth == null){
          setFyMonth(4);
        }
      }, [fy, fyMonth]);

      // 共通IDログイン
      async function loginWithShared(password){
        setBusy(true);
        try{
          await auth.signInWithEmailAndPassword(SHARED_EMAIL, password);
          setToast({ type:"ok", msg:"ログインしました（編集できます）" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ログインできません（PWが違う/ユーザー未作成）" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2600);
        }
      }

      async function logout(){
        await auth.signOut();
        setToast({ type:"ok", msg:"ログアウトしました" });
        setTimeout(()=>setToast(null), 2000);
      }

      // Firestore読込（手動更新）
      async function refreshAll(){
        setBusy(true);
        try{
          // 選択日の予約
          const rsSnap = await db.collection("reservations")
            .where("date","==",selectedDate)
            .get();
          bumpReads(rsSnap.size);

          const rs = rsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b) => (a.roomId||"").localeCompare(b.roomId||"") || (a.startMin||0)-(b.startMin||0));
          setReservations(rs);
          saveCache(`${CACHE_PREFIX}:reservations:${selectedDate}`, rs);

          // presence
          const pDoc = await db.collection("presence").doc(selectedDate).get();
          bumpReads(1);
          const pv = pDoc.exists ? pDoc.data() : null;
          setPresence(pv);
          saveCache(`${CACHE_PREFIX}:presence:${selectedDate}`, pv);

          // equipments
          const eSnap = await db.collection("equipments").get();
          bumpReads(eSnap.size);
          const ev = eSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          if(ev.length){
            setEquipments(ev);
            saveCache(`${CACHE_PREFIX}:equipments`, ev);
          }else{
            setEquipments(DEFAULT_EQUIPMENTS);
            saveCache(`${CACHE_PREFIX}:equipments`, DEFAULT_EQUIPMENTS);
          }

          // templates
          const tDoc = await db.collection("settings").doc("templates").get();
          bumpReads(1);
          const tv = (tDoc.exists && Array.isArray(tDoc.data()?.groups)) ? tDoc.data().groups : [];
          setTemplates(tv);
          saveCache(`${CACHE_PREFIX}:templates`, tv);

          // 週表示中なら週も更新
          if(tab === "reserve" && reserveView === "weektime"){
            await refreshWeek();
          }

          setToast({ type:"ok", msg:"更新しました" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"更新に失敗しました（Firestore設定/ルールを確認）" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2400);
        }
      }

      async function refreshWeek(){
        const wSnap = await db.collection("reservations")
          .where("date", ">=", weekStart)
          .where("date", "<=", weekEnd)
          .get();
        bumpReads(wSnap.size);

        const wr = wSnap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a,b) =>
            (a.date||"").localeCompare(b.date||"")
            || (a.roomId||"").localeCompare(b.roomId||"")
            || (a.startMin||0)-(b.startMin||0)
          );
        setWeekReservations(wr);
        saveCache(`${CACHE_PREFIX}:weekReservations:${weekStart}`, wr);
      }

      async function refreshMonth(year, month){
        const r = monthRange(year, month);
        setMonthBusy(true);
        try{
          const snap = await db.collection("reservations")
            .where("date", ">=", r.start)
            .where("date", "<=", r.end)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.startMin||0)-(b.startMin||0));
          setMonthReservations(list);
          saveCache(`${CACHE_PREFIX}:monthReservations:${year}-${pad2(month)}`, list);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"月の読み込みに失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setMonthBusy(false);
        }


async function refreshMonthReserve(year, month){
  const mk = `${year}-${pad2(month)}`;
  setMonthReserveKey(mk);
  setMonthReserveBusy(true);
  try{
    const cacheKey = `${CACHE_PREFIX}:monthReserve:${mk}`;
    const cached = loadCache(cacheKey);
    if(cached){
      setMonthReserveList(cached);
    }
    const r = monthRange(year, month);
    const snap = await db.collection("reservations")
      .where("date", ">=", r.start)
      .where("date", "<=", r.end)
      .get();
    bumpReads(snap.size);
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.roomId||"").localeCompare(b.roomId||"") || (a.startMin||0)-(b.startMin||0));
    setMonthReserveList(list);
    saveCache(cacheKey, list);
  }catch(err){
    console.error(err);
    setToast({ type:"ng", msg:"月一覧の読み込みに失敗しました" });
    setTimeout(()=>setToast(null), 2400);
  }finally{
    setMonthReserveBusy(false);
  }
}

async function refreshPresenceMonth(year, month){
  setPresenceMonthBusy(true);
  try{
    const mk = `${year}-${pad2(month)}`;
    const cacheKey = `${CACHE_PREFIX}:presenceMonth:${mk}`;
    const cached = loadCache(cacheKey);
    if(cached) setPresenceMonth(cached);

    const r = monthRange(year, month);
    const snap = await db.collection("presence")
      .where("date", ">=", r.start)
      .where("date", "<=", r.end)
      .get();
    bumpReads(snap.size);
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .filter(x => x.date)
      .sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    setPresenceMonth(list);
    saveCache(cacheKey, list);
  }catch(err){
    console.error(err);
    setToast({ type:"ng", msg:"動静（月）の読み込みに失敗しました" });
    setTimeout(()=>setToast(null), 2400);
  }finally{
    setPresenceMonthBusy(false);
  }
}

      }

      // 年度タブに入ったら月データを読み込む（更新ボタン方式に寄せつつ、自動は最小）
      useEffect(() => {
        if(tab !== "year") return;
        if(fyMonth == null) return;

        // fiscal month -> actual year/month
        const actualYear = (fyMonth >= 4) ? fy : (fy+1);
        const actualMonth = fyMonth;
        const cacheKey = `${CACHE_PREFIX}:monthReservations:${actualYear}-${pad2(actualMonth)}`;
        const cached = loadCache(cacheKey);
        // 動静（月）キャッシュ
        const pCacheKey = `${CACHE_PREFIX}:presenceMonth:${actualYear}-${pad2(actualMonth)}`;
        const pCached = loadCache(pCacheKey);
        if(pCached) setPresenceMonth(pCached);

        if(cached){
          setMonthReservations(cached);
        }else{
          // 初回だけ自動取得（年度タブで真っ白回避）
          refreshMonth(actualYear, actualMonth);
          refreshPresenceMonth(actualYear, actualMonth);
        }
      }, [tab, fyMonth, fy]);

      function openNew(){
        setEditTarget({
          id: null,
          date: selectedDate,
          roomId: ROOMS[0].id,
          startMin: hhmmToMin("09:00"),
          endMin: hhmmToMin("10:00"),
          groupName: "",
          note: "",
          equipment: { projector: 0, pc: 0 },
        });
        setEditorOpen(true);
      }

      function openEdit(r){
        setEditTarget({
          id: r.id,
          date: r.date,
          roomId: r.roomId,
          startMin: r.startMin ?? 0,
          endMin: r.endMin ?? 0,
          groupName: r.groupName ?? "",
          note: r.note ?? "",
          equipment: {
            projector: Number(r?.equipment?.projector ?? 0),
            pc: Number(r?.equipment?.pc ?? 0),
          },
        });
        setEditorOpen(true);
      }

      function getReservationsForDate(dateKey){
        if(dateKey === selectedDate) return reservations;
        return (weekReservations || []).filter(x => x.date === dateKey);
      }

      async function saveReservation(model){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"編集にはログインが必要です" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const g = (model.groupName||"").trim();
        if(!g){
          setToast({ type:"ng", msg:"団体名は必須です" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const sMin = Number(model.startMin);
        const eMin = Number(model.endMin);
        if(!(eMin > sMin)){
          setToast({ type:"ng", msg:"終了時刻は開始時刻より後にしてください" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        if((sMin % 10 !== 0) || (eMin % 10 !== 0)){
          setToast({ type:"ng", msg:"時刻は10分単位で入力してください" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }

        const sameDate = getReservationsForDate(model.date);

        // 1) 部屋の重複チェック
        const sameRoom = sameDate.filter(x => x.roomId===model.roomId && x.id !== model.id);
        const conflict = sameRoom.some(x => overlaps(sMin, eMin, x.startMin||0, x.endMin||0));
        if(conflict){
          setToast({ type:"ng", msg:"同じ部屋で時間が重複しています（予約不可）" });
          setTimeout(()=>setToast(null), 2600);
          return;
        }

        // 2) 機材の同時間帯チェック（同日・全室）
        const overlapsAny = sameDate
          .filter(x => x.id !== model.id)
          .filter(x => overlaps(sMin, eMin, x.startMin||0, x.endMin||0));

        const need = {
          projector: Number(model?.equipment?.projector ?? 0),
          pc: Number(model?.equipment?.pc ?? 0),
        };

        const used = { projector: 0, pc: 0 };
        for(const r of overlapsAny){
          used.projector += Number(r?.equipment?.projector ?? 0);
          used.pc += Number(r?.equipment?.pc ?? 0);
        }
        const totals = {
          projector: Number(equipmentsMap.projector?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="projector")?.countTotal ?? 0),
          pc: Number(equipmentsMap.pc?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="pc")?.countTotal ?? 0),
        };
        const after = {
          projector: used.projector + need.projector,
          pc: used.pc + need.pc,
        };

        const warnings = [];
        if(totals.projector > 0 && after.projector > totals.projector){
          warnings.push(`プロジェクターが総数 ${totals.projector} を超えます（同時間帯 合計 ${after.projector}）`);
        }
        if(totals.pc > 0 && after.pc > totals.pc){
          warnings.push(`PCが総数 ${totals.pc} を超えます（同時間帯 合計 ${after.pc}）`);
        }

        if(warnings.length){
          const ok = confirm(`【機材の警告】\n${warnings.join("\n")}\n\nそれでも保存しますか？`);
          if(!ok) return;
        }

        setBusy(true);
        try{
          const payload = {
            date: model.date,
            roomId: model.roomId,
            startMin: sMin,
            endMin: eMin,
            groupName: g,
            note: (model.note||"").trim(),
            equipment: {
              projector: Number(model?.equipment?.projector ?? 0),
              pc: Number(model?.equipment?.pc ?? 0),
            },
            updatedAt: serverTimestamp(),
          };

          if(model.id){
            await db.collection("reservations").doc(model.id).set(payload, { merge:true });
            bumpWrites(1);
          }else{
            await db.collection("reservations").add({ ...payload, createdAt: serverTimestamp() });
            bumpWrites(1);
          }

          setEditorOpen(false);
          setEditTarget(null);

          await refreshAll();
          if(tab === "reserve" && reserveView === "weektime") await refreshWeek();
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"保存に失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      async function deleteReservation(id){
        if(!isLoggedIn) return;
        if(!confirm("この予約を削除しますか？")) return;
        setBusy(true);
        try{
          await db.collection("reservations").doc(id).delete();
          bumpWrites(1);
          await refreshAll();
          if(tab === "reserve" && reserveView === "weektime") await refreshWeek();
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"削除に失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // presence
      async function setPresenceValue(dateKey, personKey, slotKey, value){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"編集にはログインが必要です" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        setBusy(true);
        try{
          const base = (dateKey === selectedDate) ? (presence || {}) : (presenceMonthMap[dateKey] || {});
          const next = {
            ...base,
            [personKey]: {
              ...(base[personKey] || {}),
              [slotKey]: value,
            }
          };
          await db.collection("presence").doc(dateKey).set({ ...next, date: dateKey, updatedAt: serverTimestamp() }, { merge:true });
          bumpWrites(1);


if(dateKey === selectedDate){
  setPresence(next);
  saveCache(`${CACHE_PREFIX}:presence:${selectedDate}`, next);
}

setPresenceMonth(prev => {
  const arr = (prev || []).slice();
  const idx = arr.findIndex(x => x.date === dateKey);
  const item = { ...(idx>=0 ? arr[idx] : {}), ...next, date: dateKey };
  if(idx>=0) arr[idx] = item;
  else arr.push(item);
  arr.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  return arr;
});

          setToast({ type:"ok", msg:"動静を保存しました" });
          setTimeout(()=>setToast(null), 1600);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"動静の保存に失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // equipments 初期データ作成
      async function seedEquipments(){
        if(!isLoggedIn) return;
        if(!confirm("機材マスタ（初期データ）を作成しますか？\n※既にあるものは上書きしません")) return;
        setBusy(true);
        try{
          const batch = db.batch();
          let willWrite = 0;
          for(const e of DEFAULT_EQUIPMENTS){
            const ref = db.collection("equipments").doc(e.id);
            const snap = await ref.get();
            bumpReads(1);
            if(!snap.exists){
              batch.set(ref, { name:e.name, countTotal:e.countTotal, active:e.active, updatedAt: serverTimestamp() });
              willWrite++;
            }
          }
          await batch.commit();
          bumpWrites(willWrite);
          await refreshAll();
          setToast({ type:"ok", msg:"機材マスタを作成しました" });
          setTimeout(()=>setToast(null), 2200);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"作成に失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // templates 保存
      async function saveTemplates(next){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"編集にはログインが必要です" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const cleaned = (next||[])
          .map(s => (s||"").trim())
          .filter(s => s);
        const uniq = [];
        const seen = new Set();
        for(const s of cleaned){
          if(seen.has(s)) continue;
          seen.add(s);
          uniq.push(s);
        }
        setBusy(true);
        try{
          await db.collection("settings").doc("templates").set({ groups: uniq, updatedAt: serverTimestamp() }, { merge:true });
          bumpWrites(1);
          setTemplates(uniq);
          saveCache(`${CACHE_PREFIX}:templates`, uniq);
          setToast({ type:"ok", msg:"テンプレを保存しました" });
          setTimeout(()=>setToast(null), 1800);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"テンプレの保存に失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      // CSV：エクスポート
      async function exportCSV(rangeStart, rangeEnd){
        if(!isValidDateKey(rangeStart) || !isValidDateKey(rangeEnd)){
          alert("日付範囲が正しくありません");
          return;
        }
        if(rangeEnd < rangeStart){
          alert("終了日は開始日以降にしてください");
          return;
        }
        setBusy(true);
        try{
          const snap = await db.collection("reservations")
            .where("date", ">=", rangeStart)
            .where("date", "<=", rangeEnd)
            .get();
          bumpReads(snap.size);

          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.roomId||"").localeCompare(b.roomId||"") || (a.startMin||0)-(b.startMin||0));

          const header = [
            "id","date","building","roomId","roomName","start","end","groupName","projector","pc","note"
          ];
          const lines = [toCSVRow(header)];
          for(const r of list){
            lines.push(toCSVRow([
              r.id,
              r.date,
              roomBuilding(r.roomId),
              r.roomId,
              roomName(r.roomId),
              minToHHMM(r.startMin||0),
              minToHHMM(r.endMin||0),
              r.groupName || "",
              Number(r?.equipment?.projector ?? 0),
              Number(r?.equipment?.pc ?? 0),
              r.note || ""
            ]));
          }
          const csv = lines.join("\n");
          const filename = `ismkaikan_reservations_${rangeStart}_to_${rangeEnd}.csv`;
          downloadText(filename, csv);
          setToast({ type:"ok", msg:"CSVを書き出しました" });
          setTimeout(()=>setToast(null), 2000);
        }catch(err){
          console.error(err);
          alert("CSV書き出しに失敗しました");
        }finally{
          setBusy(false);
        }
      }

      // CSV：インポート（安全モード：部屋重複/機材超過はスキップ。idがあれば更新）
      async function importCSV(file){
        if(!isLoggedIn){
          alert("インポートはログイン後に行ってください");
          return;
        }
        const text = await file.text();
        const rows = parseCSV(text);
        if(rows.length < 2){
          alert("CSVにデータがありません");
          return;
        }

        const header = rows[0].map(x => (x||"").trim());
        const idx = (name) => header.findIndex(h => h === name);

        const i_id = idx("id");
        const i_date = idx("date");
        const i_roomId = idx("roomId");
        const i_roomName = idx("roomName");
        const i_building = idx("building");
        const i_start = idx("start");
        const i_end = idx("end");
        const i_group = idx("groupName");
        const i_pj = idx("projector");
        const i_pc = idx("pc");
        const i_note = idx("note");

        if(i_date < 0 || (i_roomId < 0 && i_roomName < 0) || i_start < 0 || i_end < 0 || i_group < 0){
          alert("CSVのヘッダが不足しています。\n必須: date, roomId(またはroomName), start, end, groupName");
          return;
        }

        const parsed = [];
        const errors = [];

        for(let r=1; r<rows.length; r++){
          const row = rows[r];
          const get = (i) => (i>=0 ? (row[i] ?? "").trim() : "");

          const date = get(i_date);
          const startStr = get(i_start);
          const endStr = get(i_end);
          const groupName = get(i_group);

          let roomId = get(i_roomId);
          const roomNameVal = get(i_roomName);
          const buildingVal = get(i_building);

          if(!isValidDateKey(date)){
            errors.push(`行${r+1}: dateが不正 (${date})`);
            continue;
          }
          if(!/^\d{2}:\d{2}$/.test(startStr) || !/^\d{2}:\d{2}$/.test(endStr)){
            errors.push(`行${r+1}: start/endが不正 (${startStr} - ${endStr})`);
            continue;
          }
          const startMin = hhmmToMin(startStr);
          const endMin = hhmmToMin(endStr);
          if(startMin % 10 !== 0 || endMin % 10 !== 0){
            errors.push(`行${r+1}: 時刻が10分単位ではありません (${startStr} - ${endStr})`);
            continue;
          }
          if(!(endMin > startMin)){
            errors.push(`行${r+1}: endはstartより後にしてください (${startStr} - ${endStr})`);
            continue;
          }
          if(!groupName){
            errors.push(`行${r+1}: groupNameが空です`);
            continue;
          }

          if(!roomId){
            const cand = ROOMS.filter(x => x.name === roomNameVal && (!buildingVal || x.building === buildingVal));
            if(cand.length === 1) roomId = cand[0].id;
          }
          if(!roomId || !ROOMS.some(x=>x.id===roomId)){
            errors.push(`行${r+1}: roomId/roomNameから部屋を特定できません (${roomId || roomNameVal})`);
            continue;
          }

          const id = get(i_id) || null;
          const projector = clampInt(get(i_pj) || 0, 0, 999);
          const pc = clampInt(get(i_pc) || 0, 0, 999);
          const note = get(i_note);

          parsed.push({
            id,
            date,
            roomId,
            startMin,
            endMin,
            groupName,
            equipment: { projector, pc },
            note,
          });
        }

        if(errors.length){
          alert("CSVにエラーがあります。先頭のみ表示します。\n\n" + errors.slice(0, 10).join("\n"));
          return;
        }
        if(parsed.length === 0){
          alert("取り込める行がありません");
          return;
        }

        const dates = Array.from(new Set(parsed.map(x=>x.date))).sort();
        const rangeStart = dates[0];
        const rangeEnd = dates[dates.length-1];

        setBusy(true);
        try{
          const snap = await db.collection("reservations")
            .where("date", ">=", rangeStart)
            .where("date", "<=", rangeEnd)
            .get();
          bumpReads(snap.size);

          const existing = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          const byDate = {};
          for(const r of existing){
            if(!byDate[r.date]) byDate[r.date] = [];
            byDate[r.date].push(r);
          }

          let addCount = 0;
          let updateCount = 0;
          let skipCount = 0;

          const writes = [];

          for(const m of parsed){
            const sameDate = byDate[m.date] || [];
            const sameRoom = sameDate.filter(x => x.roomId === m.roomId && x.id !== m.id);
            const conflict = sameRoom.some(x => overlaps(m.startMin, m.endMin, x.startMin||0, x.endMin||0));
            if(conflict){ skipCount++; continue; }

            const overlapsAny = sameDate.filter(x => x.id !== m.id).filter(x => overlaps(m.startMin, m.endMin, x.startMin||0, x.endMin||0));
            const used = { projector: 0, pc: 0 };
            for(const r of overlapsAny){
              used.projector += Number(r?.equipment?.projector ?? 0);
              used.pc += Number(r?.equipment?.pc ?? 0);
            }
            const totals = {
              projector: Number(equipmentsMap.projector?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="projector")?.countTotal ?? 0),
              pc: Number(equipmentsMap.pc?.countTotal ?? DEFAULT_EQUIPMENTS.find(x=>x.id==="pc")?.countTotal ?? 0),
            };
            const after = { projector: used.projector + m.equipment.projector, pc: used.pc + m.equipment.pc };
            const over =
              (totals.projector>0 && after.projector>totals.projector) ||
              (totals.pc>0 && after.pc>totals.pc);
            if(over){ skipCount++; continue; }

            const payload = {
              date: m.date,
              roomId: m.roomId,
              startMin: m.startMin,
              endMin: m.endMin,
              groupName: (m.groupName||"").trim(),
              note: (m.note||"").trim(),
              equipment: {
                projector: Number(m?.equipment?.projector ?? 0),
                pc: Number(m?.equipment?.pc ?? 0),
              },
              updatedAt: serverTimestamp(),
            };

            if(m.id){
              writes.push({ type:"set", id: m.id, payload });
              updateCount++;
            }else{
              const ref = db.collection("reservations").doc();
              writes.push({ type:"set", id: ref.id, payload: { ...payload, createdAt: serverTimestamp() } });
              addCount++;
            }

            if(!byDate[m.date]) byDate[m.date] = [];
            byDate[m.date].push({ ...payload, id: m.id || "(new)" });
          }

          // batch commit
          let totalWrites = 0;
          let cursor = 0;
          while(cursor < writes.length){
            const chunk = writes.slice(cursor, cursor + 450);
            const batch = db.batch();
            for(const it of chunk){
              batch.set(db.collection("reservations").doc(it.id), it.payload, { merge:true });
              totalWrites++;
            }
            await batch.commit();
            cursor += 450;
          }
          bumpWrites(totalWrites);

          alert(`CSVインポート完了\n追加: ${addCount}\n更新: ${updateCount}\nスキップ(重複/機材超過): ${skipCount}`);
          await refreshAll();
          if(tab === "reserve" && reserveView === "weektime") await refreshWeek();
        }catch(err){
          console.error(err);
          alert("インポートに失敗しました");
        }finally{
          setBusy(false);
        }
      }

      // 検索（年度範囲を取得してクライアントフィルタ）
      async function runSearch(q){
        const query = (q||"").trim();
        if(!query){
          setSearchRes([]);
          return;
        }
        setSearchBusy(true);
        try{
          const snap = await db.collection("reservations")
            .where("date", ">=", fyRange.start)
            .where("date", "<=", fyRange.end)
            .get();
          bumpReads(snap.size);

          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          const key = query.toLowerCase();

          const hits = list.filter(r => {
            const hay = [
              r.date,
              roomName(r.roomId),
              roomBuilding(r.roomId),
              r.groupName,
              r.note
            ].join(" ").toLowerCase();
            return hay.includes(key);
          }).sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.startMin||0)-(b.startMin||0));

          setSearchRes(hits);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"検索に失敗しました" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setSearchBusy(false);
        }
      }

      // 日の表示用：機材使用（合計）
      const equipmentUsed = useMemo(() => {
        const used = { projector: 0, pc: 0 };
        for(const r of reservations){
          used.projector += Number(r?.equipment?.projector ?? 0);
          used.pc += Number(r?.equipment?.pc ?? 0);
        }
        return used;
      }, [reservations]);

      // ダッシュボード用：部屋ごと（選択日）
      const byRoom = useMemo(() => {
        const map = {};
        for(const rr of ROOMS) map[rr.id] = [];
        for(const r of reservations){
          if(!map[r.roomId]) map[r.roomId] = [];
          map[r.roomId].push(r);
        }
        for(const k of Object.keys(map)){
          map[k].sort((a,b)=>(a.startMin||0)-(b.startMin||0));
        }
        return map;
      }, [reservations]);

      // 週間表：部屋選択（本格週間表は部屋単位が一番見やすい）
      const [weekRoom, setWeekRoom] = useState(ROOMS[0].id);

      const weekDayEvents = useMemo(() => {
        // dateKey -> events (selected room)
        const map = {};
        for(const d of weekKeys) map[d] = [];
        for(const r of weekReservations || []){
          if(r.roomId !== weekRoom) continue;
          if(!map[r.date]) map[r.date] = [];
          map[r.date].push(r);
        }
        for(const d of Object.keys(map)){
          map[d] = layoutOverlaps(map[d]);
        }
        return map;
      }, [weekReservations, weekKeys, weekRoom]);

      // 月表示：日ごとの件数
      const monthCount = useMemo(() => {
        const m = {};
        for(const r of monthReservations || []){
          m[r.date] = (m[r.date] || 0) + 1;
        }
        return m;
      }, [monthReservations]);

      function doPrint(){ window.print(); }

      return (
        <div className="max-w-7xl mx-auto p-4 space-y-4 pb-28">

          {/* ===== ヘッダー ===== */}
          <div className="sticky top-0 z-40 -mx-4 px-4 py-3 bg-slate-50/85 glass border-b border-slate-100 no-print">
            <div className="flex items-center justify-between gap-3 flex-wrap">
              <div className="space-y-0.5">
                <div className="text-xs font-black text-slate-500">夷隅教育会館</div>
                <div className="text-lg font-black text-slate-800">管理アプリ</div>
                <div className="text-xs font-bold text-slate-400">部屋予約 / 機材 / 動静 / 年度予定（4〜3）</div>
              </div>

              <div className="flex items-center gap-2 flex-wrap">
                <input
                  type="date"
                  className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700"
                  value={selectedDate}
                  onChange={(e)=>setSelectedDate(e.target.value)}
                />

                <button
                  className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                    busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
                  onClick={refreshAll}
                  disabled={busy}
                  title="Firestoreから読み込み"
                >
                  更新
                </button>

                <button
                  className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                    "bg-white text-slate-700 border-slate-200")}
                  onClick={()=>{ setSearchOpen(true); setSearchRes([]); setSearchQ(""); }}
                  title="年度内検索"
                >
                  検索
                </button>

                {isLoggedIn ? (
                  <button className="rounded-2xl px-3 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={logout}>
                    ログアウト
                  </button>
                ) : (
                  <LoginButton busy={busy} onLogin={loginWithShared} />
                )}
              </div>
            </div>

            <div className="mt-3 flex items-center gap-2 flex-wrap">
              <Pill tone={isLoggedIn ? "emerald" : "slate"}>
                {isLoggedIn ? "編集モード（ログイン中）" : "閲覧モード（ログインなし）"}
              </Pill>
              <Pill tone="sky">共通ID：{SHARED_LOGIN_CODE}</Pill>
              <Pill tone="slate">予約単位：10分</Pill>
              <Pill tone="violet">年度：{fy}（{fyRange.start}〜{fyRange.end}）</Pill>
              <Pill tone="amber">概算 reads：{ops.reads}</Pill>
              <Pill tone="amber">概算 writes：{ops.writes}</Pill>
              <button
                className="px-3 py-1.5 rounded-xl bg-white border border-slate-200 font-black text-xs text-slate-700"
                onClick={resetOps}
                title="今月の概算カウントをリセット"
              >
                read/write リセット
              </button>
              {busy ? <Pill tone="amber">処理中…</Pill> : null}
            </div>
          </div>

          {/* Tabs */}
          <div className="grid grid-cols-7 gap-2 no-print">
            <TabButton active={tab==="home"} onClick={()=>setTab("home")}>全体</TabButton>
            <TabButton active={tab==="monitor"} onClick={()=>{ setTab("monitor"); setSelectedDate(todayKeyLocal()); }}>入口モニター</TabButton>
            <TabButton active={tab==="reserve"} onClick={()=>setTab("reserve")}>部屋予約</TabButton>
            <TabButton active={tab==="year"} onClick={()=>setTab("year")}>年間（4〜3）</TabButton>
            <TabButton active={tab==="equip"} onClick={()=>setTab("equip")}>機材</TabButton>
            <TabButton active={tab==="presence"} onClick={()=>setTab("presence")}>動静</TabButton>
            <TabButton active={tab==="settings"} onClick={()=>setTab("settings")}>設定</TabButton>
          </div>

          {/* ===== 全体 ===== */}
          {tab==="home" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle
                  icon="🏠"
                  title="今日の状況"
                  sub="まずはここだけ見ればOK"
                  right={
                    isLoggedIn ? (
                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print"
                        onClick={openNew}
                      >
                        ＋予約追加
                      </button>
                    ) : null
                  }
                />

                <div className="mt-4 grid md:grid-cols-3 gap-3">
                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="text-xs font-black text-slate-500">部屋予約（件数）</div>
                    <div className="text-3xl font-black text-slate-800 mt-1">{reservations.length}</div>
                    <div className="text-xs font-bold text-slate-400 mt-2">日付：{selectedDate}</div>
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4 space-y-2">
                    <div className="text-xs font-black text-slate-500">機材使用（合計）</div>
                    <div className="flex items-center justify-between">
                      <div className="font-black text-slate-800">プロジェクター</div>
                      <div className="font-black text-slate-800">{equipmentUsed.projector} / {equipmentsMap.projector?.countTotal ?? "—"}</div>
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="font-black text-slate-800">PC</div>
                      <div className="font-black text-slate-800">{equipmentUsed.pc} / {equipmentsMap.pc?.countTotal ?? "—"}</div>
                    </div>
                    <div className="text-xs font-bold text-slate-400">※予約に紐づく「使用台数」の合計</div>
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="text-xs font-black text-slate-500">動静（今日）</div>
                    <div className="mt-2 space-y-2">
                      <PresenceMini label="書記長" data={presence?.chief}/>
                      <PresenceMini label="書記次長" data={presence?.deputy}/>
                    </div>
                  </div>
                </div>

                <div className="mt-4 text-sm font-black text-slate-700">部屋ごとの予約（{selectedDate}）</div>
                <div className="mt-3 grid md:grid-cols-2 gap-3">
                  {ROOMS.map(room => (
                    <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                      <div className="flex items-center justify-between">
                        <div className="space-y-0.5">
                          <div className="text-xs font-black text-slate-400">{room.building}</div>
                          <div className="font-black text-slate-800">{room.name}</div>
                        </div>
                        <Pill tone="slate">{(byRoom[room.id]||[]).length}件</Pill>
                      </div>

                      <div className="mt-3 space-y-2">
                        {(byRoom[room.id]||[]).length === 0 ? (
                          <div className="text-xs font-bold text-slate-400">予約なし</div>
                        ) : (
                          (byRoom[room.id]||[]).map(r => (
                            <div key={r.id} className="flex items-start justify-between gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                              <div className="min-w-0">
                                <div className="font-black text-slate-800">
                                  {minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {r.groupName}
                                </div>
                                <div className="text-xs font-bold text-slate-500 mt-1 flex gap-2 flex-wrap">
                                  {(Number(r?.equipment?.projector||0)>0) && <Pill tone="sky">PJ {r.equipment.projector}</Pill>}
                                  {(Number(r?.equipment?.pc||0)>0) && <Pill tone="sky">PC {r.equipment.pc}</Pill>}
                                  {r.note ? <Pill tone="slate">メモ</Pill> : null}
                                </div>
                              </div>

                              {isLoggedIn ? (
                                <div className="shrink-0 flex items-center gap-2 no-print">
                                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                    編集
                                  </button>
                                </div>
                              ) : null}
                            </div>
                          ))
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </Card>
            </div>
          )}

          {/* ===== 入口モニター ===== */}
{tab==="monitor" && (
  <div className="space-y-4">
    <Card printCard>
      <SectionTitle
        icon="🖥️"
        title="入口モニター"
        sub="今日はどの団体が何時からどの部屋を使うか（使う部屋のみ表示）"
        right={
          <div className="flex items-center gap-2 flex-wrap no-print">
            <button
              className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
              onClick={()=>setSelectedDate(todayKeyLocal())}
            >
              今日へ
            </button>
            <button
              className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900"
              onClick={()=>{
                const el = document.documentElement;
                if(el.requestFullscreen) el.requestFullscreen();
              }}
              title="大型モニターで全画面"
            >
              全画面
            </button>
            <button
              className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
              onClick={refreshAll}
              disabled={busy}
            >
              更新
            </button>
            <button
              className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
              onClick={doPrint}
            >
              印刷
            </button>
          </div>
        }
      />

      <div className="mt-4 rounded-3xl bg-slate-50 border border-slate-100 p-4">
        <div className="flex items-center justify-between gap-2 flex-wrap">
          <div className="text-sm font-black text-slate-800">表示日：{selectedDate}</div>
          <div className="text-xs font-bold text-slate-500">※最新にするには「更新」</div>
        </div>
      </div>

      <MonitorBoard
        dateKey={selectedDate}
        rooms={ROOMS}
        reservations={reservations}
      />
    </Card>
  </div>
)}

          {/* ===== 部屋予約 ===== */}
          {tab==="reserve" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle
                  icon="📅"
                  title="部屋予約"
                  sub={reserveView==="day" ? "日表示（選択中の日付）" : (reserveView==="weektime" ? `週間表（${weekStart}〜${weekEnd}） 8:00〜20:00` : `月一覧（${monthKeyLocal(parseKeyToDate(selectedDate))}）`)}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button
                        className={classNames("px-4 py-2 rounded-2xl font-black border shadow-sm",
                          reserveView==="day" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
                        onClick={()=>setReserveView("day")}
                      >
                        日表示
                      </button>
                      <button
                        className={classNames("px-4 py-2 rounded-2xl font-black border shadow-sm",
                          reserveView==="weektime" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
                        onClick={async ()=>{
                          setReserveView("weektime");
                          if((weekReservations||[]).length===0){
                            setBusy(true);
                            try{ await refreshWeek(); } finally { setBusy(false); }
                          }
                        }}
                      >
                        週間表
                      </button>

<button
  className={classNames("px-4 py-2 rounded-2xl font-black border shadow-sm",
    reserveView==="month" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
  onClick={async ()=>{
    setReserveView("month");
    const dt = parseKeyToDate(selectedDate);
    await refreshMonthReserve(dt.getFullYear(), dt.getMonth()+1);
  }}
>
  月一覧
</button>

                      {reserveView==="weektime" ? (
                        <select
                          className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                          value={weekRoom}
                          onChange={(e)=>setWeekRoom(e.target.value)}
                          title="週間表で表示する部屋"
                        >
                          {ROOMS.map(r => (
                            <option key={r.id} value={r.id}>{r.building} / {r.name}</option>
                          ))}
                        </select>
                      ) : null}

                      {isLoggedIn ? (
                        <button
                          className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm"
                          onClick={openNew}
                        >
                          ＋予約追加
                        </button>
                      ) : null}

                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
                        onClick={()=>setCsvOpen(true)}
                      >
                        CSV/印刷
                      </button>

                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
                        onClick={doPrint}
                        title="A4横で印刷"
                      >
                        印刷
                      </button>
                    </div>
                  }
                />

                {/* 日表示 */}
                {reserveView==="day" && (
                  <div className="mt-4 space-y-2">
                    {reservations.length===0 ? (
                      <div className="text-sm font-bold text-slate-400 p-3">予約がありません（更新で読み込み）</div>
                    ) : reservations
                      .slice()
                      .sort((a,b)=> (a.startMin||0)-(b.startMin||0))
                      .map(r => (
                        <div key={r.id} className="p-4 rounded-3xl border border-slate-100 bg-white">
                          <div className="flex items-start justify-between gap-3 flex-wrap">
                            <div className="space-y-1 min-w-0">
                              <div className="text-xs font-black text-slate-400">{roomBuilding(r.roomId)} / {roomName(r.roomId)}</div>
                              <div className="text-base font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)}　{r.groupName}</div>
                              <div className="text-xs font-bold text-slate-500 flex gap-2 flex-wrap">
                                {(Number(r?.equipment?.projector||0)>0) && <Pill tone="sky">PJ {r.equipment.projector}</Pill>}
                                {(Number(r?.equipment?.pc||0)>0) && <Pill tone="sky">PC {r.equipment.pc}</Pill>}
                                {r.note ? <Pill tone="slate">{r.note}</Pill> : <span className="text-slate-400">メモなし</span>}
                              </div>
                            </div>

                            {isLoggedIn ? (
                              <div className="flex items-center gap-2 no-print">
                                <button className="px-4 py-2 rounded-2xl bg-slate-100 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                  編集
                                </button>
                                <button className="px-4 py-2 rounded-2xl bg-rose-50 border border-rose-100 font-black text-rose-700" onClick={()=>deleteReservation(r.id)}>
                                  削除
                                </button>
                              </div>
                            ) : null}
                          </div>
                        </div>
                      ))}
                  </div>
                )}

                {/* 週間表（時間軸） */}
                {reserveView==="weektime" && (
                  <WeekTimeGrid
                    weekKeys={weekKeys}
                    weekStart={weekStart}
                    weekEnd={weekEnd}
                    roomId={weekRoom}
                    eventsByDate={weekDayEvents}
                    isLoggedIn={isLoggedIn}
                    onEdit={openEdit}
                    busy={busy}
                  />
                )}

{/* 月一覧 */}
{reserveView==="month" && (
  <div className="mt-4">
    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
      <div className="flex items-center justify-between gap-2 flex-wrap">
        <div className="font-black text-slate-800">月一覧（予約）</div>
        <div className="flex items-center gap-2 flex-wrap no-print">
          <button
            className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
              monthReserveBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
            disabled={monthReserveBusy}
            onClick={()=>{
              const dt = parseKeyToDate(selectedDate);
              refreshMonthReserve(dt.getFullYear(), dt.getMonth()+1);
            }}
          >
            この月を更新
          </button>
        </div>
      </div>
      <div className="text-xs font-bold text-slate-500 mt-1">※日付をタップすると「日表示」に移動します</div>
    </div>

    <MonthListAny
      year={parseKeyToDate(selectedDate).getFullYear()}
      month={parseKeyToDate(selectedDate).getMonth()+1}
      list={monthReserveList}
      onPickDate={(d)=>{ setSelectedDate(d); setReserveView("day"); }}
    />
  </div>
)}


                <div className="mt-3 text-xs font-bold text-slate-400 no-print">
                  ※週間表の内容は「週間表に切替」または「更新」で読み込み（概算readに反映）
                </div>
              </Card>
            </div>
          )}

          {/* ===== 年間（4〜3） ===== */}
          {tab==="year" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle
                  icon="🗓️"
                  title="年間予定（4月〜3月）"
                  sub={`年度：${fy}（${fyRange.start}〜${fyRange.end}）`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button
                        className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                          monthBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        disabled={monthBusy}
                        onClick={()=>{
                          if(fyMonth==null) return;
                          const y = (fyMonth>=4)? fy : (fy+1);
                          const m = fyMonth;
                          refreshMonth(y,m);
                          refreshPresenceMonth(y,m);
                        }}
                      >
                        この月を更新
                      </button>
                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700"
                        onClick={doPrint}
                      >
                        印刷
                      </button>
                    </div>
                  }
                />

                <FiscalMonthPicker fy={fy} fyMonth={fyMonth} setFyMonth={setFyMonth} />

                <div className="mt-4 grid lg:grid-cols-3 gap-4">
                  <MonthCalendar
                    fy={fy}
                    fyMonth={fyMonth}
                    monthCount={monthCount}
                    selectedDate={selectedDate}
                    onPickDate={(d)=>{ setSelectedDate(d); setTab("reserve"); setReserveView("day"); }}
                  />
                  <MonthList
                    fy={fy}
                    fyMonth={fyMonth}
                    list={monthReservations}
                    onPickDate={(d)=>{ setSelectedDate(d); setTab("reserve"); setReserveView("day"); }}
                  />

<PresenceMonthPanel
  year={(fyMonth>=4)? fy : (fy+1)}
  month={fyMonth}
  presenceMonthMap={presenceMonthMap}
  onEditDate={(dk)=>{ setPresenceDayKey(dk); setPresenceDayOpen(true); }}
/>

                </div>

                <div className="mt-3 text-xs font-bold text-slate-400">
                  ※年度タブは「月の予約をまとめて表示」します。予定（翌年以降）も date で保存されるので、そのまま入れてOKです。
                </div>
              </Card>
            </div>
          )}

          {/* ===== 機材 ===== */}
          {tab==="equip" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle icon="🧰" title="機材" sub="総数（マスタ）と、予約に紐づく使用数を管理" />
                <div className="mt-4 flex items-center justify-between flex-wrap gap-2">
                  <div className="text-sm font-black text-slate-700">機材マスタ</div>
                  {isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700 no-print" onClick={seedEquipments}>
                      初期データ作成
                    </button>
                  ) : (
                    <div className="text-xs font-bold text-slate-400">※編集はログイン後</div>
                  )}
                </div>

                <div className="mt-3 grid md:grid-cols-2 gap-3">
                  {(equipments || []).map(e => (
                    <div key={e.id} className="p-4 rounded-3xl border border-slate-100 bg-slate-50">
                      <div className="flex items-center justify-between gap-2">
                        <div className="font-black text-slate-800">{e.name}</div>
                        <Pill tone="slate">総数：{e.countTotal ?? "—"}</Pill>
                      </div>
                      <div className="mt-2 text-xs font-bold text-slate-500">※総数変更UIは必要なら追加できます（今はMVP）</div>
                    </div>
                  ))}
                </div>

                <div className="mt-4 rounded-3xl border border-slate-100 bg-white p-4">
                  <div className="font-black text-slate-800">この日の使用合計（予約から集計）</div>
                  <div className="mt-2 text-sm font-bold text-slate-700">プロジェクター：{equipmentUsed.projector} ／ PC：{equipmentUsed.pc}</div>
                  <div className="mt-1 text-xs font-bold text-slate-400">※同時間帯チェックは「保存時」に動きます（超過すると警告）</div>
                </div>
              </Card>
            </div>
          )}

          {/* ===== 動静 ===== */}
          {tab==="presence" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle icon="🟢" title="動静" sub="午前・午後・夕方（ワンタップで更新）" />

                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  <PresenceEditor title="書記長" value={presence?.chief || {}} onSet={(slot,val)=>setPresenceValue(selectedDate, "chief", slot, val)} disabled={!isLoggedIn || busy} />
                  <PresenceEditor title="書記次長" value={presence?.deputy || {}} onSet={(slot,val)=>setPresenceValue(selectedDate, "deputy", slot, val)} disabled={!isLoggedIn || busy} />
                </div>

                {!isLoggedIn ? (
                  <div className="mt-3 text-xs font-bold text-slate-400">※動静の更新はログイン後</div>
                ) : null}
              </Card>
            </div>
          )}

          {/* ===== 設定（テンプレ） ===== */}
          {tab==="settings" && (
            <div className="space-y-4">
              <Card printCard>
                <SectionTitle icon="⚙️" title="設定" sub="よく使う団体テンプレを登録すると、予約入力が爆速になります" />

                <TemplateSettings
                  templates={templates}
                  isLoggedIn={isLoggedIn}
                  busy={busy}
                  onSave={saveTemplates}
                />

                <div className="mt-4 rounded-3xl bg-slate-50 border border-slate-100 p-4">
                  <div className="font-black text-slate-800">ヒント</div>
                  <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                    <li>テンプレは「設定」タブで登録 → 予約入力でワンタップ挿入できます。</li>
                    <li>年間（4〜3）は、翌年以降も date で保存されるので、そのまま予約を入れてOKです。</li>
                    <li>「更新」を押すとFirestoreから読み込みます（オフライン時はキャッシュ表示）。</li>
                  </ul>
                </div>
              </Card>
            </div>
          )}

          {/* ===== 予約編集モーダル ===== */}
          <Modal open={editorOpen} onClose={()=>{ setEditorOpen(false); setEditTarget(null); }} title={editTarget?.id ? "予約を編集" : "予約を追加"}>
            {editTarget ? (
              <ReservationEditor
                model={editTarget}
                setModel={setEditTarget}
                rooms={ROOMS}
                opts10={opts10}
                templates={templates}
                onSave={saveReservation}
                onCancel={()=>{ setEditorOpen(false); setEditTarget(null); }}
                busy={busy}
                isLoggedIn={isLoggedIn}
              />
            ) : null}
          </Modal>

          {/* ===== CSV/印刷モーダル ===== */}
          <Modal open={csvOpen} onClose={()=>setCsvOpen(false)} title="CSV 入出力 / 印刷（A4横）">
            <div className="space-y-4">
              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="font-black text-slate-800">印刷（A4横）</div>
                <div className="text-xs font-bold text-slate-500 mt-1">画面の「日表示 / 週間表 / 年度表示」そのまま印刷できます。</div>
                <div className="mt-3 flex gap-2 flex-wrap">
                  <button className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setCsvOpen(false); setTimeout(()=>window.print(), 120); }}>
                    今の画面を印刷
                  </button>
                </div>
              </div>

              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="font-black text-slate-800">CSV エクスポート（予約）</div>
                <div className="text-xs font-bold text-slate-500 mt-1">週表示なら「週の範囲」、日表示なら「その日」をおすすめ。</div>
                <CSVExportPanel
                  selectedDate={selectedDate}
                  weekStart={weekStart}
                  weekEnd={weekEnd}
                  reserveView={reserveView}
                  fyRange={fyRange}
                  onExport={exportCSV}
                  busy={busy}
                />
              </div>

              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="font-black text-slate-800">CSV インポート（予約）</div>
                <div className="text-xs font-bold text-slate-500 mt-1">※ログインが必要です。重複（同室同時間）/機材超過はスキップして安全に取り込みます。</div>
                <CSVImportPanel disabled={!isLoggedIn || busy} onImport={importCSV} />
              </div>

              <div className="text-xs font-bold text-slate-400">CSVヘッダ例：id,date,building,roomId,roomName,start,end,groupName,projector,pc,note</div>
            </div>
          </Modal>

          {/* ===== 検索モーダル ===== */}
          <Modal open={searchOpen} onClose={()=>setSearchOpen(false)} title={`年度内検索（${fy}年度）`}>
            <div className="space-y-3">
              <div className="flex items-center gap-2">
                <input
                  className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                  value={searchQ}
                  onChange={(e)=>setSearchQ(e.target.value)}
                  placeholder="例：団体名 / 部屋名 / メモ / 日付（2026-02）など"
                />
                <button
                  className={classNames("px-4 py-3 rounded-2xl font-black border shadow-sm",
                    searchBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
                  disabled={searchBusy}
                  onClick={()=>runSearch(searchQ)}
                >
                  検索
                </button>
              </div>
              <div className="text-xs font-bold text-slate-400">※検索は年度範囲の予約を取得して絞り込みます（read増えます）。</div>

              <div className="rounded-3xl border border-slate-100 bg-white p-3">
                <div className="text-xs font-black text-slate-500">結果：{searchRes.length} 件</div>
                <div className="mt-2 space-y-2 max-h-[50vh] overflow-auto">
                  {searchRes.length===0 ? (
                    <div className="text-sm font-bold text-slate-400 p-3">検索結果がここに出ます</div>
                  ) : searchRes.map(r => (
                    <button
                      key={r.id}
                      className="w-full text-left p-3 rounded-2xl bg-slate-50 border border-slate-100 hover:bg-slate-100"
                      onClick={()=>{
                        setSelectedDate(r.date);
                        setTab("reserve");
                        setReserveView("day");
                        setSearchOpen(false);
                      }}
                    >
                      <div className="font-black text-slate-800">{r.date} {minToHHMM(r.startMin||0)}-{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                      <div className="text-xs font-bold text-slate-500 mt-1">{roomBuilding(r.roomId)} / {roomName(r.roomId)} {r.note ? `・${r.note}` : ""}</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </Modal>

          
{/* ===== 動静（日別編集）モーダル ===== */}
<Modal open={presenceDayOpen} onClose={()=>{ setPresenceDayOpen(false); setPresenceDayKey(null); }} title="動静（年間：日別編集）">
  {presenceDayKey ? (
    <PresenceDayEditor
      dateKey={presenceDayKey}
      value={presenceDayKey===selectedDate ? (presence || {}) : (presenceMonthMap[presenceDayKey] || {})}
      onSet={setPresenceValue}
      disabled={!isLoggedIn || busy}
    />
  ) : null}
  {!isLoggedIn ? (
    <div className="mt-2 p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">
      ※編集するにはログインしてください
    </div>
  ) : null}
</Modal>

          {/* ===== Toast ===== */}
          {toast ? (
            <div className={classNames(
              "fixed left-1/2 -translate-x-1/2 bottom-4 z-50 px-4 py-3 rounded-3xl shadow-lg border font-black no-print",
              toast.type==="ok" ? "bg-emerald-600 text-white border-emerald-700" : "bg-rose-600 text-white border-rose-700"
            )}>
              {toast.msg}
            </div>
          ) : null}

          {/* Footer */}
          <div className="fixed inset-x-0 bottom-0 z-30 bg-white/85 glass border-t border-slate-100 no-print">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
              <div className="text-xs font-bold text-slate-500">※「更新」でFirestoreから読み込み（オフライン時はキャッシュ表示）</div>
              <div className="text-xs font-bold text-slate-400">共通ID：{SHARED_LOGIN_CODE}</div>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * Login
     **********************/
    function LoginButton({busy, onLogin}){
      const [open, setOpen] = useState(false);
      const [pw, setPw] = useState("");

      return (
        <>
          <button
            className={classNames("rounded-2xl px-3 py-2 font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
            onClick={()=>setOpen(true)}
            disabled={busy}
            title="編集する場合はログイン"
          >
            ログイン
          </button>

          <Modal open={open} onClose={()=>setOpen(false)} title="編集モードにログイン（共通ID方式）">
            <div className="space-y-3">
              <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="text-xs font-black text-slate-500">共通ID</div>
                <div className="text-xl font-black text-slate-800 mt-1">{SHARED_LOGIN_CODE}</div>
                <div className="text-xs font-bold text-slate-400 mt-1">※IDは固定。パスワードのみ入力します。</div>
              </div>

              <div className="space-y-2">
                <div className="text-sm font-black text-slate-700">パスワード</div>
                <input
                  type="password"
                  className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                  value={pw}
                  onChange={(e)=>setPw(e.target.value)}
                  placeholder="Firebaseで作成したPW"
                />
              </div>

              <div className="flex items-center gap-2">
                <button
                  className="w-full rounded-2xl px-4 py-3 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm"
                  onClick={()=>{ onLogin(pw); setOpen(false); setPw(""); }}
                >
                  ログインして編集する
                </button>
                <button
                  className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700"
                  onClick={()=>{ setOpen(false); setPw(""); }}
                >
                  やめる
                </button>
              </div>

              <div className="text-xs font-bold text-slate-400">※Firebase Authenticationに「{SHARED_EMAIL}」を作成しておく必要があります。</div>
            </div>
          </Modal>
        </>
      );
    }

    /**********************
     * Reservation Editor（テンプレ対応）
     **********************/
    function ReservationEditor({model, setModel, rooms, opts10, templates, onSave, onCancel, busy, isLoggedIn}){
      const roomGroups = useMemo(() => {
        const g = { "本館": [], "別館": [] };
        for(const r of rooms){
          if(!g[r.building]) g[r.building] = [];
          g[r.building].push(r);
        }
        return g;
      }, [rooms]);

      function setField(k,v){ setModel(prev => ({ ...prev, [k]: v })); }
      function setEquip(k,v){
        const n = Math.max(0, Math.min(999, Number(v)||0));
        setModel(prev => ({ ...prev, equipment: { ...(prev.equipment||{}), [k]: n }}));
      }

      const endOpts = opts10.filter(o => o.value >= (Number(model.startMin)||0) + 10);

      return (
        <div className="space-y-4">
          {!isLoggedIn ? (
            <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">
              編集するにはログインしてください（閲覧モードでは保存できません）
            </div>
          ) : null}

          {/* テンプレ */}
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="flex items-center justify-between">
              <div className="font-black text-slate-800">よく使う団体テンプレ</div>
              <Pill tone="slate">設定タブで編集</Pill>
            </div>
            <div className="mt-3 flex gap-2 flex-wrap">
              {(templates||[]).length===0 ? (
                <div className="text-xs font-bold text-slate-400">テンプレ未登録（設定タブから追加できます）</div>
              ) : (templates||[]).slice(0, 20).map(t => (
                <button
                  key={t}
                  className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-xs text-slate-700 hover:bg-slate-100"
                  onClick={()=>setField("groupName", t)}
                  type="button"
                >
                  {t}
                </button>
              ))}
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">日付</div>
              <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.date} onChange={(e)=>setField("date", e.target.value)} />
            </div>

            <div>
              <div className="text-sm font-black text-slate-700 mb-2">部屋</div>
              <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.roomId} onChange={(e)=>setField("roomId", e.target.value)}>
                {Object.keys(roomGroups).map(b => (
                  <optgroup key={b} label={b}>
                    {roomGroups[b].map(r => (
                      <option key={r.id} value={r.id}>{r.name}</option>
                    ))}
                  </optgroup>
                ))}
              </select>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">開始（10分単位）</div>
              <select
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.startMin}
                onChange={(e)=>{
                  const s = Number(e.target.value);
                  const eMin = Number(model.endMin)||0;
                  setField("startMin", s);
                  if(eMin <= s) setField("endMin", s+10);
                }}
              >
                {opts10.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">終了（開始＋10分以上）</div>
              <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.endMin} onChange={(e)=>setField("endMin", Number(e.target.value))}>
                {endOpts.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>
          </div>

          <div>
            <div className="text-sm font-black text-slate-700 mb-2">団体名（必須）</div>
            <input className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.groupName} onChange={(e)=>setField("groupName", e.target.value)} placeholder="例：○○研究会、△△クラブ など" />
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">機材</div>
              <div className="mt-3 space-y-3">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-bold text-slate-700">プロジェクター</div>
                  <input type="number" min="0" max="999" className="w-24 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={model?.equipment?.projector ?? 0} onChange={(e)=>setEquip("projector", e.target.value)} />
                </div>
                <div className="flex items-center justify-between gap-2">
                  <div className="font-bold text-slate-700">PC</div>
                  <input type="number" min="0" max="999" className="w-24 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={model?.equipment?.pc ?? 0} onChange={(e)=>setEquip("pc", e.target.value)} />
                </div>
                <div className="text-xs font-bold text-slate-400">※保存前に「同時間帯で総数超過」を警告します</div>
              </div>
            </div>

            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">メモ（任意）</div>
              <textarea className="mt-3 w-full h-28 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" value={model.note} onChange={(e)=>setField("note", e.target.value)} placeholder="例：机配置、来館時間の目安、鍵の受け渡し など" />
            </div>
          </div>

          <div className="flex items-center gap-2">
            <button
              className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                (!isLoggedIn || busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
              disabled={!isLoggedIn || busy}
              onClick={()=>onSave(model)}
            >
              保存
            </button>
            <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={onCancel}>
              キャンセル
            </button>
          </div>
        </div>
      );
    }

    /**********************
     * 週間表（時間軸）
     **********************/
    function WeekTimeGrid({weekKeys, weekStart, weekEnd, roomId, eventsByDate, isLoggedIn, onEdit, busy}){
      const slots = useMemo(() => {
        const a = [];
        for(let m=WEEK_START_MIN; m<=WEEK_END_MIN; m+=SLOT_MIN){ a.push(m); }
        return a;
      }, []);

      const rowH = 26; // matches css var default
      const gridH = (slots.length) * rowH;

      const dowLabel = (key, idx) => {
        const names = ["月","火","水","木","金","土","日"];
        return `${names[idx]} ${key}`;
      };

      return (
        <div className="mt-4">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="flex items-center justify-between gap-2 flex-wrap">
              <div className="font-black text-slate-800">週間表（時間軸）</div>
              <Pill tone="sky">表示：{roomBuilding(roomId)} / {roomName(roomId)}</Pill>
              <Pill tone="slate">{weekStart}〜{weekEnd}</Pill>
              {busy ? <Pill tone="amber">処理中…</Pill> : null}
            </div>
            <div className="text-xs font-bold text-slate-500 mt-1">縦：時刻（10分刻み）／横：曜日。予約はブロックで表示します。</div>
          </div>

          <div className="mt-3 overflow-x-auto">
            <div className="weekgrid min-w-[1200px]">
              {/* header */}
              <div className="grid" style={{ gridTemplateColumns: "64px repeat(7, minmax(180px, 1fr))", gap: "8px" }}>
                <div></div>
                {weekKeys.map((d, idx) => (
                  <div key={d} className="px-3 py-2 rounded-2xl bg-white border border-slate-100">
                    <div className="text-xs font-black text-slate-600">{dowLabel(d, idx)}</div>
                  </div>
                ))}
              </div>

              {/* body */}
              <div className="mt-2 grid" style={{ gridTemplateColumns: "64px repeat(7, minmax(180px, 1fr))", gap: "8px" }}>
                {/* time column */}
                <div className="rounded-2xl bg-white border border-slate-100 overflow-hidden">
                  <div style={{ height: gridH }}>
                    {slots.map((m, i) => (
                      <div key={m} className="border-b border-slate-100 px-2" style={{ height: rowH }}>
                        <div className={classNames("text-[10px] font-black text-slate-500", (m%60===0) ? "mt-1" : "mt-2 opacity-50")}>
                          {(m%60===0) ? minToHHMM(m) : ""}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* day columns */}
                {weekKeys.map((d) => (
                  <div key={d} className="rounded-2xl bg-white border border-slate-100 overflow-hidden relative">
                    {/* grid lines */}
                    <div style={{ height: gridH }}>
                      {slots.map((m) => (
                        <div key={m} className={classNames("border-b", (m%60===0) ? "border-slate-200" : "border-slate-100")} style={{ height: rowH }}></div>
                      ))}
                    </div>

                    {/* events layer */}
                    <div className="absolute inset-0">
                      {(eventsByDate[d] || [])
                        .filter(r => (r.endMin > WEEK_START_MIN) && (r.startMin < WEEK_END_MIN))
                        .map(r => {
                          const s = Math.max(r.startMin, WEEK_START_MIN);
                          const e = Math.min(r.endMin, WEEK_END_MIN);
                          const top = ((s - WEEK_START_MIN) / SLOT_MIN) * rowH;
                          const height = Math.max(1, ((e - s) / SLOT_MIN) * rowH);

                          const cols = r._cols || 1;
                          const col = r._col || 0;
                          const gap = 6;
                          const wPct = 100/cols;
                          const left = col * wPct;
                          const width = wPct;

                          return (
                            <div
                              key={r.id}
                              className="evt"
                              style={{
                                top: `${top}px`,
                                height: `${height}px`,
                                left: `calc(${left}% + ${gap/2}px)`,
                                width: `calc(${width}% - ${gap}px)`,
                              }}
                              title={`${r.groupName} ${minToHHMM(r.startMin)}-${minToHHMM(r.endMin)}`
                            }
                            >
                              <div className="t">{minToHHMM(r.startMin)}–{minToHHMM(r.endMin)}</div>
                              <div className="s">{r.groupName}</div>
                              {r.note ? <div className="m">{r.note}</div> : null}
                              {isLoggedIn ? (
                                <div className="mt-2 no-print">
                                  <button
                                    className="px-3 py-1.5 rounded-xl bg-white/90 border border-slate-200 font-black text-[10px] text-slate-700"
                                    onClick={(e)=>{ e.preventDefault(); e.stopPropagation(); onEdit(r); }}
                                  >
                                    編集
                                  </button>
                                </div>
                              ) : null}
                            </div>
                          );
                        })}
                    </div>
                  </div>
                ))}
              </div>

              <div className="mt-3 text-xs font-bold text-slate-400">
                ※重なり予約は自動で横並びにします。全室を同時に見たい場合は、まず部屋を切り替えて確認する運用が安全です。
              </div>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * 年度（月）
     **********************/
    function FiscalMonthPicker({fy, fyMonth, setFyMonth}){
      const months = [4,5,6,7,8,9,10,11,12,1,2,3];
      return (
        <div className="mt-4">
          <div className="text-sm font-black text-slate-700">月を選択</div>
          <div className="mt-2 flex gap-2 flex-wrap">
            {months.map(m => (
              <button
                key={m}
                className={classNames("px-4 py-2 rounded-2xl font-black border shadow-sm",
                  fyMonth===m ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
                onClick={()=>setFyMonth(m)}
              >
                {m}月
              </button>
            ))}
          </div>
        </div>
      );
    }

    function MonthCalendar({fy, fyMonth, monthCount, selectedDate, onPickDate}){
      const actualYear = (fyMonth>=4) ? fy : (fy+1);
      const actualMonth = fyMonth;
      const cells = useMemo(()=>buildMonthCalendar(actualYear, actualMonth), [actualYear, actualMonth]);
      const wnames = ["月","火","水","木","金","土","日"];

      return (
        <div className="rounded-3xl border border-slate-100 bg-white p-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-xs font-black text-slate-400">カレンダー</div>
              <div className="text-lg font-black text-slate-800">{actualYear}年 {actualMonth}月</div>
            </div>
            <Pill tone="slate">クリックで日へ</Pill>
          </div>

          <div className="mt-3 calGrid">
            {wnames.map(w => (
              <div key={w} className="text-xs font-black text-slate-500 px-2">{w}</div>
            ))}

            {cells.map((c, idx) => {
              if(!c.dateKey){
                return <div key={idx} className="calCell rounded-2xl bg-slate-50 border border-slate-100"></div>;
              }
              const n = monthCount[c.dateKey] || 0;
              const isSel = c.dateKey === selectedDate;
              return (
                <button
                  key={c.dateKey}
                  onClick={()=>onPickDate(c.dateKey)}
                  className={classNames(
                    "calCell rounded-2xl border px-2 py-2 text-left hover:bg-slate-50",
                    isSel ? "bg-emerald-50 border-emerald-200" : "bg-white border-slate-100"
                  )}
                >
                  <div className="flex items-start justify-between">
                    <div className="font-black text-slate-800">{c.day}</div>
                    {n>0 ? (
                      <span className="inline-flex items-center justify-center min-w-[22px] h-[22px] px-2 rounded-full bg-sky-600 text-white text-[11px] font-black">{n}</span>
                    ) : null}
                  </div>
                  <div className="mt-1 text-[11px] font-bold text-slate-400">{n>0 ? "予約あり" : "—"}</div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    function MonthList({fy, fyMonth, list, onPickDate}){
      const actualYear = (fyMonth>=4) ? fy : (fy+1);
      const actualMonth = fyMonth;

      const grouped = useMemo(() => {
        const g = {};
        for(const r of list || []){
          if(!g[r.date]) g[r.date] = [];
          g[r.date].push(r);
        }
        const keys = Object.keys(g).sort();
        return { keys, g };
      }, [list]);

      return (
        <div className="rounded-3xl border border-slate-100 bg-white p-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-xs font-black text-slate-400">一覧</div>
              <div className="text-lg font-black text-slate-800">{actualYear}年 {actualMonth}月</div>
            </div>
            <Pill tone="slate">日付でジャンプ</Pill>
          </div>

          <div className="mt-3 space-y-3 max-h-[60vh] overflow-auto">
            {grouped.keys.length===0 ? (
              <div className="text-sm font-bold text-slate-400 p-3">この月の予約がありません</div>
            ) : grouped.keys.map(date => (
              <div key={date} className="rounded-3xl bg-slate-50 border border-slate-100 p-3">
                <div className="flex items-center justify-between">
                  <div className="font-black text-slate-800">{date}</div>
                  <button className="px-3 py-1.5 rounded-2xl bg-white border border-slate-200 font-black text-xs text-slate-700" onClick={()=>onPickDate(date)}>
                    この日へ
                  </button>
                </div>
                <div className="mt-2 space-y-2">
                  {(grouped.g[date]||[]).sort((a,b)=>(a.startMin||0)-(b.startMin||0)).map(r => (
                    <div key={r.id} className="p-3 rounded-2xl bg-white border border-slate-100">
                      <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                      <div className="text-xs font-bold text-slate-500 mt-1">{roomBuilding(r.roomId)} / {roomName(r.roomId)} {r.note ? `・${r.note}` : ""}</div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /**********************
     * テンプレ設定
     **********************/
    function TemplateSettings({templates, isLoggedIn, busy, onSave}){
      const [draft, setDraft] = useState((templates||[]).join("\n"));

      useEffect(() => {
        setDraft((templates||[]).join("\n"));
      }, [templates]);

      return (
        <div className="mt-4 grid lg:grid-cols-3 gap-4">
          <div className="rounded-3xl border border-slate-100 bg-white p-4">
            <div className="font-black text-slate-800">現在のテンプレ</div>
            <div className="mt-3 flex gap-2 flex-wrap">
              {(templates||[]).length===0 ? (
                <div className="text-sm font-bold text-slate-400">未登録</div>
              ) : (templates||[]).map(t => (
                <span key={t} className="px-3 py-2 rounded-2xl bg-slate-50 border border-slate-100 text-xs font-black text-slate-700">{t}</span>
              ))}
            </div>
          </div>

          <div className="rounded-3xl border border-slate-100 bg-white p-4">
            <div className="flex items-center justify-between gap-2">
              <div>
                <div className="font-black text-slate-800">編集（1行＝1団体）</div>
                <div className="text-xs font-bold text-slate-400 mt-1">重複は自動で除去します。最大30件推奨。</div>
              </div>
              <Pill tone={isLoggedIn ? "emerald" : "slate"}>{isLoggedIn ? "保存可" : "閲覧のみ"}</Pill>
            </div>

            <textarea
              className="mt-3 w-full h-48 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700"
              value={draft}
              onChange={(e)=>setDraft(e.target.value)}
              placeholder="例：\n夷隅教育研究会\n〇〇研修\n△△サークル"
              disabled={!isLoggedIn || busy}
            />

            <div className="mt-3 flex items-center gap-2">
              <button
                className={classNames("w-full px-4 py-3 rounded-2xl font-black border shadow-sm",
                  (!isLoggedIn || busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                disabled={!isLoggedIn || busy}
                onClick={()=>{
                  const next = draft.split("\n").map(s=>s.trim()).filter(Boolean);
                  onSave(next);
                }}
              >
                保存
              </button>
              <button
                className="px-4 py-3 rounded-2xl font-black bg-white border border-slate-200 text-slate-700"
                onClick={()=>setDraft((templates||[]).join("\n"))}
                disabled={busy}
              >
                戻す
              </button>
            </div>

            {!isLoggedIn ? (
              <div className="mt-2 text-xs font-bold text-slate-400">※保存にはログインが必要です</div>
            ) : null}
          </div>
        </div>
      );
    }

    /**********************
     * Presence
     **********************/
    function PresenceMini({label, data}){
      const d = data || {};
      const f = (x)=> x ? x : "—";
      return (
        <div className="rounded-2xl bg-white border border-slate-100 p-3">
          <div className="text-xs font-black text-slate-500">{label}</div>
          <div className="mt-1 text-xs font-bold text-slate-700">午前：{f(d.am)} ／ 午後：{f(d.pm)} ／ 夕方：{f(d.eve)}</div>
        </div>
      );
    }

    
/**********************
 * Monitor Board（入口モニター）
 **********************/
function MonitorBoard({dateKey, rooms, reservations}){
  const usedRooms = useMemo(() => {
    const map = {};
    for(const r of rooms) map[r.id] = [];
    for(const e of reservations || []){
      if(!map[e.roomId]) map[e.roomId] = [];
      map[e.roomId].push(e);
    }
    const list = [];
    for(const r of rooms){
      const evts = (map[r.id]||[]).slice().sort((a,b)=>(a.startMin||0)-(b.startMin||0));
      if(evts.length>0) list.push({ room:r, evts });
    }
    return list;
  }, [rooms, reservations]);

  if(usedRooms.length===0){
    return (
      <div className="mt-4 rounded-3xl border border-slate-100 bg-white p-8 text-center">
        <div className="text-2xl font-black text-slate-800">本日は予約がありません</div>
        <div className="mt-2 text-sm font-bold text-slate-400">（表示日：{dateKey}）</div>
      </div>
    );
  }

  return (
    <div className="mt-4 grid lg:grid-cols-3 gap-4">
      {usedRooms.map(({room, evts}) => (
        <div key={room.id} className="rounded-3xl border border-slate-100 bg-white p-5">
          <div className="flex items-end justify-between gap-2 flex-wrap">
            <div>
              <div className="text-xs font-black text-slate-400">{room.building}</div>
              <div className="text-2xl font-black text-slate-800">{room.name}</div>
            </div>
            <Pill tone="slate">{evts.length}件</Pill>
          </div>

          <div className="mt-4 space-y-3">
            {evts.map(r => (
              <div key={r.id} className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
                <div className="text-3xl font-black text-slate-900 tracking-tight">
                  {minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)}
                </div>
                <div className="mt-2 text-xl font-black text-sky-800">{r.groupName}</div>

                <div className="mt-2 flex gap-2 flex-wrap">
                  {(Number(r?.equipment?.projector||0)>0) && <Pill tone="sky">PJ {r.equipment.projector}</Pill>}
                  {(Number(r?.equipment?.pc||0)>0) && <Pill tone="sky">PC {r.equipment.pc}</Pill>}
                  {r.note ? <Pill tone="slate">{r.note}</Pill> : null}
                </div>
              </div>
            ))}
          </div>

          <div className="mt-3 text-xs font-bold text-slate-400">※入口モニターは「使う部屋のみ」表示します</div>
        </div>
      ))}
    </div>
  );
}

/**********************
 * 年間：動静（月） + 日別編集
 **********************/
function PresenceMonthPanel({year, month, presenceMonthMap, onEditDate}){
  const days = useMemo(() => {
    const dt = new Date(year, month-1, 1);
    const list = [];
    while(true){
      list.push(ymdFromDate(dt));
      dt.setDate(dt.getDate()+1);
      if(dt.getMonth() !== (month-1)) break;
    }
    return list;
  }, [year, month]);

  return (
    <div className="rounded-3xl border border-slate-100 bg-white p-4">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-xs font-black text-slate-400">動静（書記長・書記次長）</div>
          <div className="text-lg font-black text-slate-800">{year}年 {month}月</div>
        </div>
        <Pill tone="slate">日別で入力</Pill>
      </div>

      <div className="mt-3 space-y-2 max-h-[60vh] overflow-auto">
        {days.map(dk => {
          const p = presenceMonthMap[dk] || {};
          const chief = p.chief || {};
          const deputy = p.deputy || {};
          const any = (chief.am||chief.pm||chief.eve||deputy.am||deputy.pm||deputy.eve);
          return (
            <div key={dk} className="rounded-3xl bg-slate-50 border border-slate-100 p-3">
              <div className="flex items-center justify-between gap-2 flex-wrap">
                <div className="font-black text-slate-800">{dk}</div>
                <button
                  className="px-3 py-1.5 rounded-2xl bg-white border border-slate-200 font-black text-xs text-slate-700"
                  onClick={()=>onEditDate(dk)}
                  type="button"
                >
                  編集
                </button>
              </div>
              {!any ? (
                <div className="mt-2 text-xs font-bold text-slate-400">—（未入力）</div>
              ) : (
                <div className="mt-2 grid gap-2">
                  <div className="rounded-2xl bg-white border border-slate-100 p-2">
                    <div className="text-xs font-black text-slate-500">書記長</div>
                    <div className="text-xs font-bold text-slate-700">午前：{chief.am||"—"} ／ 午後：{chief.pm||"—"} ／ 夕方：{chief.eve||"—"}</div>
                  </div>
                  <div className="rounded-2xl bg-white border border-slate-100 p-2">
                    <div className="text-xs font-black text-slate-500">書記次長</div>
                    <div className="text-xs font-bold text-slate-700">午前：{deputy.am||"—"} ／ 午後：{deputy.pm||"—"} ／ 夕方：{deputy.eve||"—"}</div>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>

      <div className="mt-2 text-xs font-bold text-slate-400">※月の一覧から、先の予定も入力できます</div>
    </div>
  );
}

function PresenceDayEditor({dateKey, value, onSet, disabled}){
  const v = value || {};
  return (
    <div className="space-y-4">
      <div className="rounded-3xl bg-slate-50 border border-slate-100 p-4">
        <div className="text-xs font-black text-slate-500">対象日</div>
        <div className="text-xl font-black text-slate-800 mt-1">{dateKey}</div>
        <div className="text-xs font-bold text-slate-400 mt-1">午前／午後／夕方 を入力します</div>
      </div>

      <div className="grid md:grid-cols-2 gap-3">
        <PresenceEditor title="書記長" value={v.chief || {}} onSet={(slot,val)=>onSet(dateKey, "chief", slot, val)} disabled={disabled} />
        <PresenceEditor title="書記次長" value={v.deputy || {}} onSet={(slot,val)=>onSet(dateKey, "deputy", slot, val)} disabled={disabled} />
      </div>

      <div className="text-xs font-bold text-slate-400">※入力はワンタップで保存されます</div>
    </div>
  );
}

/**********************
 * 月一覧（任意月）
 **********************/
function MonthListAny({year, month, list, onPickDate}){
  const grouped = useMemo(() => {
    const g = {};
    for(const r of list || []){
      if(!g[r.date]) g[r.date] = [];
      g[r.date].push(r);
    }
    const keys = Object.keys(g).sort();
    return { keys, g };
  }, [list]);

  return (
    <div className="mt-4 rounded-3xl border border-slate-100 bg-white p-4">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-xs font-black text-slate-400">一覧</div>
          <div className="text-lg font-black text-slate-800">{year}年 {month}月</div>
        </div>
        <Pill tone="slate">日付でジャンプ</Pill>
      </div>

      <div className="mt-3 space-y-3 max-h-[70vh] overflow-auto">
        {grouped.keys.length===0 ? (
          <div className="text-sm font-bold text-slate-400 p-3">この月の予約がありません</div>
        ) : grouped.keys.map(date => (
          <div key={date} className="rounded-3xl bg-slate-50 border border-slate-100 p-3">
            <div className="flex items-center justify-between">
              <div className="font-black text-slate-800">{date}</div>
              <button className="px-3 py-1.5 rounded-2xl bg-white border border-slate-200 font-black text-xs text-slate-700" onClick={()=>onPickDate(date)}>
                この日へ
              </button>
            </div>
            <div className="mt-2 space-y-2">
              {(grouped.g[date]||[])
                .sort((a,b)=>(a.startMin||0)-(b.startMin||0))
                .map(r => (
                  <div key={r.id} className="p-3 rounded-2xl bg-white border border-slate-100">
                    <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}–{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                    <div className="text-xs font-bold text-slate-500 mt-1">{roomBuilding(r.roomId)} / {roomName(r.roomId)} {r.note ? `・${r.note}` : ""}</div>
                  </div>
                ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function PresenceEditor({title, value, onSet, disabled}){
      const states = [
        { key:"在館" },
        { key:"外出" },
        { key:"会議" },
        { key:"休" },
      ];
      const slots = [
        { id:"am", label:"午前" },
        { id:"pm", label:"午後" },
        { id:"eve", label:"夕方" },
      ];
      const v = value || {};

      return (
        <div className="rounded-3xl border border-slate-100 bg-white p-4">
          <div className="font-black text-slate-800">{title}</div>
          <div className="mt-3 space-y-3">
            {slots.map(s => (
              <div key={s.id} className="rounded-3xl bg-slate-50 border border-slate-100 p-3">
                <div className="flex items-center justify-between gap-2 flex-wrap">
                  <div className="font-black text-slate-700">{s.label}</div>
                  <Pill tone="slate">現在：{v[s.id] || "—"}</Pill>
                </div>
                <div className="mt-2 flex gap-2 flex-wrap">
                  {states.map(st => (
                    <button
                      key={st.key}
                      disabled={disabled}
                      onClick={()=>onSet(s.id, st.key)}
                      className={classNames(
                        "px-3 py-2 rounded-2xl border font-black shadow-sm",
                        (v[s.id]===st.key)
                          ? "bg-slate-900 text-white border-slate-900"
                          : "bg-white text-slate-700 border-slate-200",
                        disabled ? "opacity-50" : ""
                      )}
                    >
                      {st.key}
                    </button>
                  ))}
                  <button
                    disabled={disabled}
                    onClick={()=>onSet(s.id, "")}
                    className={classNames(
                      "px-3 py-2 rounded-2xl border font-black shadow-sm bg-white text-slate-500 border-slate-200",
                      disabled ? "opacity-50" : ""
                    )}
                    title="未設定に戻す"
                  >
                    クリア
                  </button>
                </div>
              </div>
            ))}
          </div>
          <div className="mt-2 text-xs font-bold text-slate-400">※ワンタップで保存（ログイン時のみ）</div>
        </div>
      );
    }

    /**********************
     * CSV Panels
     **********************/
    function CSVExportPanel({ selectedDate, weekStart, weekEnd, reserveView, fyRange, onExport, busy }){
      const [mode, setMode] = useState(reserveView==="weektime" ? "week" : "day"); // day | week | year | range
      const [start, setStart] = useState(weekStart);
      const [end, setEnd] = useState(weekEnd);

      useEffect(() => {
        if(reserveView==="weektime"){
          setMode("week");
          setStart(weekStart); setEnd(weekEnd);
        }else{
          setMode("day");
          setStart(selectedDate); setEnd(selectedDate);
        }
      }, [reserveView, selectedDate, weekStart, weekEnd]);

      function run(){
        if(mode==="day") onExport(selectedDate, selectedDate);
        else if(mode==="week") onExport(weekStart, weekEnd);
        else if(mode==="year") onExport(fyRange.start, fyRange.end);
        else onExport(start, end);
      }

      return (
        <div className="mt-3 space-y-3">
          <div className="flex gap-2 flex-wrap">
            <button className={classNames("px-4 py-2 rounded-2xl font-black border", mode==="day" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")} onClick={()=>setMode("day")}>
              日（{selectedDate}）
            </button>
            <button className={classNames("px-4 py-2 rounded-2xl font-black border", mode==="week" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")} onClick={()=>setMode("week")}>
              週（{weekStart}〜{weekEnd}）
            </button>
            <button className={classNames("px-4 py-2 rounded-2xl font-black border", mode==="year" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")} onClick={()=>setMode("year")}>
              年間（4〜3）
            </button>
            <button className={classNames("px-4 py-2 rounded-2xl font-black border", mode==="range" ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")} onClick={()=>setMode("range")}>
              範囲指定
            </button>
          </div>

          {mode==="range" ? (
            <div className="grid grid-cols-2 gap-2">
              <div>
                <div className="text-xs font-black text-slate-600 mb-1">開始</div>
                <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold" value={start} onChange={(e)=>setStart(e.target.value)} />
              </div>
              <div>
                <div className="text-xs font-black text-slate-600 mb-1">終了</div>
                <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold" value={end} onChange={(e)=>setEnd(e.target.value)} />
              </div>
            </div>
          ) : null}

          <button
            className={classNames("w-full px-4 py-3 rounded-2xl font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
            onClick={run}
            disabled={busy}
          >
            CSVを書き出す
          </button>
        </div>
      );
    }

    function CSVImportPanel({ disabled, onImport }){
      const fileRef = useRef(null);
      return (
        <div className="mt-3 space-y-3">
          <input ref={fileRef} type="file" accept=".csv,text/csv" className="block w-full text-sm" disabled={disabled} />
          <button
            className={classNames("w-full px-4 py-3 rounded-2xl font-black border shadow-sm",
              disabled ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
            disabled={disabled}
            onClick={()=>{
              const f = fileRef.current?.files?.[0];
              if(!f){ alert("CSVファイルを選択してください"); return; }
              onImport(f);
              fileRef.current.value = "";
            }}
          >
            CSVを取り込む（安全モード）
          </button>
        </div>
      );
    }

    // Render
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);
  </script>
</body>
</html>
